<!DOCTYPE html>
<html lang="it"> <!-- La classe 'dark' verrà aggiunta qui da JS -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Inventario (Firebase)</title>
  
  <!-- 1. Carica Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Stili CSS (invariati) */
    input[type='number']::-webkit-inner-spin-button,
    input[type='number']::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type='number'] {
      -moz-appearance: textfield;
    }
    /* Stili per il toggle scuro */
    .theme-switch-toggle {
      transition: all 0.2s ease-in-out;
    }
    
    /* Stile per il nuovo pulsante Importa */
    .pulse-bg {
      animation: pulse-bg 2s infinite;
    }
    @keyframes pulse-bg {
      0%, 100% {
        background-color: theme('colors.indigo.600');
        box-shadow: 0 0 0 0 theme('colors.indigo.400');
      }
      50% {
        background-color: theme('colors.indigo.700');
        box-shadow: 0 0 0 10px theme('colors.indigo.400 / 0%');
      }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans dark:bg-gray-900">

  <!-- Overlay di caricamento -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center z-[999]">
    <svg class="animate-spin h-10 w-10 text-white mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <span id="loading-text" class="text-white text-lg font-medium">Caricamento dati...</span>
  </div>

  <div class="max-w-7xl mx-auto">
    
    <!-- Intestazione e Navigazione Viste -->
    <header class="mb-6">
      <div class="flex justify-between items-center">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-gray-100">Gestione Inventario</h1>
        <div class="flex items-center space-x-4">
          <!-- Pulsante Home -->
          <button id="btn-go-home" class="hidden text-gray-500 hover:text-blue-600 transition-colors dark:text-gray-400 dark:hover:text-blue-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
            </svg>
          </button>
          
          <!-- Dark Mode Toggle -->
          <label for="theme-toggle" class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="theme-toggle" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-300 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2 text-gray-500 dark:text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" class="hidden dark:block"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" class="block dark:hidden"/>
            </svg>
          </label>
        </div>
      </div>

      <!-- Wrapper per le schede di navigazione -->
      <nav id="main-nav-tabs" class="flex space-x-2 mt-4 hidden">
        <button id="nav-inventario"
          class="px-3 py-2 md:px-4 text-sm md:text-base rounded-lg font-semibold shadow-md transition-all duration-200 bg-blue-600 text-white">
          Inventario
        </button>
        <button id="nav-listaSpesa"
          class="px-3 py-2 md:px-4 text-sm md:text-base rounded-lg font-semibold shadow-md transition-all duration-200 bg-white text-gray-700 dark:bg-gray-700 dark:text-gray-200">
          Lista Spesa
          <span id="shopping-list-badge" class="ml-2 bg-red-500 text-white text-xs font-bold rounded-full px-2 py-1 hidden">
          </span>
        </button>
      </nav>
    </header>

    <!-- Sezione Viste -->
    <main>
      
      <!-- VISTA: Home -->
      <div id="view-home">
        <h2 class="text-2xl font-semibold text-gray-700 mb-6 dark:text-gray-200">Menu Principale</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Bottone Inventario -->
          <button id="btn-go-inventario" class="flex flex-col items-center justify-center bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow text-center dark:bg-gray-800 dark:hover:shadow-lg dark:hover:shadow-gray-700/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-600 dark:text-blue-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
            </svg>
            <span class="text-xl font-semibold text-gray-800 dark:text-gray-100">Inventario</span>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Gestisci e aggiungi prodotti</p>
          </button>
          
          <!-- Bottone Lista Spesa -->
          <button id="btn-go-listaspesa" class="flex flex-col items-center justify-center bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow text-center dark:bg-gray-800 dark:hover:shadow-lg dark:hover:shadow-gray-700/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500 dark:text-red-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span class="text-xl font-semibold text-gray-800 dark:text-gray-100">Lista Spesa</span>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Vedi i prodotti da ordinare</p>
          </button>
          
          <!-- Bottone Report Costi -->
          <button id="btn-go-costi" class="flex flex-col items-center justify-center bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow text-center dark:bg-gray-800 dark:hover:shadow-lg dark:hover:shadow-gray-700/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-600 dark:text-green-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span class="text-xl font-semibold text-gray-800 dark:text-gray-100">Report Costi</span>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Visualizza valore inventario</p>
          </button>
        </div>
        
        <!-- MODIFICA: Pulsante Importazione CSV -->
        <div id="import-container" class="mt-8 hidden">
          <label for="csv-file-input" class="w-full md:w-auto flex items-center justify-center space-x-2 bg-indigo-600 text-white px-6 py-4 rounded-lg shadow-lg hover:bg-indigo-700 transition-all duration-200 font-semibold pulse-bg cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
            <!-- MODIFICA: Testo del pulsante aggiornato -->
            <span>Carica/Aggiorna da CSV</span>
          </label>
          <input type="file" id="csv-file-input" class="hidden" accept=".csv">
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
            Assicurati che il file CSV abbia la prima riga con le intestazioni: <strong>nome</strong>, <strong>categoria</strong>, <strong>fornitore</strong>.
          </p>
        </div>

      </div>
      
      <!-- VISTA: Inventario -->
      <div id="view-inventario" class="hidden">
        <div class="space-y-6">
          
          <!-- Filtri Vista Inventario (NUOVA VERSIONE A TENDINA) -->
          <div class="relative">
            <!-- Pulsante per aprire il menu a tendina -->
            <button id="toggle-filters-btn" class="flex items-center space-x-2 bg-white px-4 py-2 rounded-lg shadow-md font-medium text-gray-700 hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
              </svg>
              <span>Opzioni Vista</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 dark:text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
      
            <!-- Contenitore del menu a tendina -->
            <div id="filters-dropdown" class="absolute top-full left-0 mt-2 bg-white rounded-lg shadow-xl p-4 z-30 hidden w-full md:w-auto dark:bg-gray-800 dark:border dark:border-gray-700">
              <div class="flex flex-col md:flex-row gap-6">
                <!-- Sezione Vista (RIMOSSO BORDO) -->
                <div>
                  <span class="font-medium text-gray-700 block mb-2 dark:text-gray-200">Vista:</span>
                  <div class="flex flex-col sm:flex-row gap-2">
                    <button id="view-compatta" class="px-3 py-1 rounded-md text-sm font-medium bg-blue-500 text-white">
                      Compatta
                    </button>
                    <button id="view-completa" class="px-3 py-1 rounded-md text-sm font-medium bg-white shadow-sm dark:bg-gray-600 dark:text-gray-200">
                      Completa
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>


          <!-- Lista Prodotti Inventario -->
          <div id="inventory-list-container">
            <!-- Contenuto generato da JS -->
          </div>
        </div>
      </div>

      <!-- VISTA: Lista Spesa -->
      <div id="view-listaSpesa" class="hidden">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md dark:bg-gray-800">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100">Lista della Spesa</h2>
            <!-- Pulsante Copia -->
            <button id="copy-shopping-list-btn" class="mt-4 md:mt-0 flex items-center justify-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-200 font-semibold dark:hover:bg-blue-500">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
              <span>Copia Lista per Fornitori</span>
            </button>
          </div>
          <div id="shopping-list-container" class="space-y-8">
            <!-- Contenuto generato da JS -->
          </div>
        </div>
      </div>
      
      <!-- VISTA: Report Costi -->
      <!-- ========================================================== -->
      <!-- ===== CORREZIONE: Questo blocco era stato eliminato ===== -->
      <!-- ========================================================== -->
      <div id="view-costi" class="hidden">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md dark:bg-gray-800">
          <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 dark:text-gray-100">Report Valore Inventario</h2>
          <div id="cost-report-container" class="space-y-8">
            <!-- Contenuto generato da JS -->
          </div>
        </div>
      </div>
      
    </main>

  </div>

  <!-- ================== Modale Form Aggiungi Prodotto ================== -->
  <div id="form-modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-40 hidden">
    
    <!-- Contenuto Modale -->
    <div class="bg-white p-4 md:p-6 rounded-lg shadow-md w-full max-w-4xl relative max-h-[90vh] overflow-y-auto dark:bg-gray-800">
      
      <!-- Pulsante Chiudi Modale -->
      <button id="close-form-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 z-10 dark:hover:text-gray-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <!-- Form Aggiungi Prodotto (spostato qui) -->
      <h2 class="text-xl md:text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Aggiungi Nuovo Prodotto</h2>
      
      <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Colonna 1 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Nome Prodotto</label>
          <input type="text" name="nome" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Categoria</label>
          <input type="text" name="categoria" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <!-- Colonna 2 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Fornitore</label>
          <input type="text" name="fornitore" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <!-- Etichetta Costo (non più required) -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Costo per Unità (€)</label>
          <input type="number" name="costoUnita" min="0" step="0.01" placeholder="0.00" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
        </div>
        <!-- Colonna 3 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Q.tà Attuale</label>
          <input type="number" name="quantitaAttuale" min="0" step="1" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Q.tà Minima</label>
          <input type="number" name="quantitaMinima" min="0" step="1" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <!-- Colonna 4 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Unità</label>
          <select name="unita" class="border rounded-md p-2 w-full bg-white shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
            <option value="kg">kg</option>
            <option value="gr">gr</option>
            <option value="pz" selected>pz</option>
            <option value="ct">ct</option>
          </select>
        </div>
        
        <!-- NUOVO CAMPO: Stato -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Stato</label>
          <select name="status" class="border rounded-md p-2 w-full bg-white shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
            <option value="disponibile" selected>Disponibile</option>
            <option value="non_necessario">Non Necessario</option>
            <option value="aperto">Confezione Aperta</option>
          </select>
        </div>
        
        <!-- MODIFICA: Pulsante spostato su una riga intera -->
        <button type="submit" class="w-full md:col-span-2 lg:col-span-4 bg-blue-600 text-white rounded-md p-2.5 font-semibold shadow-md hover:bg-blue-700 transition-all duration-200 h-full self-end mt-4">
          Aggiungi Prodotto
        </button>
      </form>
    </div>
  </div>

  <!-- Pulsante "+" Fluttuante -->
  <button id="show-add-form-btn" class="fixed bottom-6 right-6 bg-blue-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:bg-blue-700 transition z-50 dark:hover:bg-blue-500">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
    </svg>
  </button>


  <!-- ================== SCRIPT APP (versione FIREBASE) ================== -->
  
  <!-- 1. Importa i moduli di Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, 
      onSnapshot, collection, query, where, getDocs, setLogLevel
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { 
      getAuth, signInAnonymously 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    // --- Passaggio 1: Configurazione Firebase ---
    // QUESTA È LA TUA CONFIGURAZIONE (già inserita)
    const firebaseConfig = {
      apiKey: "AIzaSyDWS8urdhG9RdS62rihj0FBPV38aWUclGQ",
      authDomain: "inventario-a52a4.firebaseapp.com",
      projectId: "inventario-a52a4",
      storageBucket: "inventario-a52a4.firebasestorage.app",
      messagingSenderId: "531426475103",
      appId: "1:531426475103:web:9a3c9b74547fd19a0a6fea",
      measurementId: "G-8HSKSW2Q86"
    };

    // --- Passaggio 2: ID Gruppo Condiviso ---
    const GRUPPO_ID = "inventario-segreto-123";

    // --- STATO LOCALE E COSTANTI ---
    const THEME_KEY = 'inventarioAppTheme';
    const state = {
      currentView: 'home', 
      inventoryViewMode: 'compatta',
      products: [],
      db: null,
      auth: null,
      collectionRef: null 
    };
    
    const unitOptions = ['kg', 'gr', 'pz', 'ct'];
    
    const statusOptions = {
      'disponibile': 'Disponibile',
      'non_necessario': 'Non Necessario',
      'aperto': 'Confezione Aperta'
    };

    // --- SELETTORI DOM ---
    const $ = (selector) => document.querySelector(selector);
    const viewHome = $('#view-home');
    const viewInventario = $('#view-inventario');
    const viewListaSpesa = $('#view-listaSpesa');
    const viewCosti = $('#view-costi');
    const mainNavTabs = $('#main-nav-tabs');
    const btnGoHome = $('#btn-go-home');
    const btnGoInventario = $('#btn-go-inventario');
    const btnGoListaSpesa = $('#btn-go-listaspesa');
    const btnGoCosti = $('#btn-go-costi');
    const navInventario = $('#nav-inventario');
    const navListaSpesa = $('#nav-listaSpesa');
    const viewCompatta = $('#view-compatta');
    const viewCompleta = $('#view-completa');
    const toggleFiltersBtn = $('#toggle-filters-btn');
    const filtersDropdown = $('#filters-dropdown');
    const addProductForm = $('#add-product-form');
    const showAddFormBtn = $('#show-add-form-btn');
    const formModalOverlay = $('#form-modal-overlay');
    const closeFormModalBtn = $('#close-form-modal-btn');
    const inventoryListContainer = $('#inventory-list-container');
    const shoppingListContainer = $('#shopping-list-container');
    const costReportContainer = $('#cost-report-container');
    const shoppingListBadge = $('#shopping-list-badge');
    const copyShoppingListBtn = $('#copy-shopping-list-btn');
    const themeToggle = $('#theme-toggle');
    const loadingOverlay = $('#loading-overlay');
    const loadingText = $('#loading-text');
    
    // MODIFICA: Selettori per Importazione CSV
    const importContainer = $('#import-container');
    const csvFileInput = $('#csv-file-input');

    // --- FUNZIONI DI LOGICA ---

    /** Ritorna solo i prodotti ordinati */
    function getSortedProducts() {
      return [...state.products].sort((a, b) => a.nome.localeCompare(b.nome));
    }

    /** Filtra e raggruppa lista spesa */
    function getShoppingListGrouped() {
      const prodottiDaAcquistare = state.products.filter(
        p => (p.quantitaAttuale <= p.quantitaMinima && p.status === 'disponibile') || p.forceToLista === true
      );
      
      const grouped = prodottiDaAcquistare.reduce((acc, prodotto) => {
        const key = prodotto.fornitore || 'Sconosciuto';
        if (!acc.has(key)) {
          acc.set(key, []);
        }
        acc.get(key).push(prodotto);
        return acc;
      }, new Map());
      
      return new Map([...grouped.entries()].sort((a, b) => a[0].localeCompare(b[0])));
    }

    /** Aggiunge un nuovo prodotto a Firebase */
    async function aggiungiProdotto(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const newProduct = {};
      
      for (let [key, value] of formData.entries()) {
        if (key === 'costoUnita' || key === 'quantitaAttuale' || key === 'quantitaMinima') {
          newProduct[key] = parseFloat(value) || 0; 
        } else {
          newProduct[key] = value;
        }
      }
      
      if (!newProduct.status) {
        newProduct.status = 'disponibile';
      }
      
      newProduct.forceToLista = false;
      
      try {
        await addDoc(state.collectionRef, newProduct);
        e.target.reset();
        formModalOverlay.classList.add('hidden');
      } catch (err) {
        console.error("Errore aggiungendo prodotto: ", err);
        alert("Errore nell'aggiunta del prodotto.");
      }
    }

    /** Rimuove un prodotto da Firebase */
    async function rimuoviProdotto(id) {
      try {
        const docRef = doc(state.db, `inventario/${GRUPPO_ID}/prodotti`, id);
        await deleteDoc(docRef);
      } catch (err) {
        console.error("Errore rimuovendo prodotto: ", err);
        alert("Errore nella rimozione del prodotto.");
      }
    }

    /** Aggiorna un campo del prodotto su Firebase */
    async function updateProductField(id, field, value) {
      const product = state.products.find(p => p.id === id);
      if (!product) return;
      
      let parsedValue = value;
      if (field === 'costoUnita' || field === 'quantitaAttuale' || field === 'quantitaMinima') {
        parsedValue = parseFloat(value) || 0;
      }
      
      if (product[field] === parsedValue) {
        return;
      }

      try {
        const docRef = doc(state.db, `inventario/${GRUPPO_ID}/prodotti`, id);
        await updateDoc(docRef, {
          [field]: parsedValue
        });
      } catch (err) {
        console.error("Errore aggiornando prodotto: ", err);
        alert("Errore nell'aggiornamento del prodotto.");
      }
    }
    
    /** Aggiorna la quantità con +1 o -1 su Firebase */
    async function updateProductQuantity(id, change) {
      const product = state.products.find(p => p.id === id);
      if (!product) return;
      
      let currentQuantity = parseFloat(product.quantitaAttuale) || 0;
      let newQuantity = currentQuantity + change;
      
      if (newQuantity < 0) {
        newQuantity = 0;
      }

      if (product.quantitaAttuale === newQuantity) {
        return;
      }

      try {
        const docRef = doc(state.db, `inventario/${GRUPPO_ID}/prodotti`, id);
        await updateDoc(docRef, {
          quantitaAttuale: newQuantity
        });
      } catch (err) {
        console.error("Errore aggiornando quantità: ", err);
        alert("Errore nell'aggiornamento della quantità.");
      }
    }
    
    /** Aggiunge/Rimuove forzatamente dalla lista */
    async function toggleForzaLista(id) {
      const product = state.products.find(p => p.id === id);
      if (!product) return;
      
      const newState = !(product.forceToLista || false); 
      
      try {
        const docRef = doc(state.db, `inventario/${GRUPPO_ID}/prodotti`, id);
        await updateDoc(docRef, {
          forceToLista: newState
        });
      } catch (err) {
        console.error("Errore aggiornando 'forceToLista': ", err);
        alert("Errore nell'aggiornamento del prodotto.");
      }
    }
    
    /** Copia la lista spesa negli appunti */
    function copiaListaSpesa() {
        const grouped = getShoppingListGrouped();
        if (grouped.size === 0) {
            alert("Lista della spesa vuota!");
            return;
        }
        
        let testoLista = "Lista della Spesa:\n";
        
        for (let [fornitore, prodotti] of grouped) {
            testoLista += `\n--- Fornitore: ${fornitore} ---\n`;
            prodotti.forEach(prodotto => {
                 let nota = '';
                 if (prodotto.forceToLista === true) {
                    nota = ' (Aggiunto Manualmente)';
                 }
                 testoLista += `- ${prodotto.nome} (Att: ${prodotto.quantitaAttuale} / Min: ${prodotto.quantitaMinima}) - ${prodotto.unita}${nota}\n`;
            });
        }

        navigator.clipboard.writeText(testoLista).then(() => {
            const originalText = copyShoppingListBtn.innerHTML;
            copyShoppingListBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
              </svg>
              <span>Copiato!</span>`;
            setTimeout(() => {
                copyShoppingListBtn.innerHTML = originalText;
            }, 2000);
        }).catch(err => {
            console.error('Errore nel copiare la lista: ', err);
            alert("Errore: Impossibile copiare la lista.");
        });
    }

    // --- FUNZIONI DI RENDER ---

    function render() {
      renderNav();
      renderViews();
      if (state.currentView === 'inventario') {
        renderInventoryList();
      }
      if (state.currentView === 'listaSpesa') {
        renderShoppingList();
      }
      if (state.currentView === 'costi') {
        renderCosti();
      }
      renderBadge();
    }

    function renderNav() {
      const isHome = state.currentView === 'home';
      
      mainNavTabs.classList.toggle('hidden', isHome);
      btnGoHome.classList.toggle('hidden', isHome);
      
      showAddFormBtn.classList.toggle('hidden', state.currentView !== 'inventario');

      if (!isHome) {
        if (state.currentView === 'inventario') {
          navInventario.classList.add('bg-blue-600', 'text-white');
          navInventario.classList.remove('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
          navListaSpesa.classList.add('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
          navListaSpesa.classList.remove('bg-blue-600', 'text-white');
        } else { // 'listaSpesa' o 'costi'
          navListaSpesa.classList.add('bg-blue-600', 'text-white');
          navListaSpesa.classList.remove('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
          navInventario.classList.add('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
          navInventario.classList.remove('bg-blue-600', 'text-white');
        }
      }
      
      if (state.inventoryViewMode === 'compatta') {
        viewCompatta.classList.add('bg-blue-500', 'text-white');
        viewCompatta.classList.remove('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        viewCompleta.classList.add('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        viewCompleta.classList.remove('bg-blue-500', 'text-white');
      } else {
        viewCompleta.classList.add('bg-blue-500', 'text-white');
        viewCompleta.classList.remove('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        viewCompatta.classList.add('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        viewCompatta.classList.remove('bg-blue-500', 'text-white');
      }
    }

    function renderViews() {
      viewHome.classList.toggle('hidden', state.currentView !== 'home');
      viewInventario.classList.toggle('hidden', state.currentView !== 'inventario');
      viewListaSpesa.classList.toggle('hidden', state.currentView !== 'listaSpesa');
      viewCosti.classList.toggle('hidden', state.currentView !== 'costi');
    }

    /** Helper per le opzioni Unità */
    function getUnitOptionsHTML(selectedValue) {
      return unitOptions.map(unita => 
        `<option value="${unita}" ${unita === selectedValue ? 'selected' : ''}>${unita}</option>`
      ).join('');
    }
    
    /** Helper per le opzioni Stato */
    function getStatusOptionsHTML(selectedValue) {
      const value = selectedValue || 'disponibile';
      return Object.entries(statusOptions).map(([key, label]) =>
        `<option value="${key}" ${key === value ? 'selected' : ''}>${label}</option>`
      ).join('');
    }
    
    /** Helper per il badge Stato */
    function getStatusBadge(status) {
      switch (status) {
        case 'aperto':
          return `<span class="flex-shrink-0 text-xs font-medium bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full dark:bg-yellow-900 dark:text-yellow-300">Aperto</span>`;
        case 'non_necessario':
          return `<span class="flex-shrink-0 text-xs font-medium bg-gray-100 text-gray-800 px-2 py-0.5 rounded-full dark:bg-gray-700 dark:text-gray-300">Non Necessario</span>`;
        case 'disponibile':
        default:
          return ''; // Nessun badge per lo stato di default
      }
    }
    
    /** Helper per il pulsante "Aggiungi a Lista" */
    function createForceListButton(prodotto) {
      const isOnAutoList = prodotto.quantitaAttuale <= prodotto.quantitaMinima && prodotto.status === 'disponibile';
      
      const iconCartPlus = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>`;
      const iconCartMinus = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9" /></svg>`;
      const iconCheck = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;

      if (isOnAutoList) {
        return `<button title="Già in lista (automatico)" class="p-2 rounded-md bg-gray-200 text-gray-500 cursor-default dark:bg-gray-600 dark:text-gray-400" disabled>${iconCheck}</button>`;
      }
      
      if (prodotto.forceToLista) {
        // È stato forzato, mostra "Rimuovi"
        return `<button title="Rimuovi da lista" data-id="${prodotto.id}" class="force-lista-btn p-2 rounded-md bg-yellow-400 text-yellow-900 hover:bg-yellow-500 transition-colors">${iconCartMinus}</button>`;
      }
      
      // Non è in lista, mostra "Aggiungi"
      return `<button title="Aggiungi a lista" data-id="${prodotto.id}" class="force-lista-btn p-2 rounded-md bg-green-500 text-white hover:bg-green-600 transition-colors">${iconCartPlus}</button>`;
    }


    /** Render inventario */
    function renderInventoryList() {
      const prodotti = getSortedProducts();
      
      if (state.products.length === 0) {
        inventoryListContainer.innerHTML = `<div class="bg-white p-6 rounded-lg shadow text-center text-gray-500 dark:bg-gray-800 dark:text-gray-400">
          Nessun prodotto nell'inventario. Inizia aggiungendone uno!
        </div>`;
        return;
      }
      
      let html = `
          <div class="grid grid-cols-1 ${state.inventoryViewMode === 'completa' ? 'xl:grid-cols-2' : ''} gap-4">
            ${prodotti.map(prodotto => {
              const borderClass = prodotto.quantitaAttuale <= prodotto.quantitaMinima ? 'border-l-4 border-red-500' : 'border-transparent dark:border-transparent';
              const qtyClass = prodotto.quantitaAttuale <= prodotto.quantitaMinima ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400';
              
              const cardTop = `
                <div class="flex justify-between items-start mb-3">
                  <div class="flex items-center gap-2 w-2/3">
                    <input type="text" value="${prodotto.nome}" data-id="${prodotto.id}" data-field="nome"
                      class="editable-input text-lg md:text-xl font-bold text-blue-800 border-b-2 border-transparent focus:border-blue-300 outline-none w-full dark:text-blue-400 dark:bg-transparent dark:focus:border-blue-500">
                    ${getStatusBadge(prodotto.status)}
                  </div>
                  <div class="flex-shrink-0 ml-2 flex items-center space-x-2">
                    ${createForceListButton(prodotto)}
                    <button class="remove-btn text-red-500 hover:text-red-700 p-2 rounded-md dark:hover:text-red-400" data-id="${prodotto.id}" title="Rimuovi prodotto">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                  </div>
                </div>`;
                
              let cardBottom = '';
              
              if (state.inventoryViewMode === 'compatta') {
                cardBottom = `
                  <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mt-2 text-sm text-gray-600 dark:text-gray-400">
                    <div class="flex items-center space-x-2">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Q.tà:</label>
                      <button data-id="${prodotto.id}" class="qty-decrease bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 rounded-full w-6 h-6 flex items-center justify-center text-lg font-bold text-gray-700 dark:text-gray-200 hover:bg-gray-300 transition-colors">-</button>
                      <input type="number" value="${prodotto.quantitaAttuale}" data-id="${prodotto.id}" data-field="quantitaAttuale"
                        class="editable-input w-20 border rounded-md p-1 text-center font-medium ${qtyClass} dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                      <button data-id="${prodotto.id}" class="qty-increase bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 rounded-full w-6 h-6 flex items-center justify-center text-lg font-bold text-gray-700 dark:text-gray-200 hover:bg-gray-300 transition-colors">+</button>
                    </div>
                    <div class="flex items-center space-x-1">
                       <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Unità:</label>
                       <span class="font-medium dark:text-gray-300">${prodotto.unita}</span>
                    </div>
                    <div class="flex items-center space-x-1">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Min:</label>
                      <span class="font-medium dark:text-gray-300">${prodotto.quantitaMinima}</span>
                    </div>
                  </div>`;
              } else {
                cardBottom = `
                  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-3 text-sm text-gray-600 dark:text-gray-400">
                    
                    <!-- Categoria (RE-INSERITA) -->
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Categoria</label>
                      <input type="text" value="${prodotto.categoria}" data-id="${prodotto.id}" data-field="categoria"
                        class="editable-input border-b border-transparent focus:border-gray-300 outline-none w-full dark:bg-transparent dark:focus:border-gray-500 dark:text-gray-100">
                    </div>
                    
                    <!-- Costo/Unità -->
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Costo/Unità</label>
                      <div class="flex items-center">
                        <span class="mr-1 dark:text-gray-400">€</span>
                        <input type="number" value="${prodotto.costoUnita || 0}" data-id="${prodotto.id}" data-field="costoUnita"
                          class="editable-input w-20 border-b border-transparent focus:border-gray-300 outline-none dark:bg-transparent dark:focus:border-gray-500 dark:text-gray-100">
                      </div>
                    </div>
                    <!-- Q.tà Attuale -->
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Q.tà Attuale</label>
                      <input type="number" value="${prodotto.quantitaAttuale}" data-id="${prodotto.id}" data-field="quantitaAttuale"
                        class="editable-input w-16 border-b border-transparent focus:border-gray-300 outline-none font-medium ${qtyClass} dark:bg-transparent dark:focus:border-gray-500">
                    </div>
                    <!-- Q.tà Minima -->
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Q.tà Minima</label>
                      <input type="number" value="${prodotto.quantitaMinima}" data-id="${prodotto.id}" data-field="quantitaMinima"
                        class="editable-input w-16 border-b border-transparent focus:border-gray-300 outline-none dark:bg-transparent dark:focus:border-gray-500 dark:text-gray-100">
                    </div>
                    <!-- Unità -->
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Unità</label>
                      <select data-id="${prodotto.id}" data-field="unita"
                        class="editable-input w-20 border-b bg-white border-transparent focus:border-gray-300 outline-none dark:bg-gray-800 dark:text-gray-100 dark:focus:border-gray-500">
                        ${getUnitOptionsHTML(prodotto.unita)}
                      </select>
                    </div>
                    <!-- Stato -->
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Stato</label>
                      <select data-id="${prodotto.id}" data-field="status"
                        class="editable-input w-full border-b bg-white border-transparent focus:border-gray-300 outline-none dark:bg-gray-800 dark:text-gray-100 dark:focus:border-gray-500">
                        ${getStatusOptionsHTML(prodotto.status)}
                      </select>
                    </div>
                  </div>`;
              }
              
              return `<div class="bg-white shadow-lg rounded-lg p-4 transition-all duration-300 ${borderClass} dark:bg-gray-800 dark:shadow-none">
                ${cardTop}
                ${cardBottom}
              </div>`;
              
            }).join('')}
          </div>`;
      inventoryListContainer.innerHTML = html;
    }

    /** Render lista spesa */
    function renderShoppingList() {
      const grouped = getShoppingListGrouped();
      if (grouped.size === 0) {
        shoppingListContainer.innerHTML = `<div class="text-center text-gray-500 py-10 dark:text-gray-400">
          <p class="text-lg">La tua lista della spesa è vuota!</p>
          <p class="text-sm md:text-base">I prodotti appariranno qui automaticamente (se sotto il minimo) o se li aggiungi tu manually.</p>
        </div>`;
        copyShoppingListBtn.disabled = true;
        copyShoppingListBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        let html = '';
        for (let [groupKey, prodotti] of grouped) {
          html += `<section>
            <h3 class="text-xl md:text-2xl font-semibold text-blue-700 mb-3 border-b border-blue-200 pb-2 dark:text-blue-400 dark:border-blue-700">
              Fornitore: <span class="font-bold">${groupKey}</span>
            </h3>
            <ul class="list-disc list-inside pl-2 md:pl-4 space-y-2">
              ${prodotti.map(prodotto => `
                <li class="text-gray-800 text-base md:text-lg dark:text-gray-200">
                  <span class="font-semibold">${prodotto.nome}</span>
                  <span class="block text-sm text-gray-600 ml-6 md:ml-2 md:inline dark:text-gray-400">
                    (Attuale: <strong class="${prodotto.quantitaAttuale <= prodotto.quantitaMinima ? 'text-red-600 dark:text-red-400' : 'text-gray-600 dark:text-gray-400'}">${prodotto.quantitaAttuale}</strong> / Min: ${prodotto.quantitaMinima}) - ${prodotto.unita}
                    ${prodotto.forceToLista ? '<span class="text-xs font-medium bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full dark:bg-yellow-900 dark:text-yellow-300 ml-2">Manuale</span>' : ''}
                  </span>
                </li>
              `).join('')}
            </ul>
          </section>`;
        }
        shoppingListContainer.innerHTML = html;
        copyShoppingListBtn.disabled = false;
        copyShoppingListBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }
    
    /** Render per la pagina Costi */
    function renderCosti() {
      if (state.products.length === 0) {
        costReportContainer.innerHTML = `<div class="text-center text-gray-500 py-10 dark:text-gray-400">
          <p class="text-lg">Nessun prodotto nell'inventario.</p>
          <p class="text-sm md:text-base">Aggiungi prodotti e imposta il loro "Costo per Unità" per vedere il report.</p>
        </div>`;
        return;
      }
      
      const groupedByCategoria = state.products.reduce((acc, prodotto) => {
        const key = prodotto.categoria || 'Non Assegnato';
        if (!acc.has(key)) {
          acc.set(key, []);
        }
        acc.get(key).push(prodotto);
        return acc;
      }, new Map());
      
      const sortedGroups = new Map([...groupedByCategoria.entries()].sort((a, b) => a[0].localeCompare(b[0])));

      let html = '';
      let costoTotaleInventario = 0;

      for (let [categoria, prodotti] of sortedGroups) {
        let costoCategoria = 0;
        
        const prodottiHtml = prodotti.map(prodotto => {
          const costoProdotto = (prodotto.costoUnita || 0) * (prodotto.quantitaAttuale || 0);
          costoCategoria += costoProdotto;
          
          return `<li class="flex justify-between items-center text-gray-700 text-sm md:text-base py-1 dark:text-gray-300">
            <span>
              <span class="font-medium">${prodotto.nome}</span>
              <span class="text-gray-500 text-xs md:text-sm ml-2 dark:text-gray-400">(${prodotto.quantitaAttuale} ${prodotto.unita} × ${formatCurrency(prodotto.costoUnita)})</span>
            </span>
            <span class="font-semibold">${formatCurrency(costoProdotto)}</span>
          </li>`;
        }).join('');
        
        html += `<section>
          <h3 class="text-xl md:text-2xl font-semibold text-blue-700 mb-3 border-b border-blue-200 pb-2 capitalize dark:text-blue-400 dark:border-blue-700">
            ${categoria}
          </h3>
          <ul class="divide-y divide-gray-200 dark:divide-gray-700 mb-3">
            ${prodottiHtml}
          </ul>
          <div class="text-right font-bold text-gray-800 text-lg border-t border-gray-300 pt-2 dark:text-gray-100 dark:border-gray-600">
            Totale Categoria: ${formatCurrency(costoCategoria)}
          </div>
        </section>`;
        
        costoTotaleInventario += costoCategoria;
      }
      
      const totalHtml = `
        <div class="bg-gray-200 p-4 rounded-lg mb-8 dark:bg-gray-700">
          <h2 class="text-xl md:text-2xl font-bold text-gray-900 text-center dark:text-gray-100">
            Valore Totale Inventario:
            <span class="text-green-700 dark:text-green-400">${formatCurrency(costoTotaleInventario)}</span>
          </h2>
        </div>
      `;
      
      costReportContainer.innerHTML = totalHtml + html;
    }
    
    /** Formatta valuta */
    function formatCurrency(value) {
      return (value || 0).toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
    }
    
    /** Render badge notifiche */
    function renderBadge() {
        const grouped = getShoppingListGrouped();
        const totalItems = Array.from(grouped.values()).reduce((acc, prodotti) => acc + prodotti.length, 0);
        
        if (totalItems > 0) {
            shoppingListBadge.textContent = totalItems;
            shoppingListBadge.classList.remove('hidden');
        } else {
            shoppingListBadge.classList.add('hidden');
        }
    }
    
    // --- FUNZIONI DARK MODE ---
    function applyTheme(theme) {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            localStorage.setItem(THEME_KEY, 'dark');
            themeToggle.checked = true;
        } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem(THEME_KEY, 'light');
            themeToggle.checked = false;
        }
    }
    
    function initTheme() {
        const savedTheme = localStorage.getItem(THEME_KEY);
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark') {
            applyTheme('dark');
        } else if (savedTheme === 'light') {
            applyTheme('light');
        } else if (prefersDark) {
            applyTheme('dark'); 
        } else {
            applyTheme('light'); 
        }
    }

    // --- EVENT LISTENERS ---

    btnGoHome.addEventListener('click', () => {
      state.currentView = 'home';
      render();
    });
    btnGoInventario.addEventListener('click', () => {
      state.currentView = 'inventario';
      render();
    });
    btnGoListaSpesa.addEventListener('click', () => {
      state.currentView = 'listaSpesa';
      render();
    });
    btnGoCosti.addEventListener('click', () => {
      state.currentView = 'costi';
      render();
    });
    navInventario.addEventListener('click', () => {
      state.currentView = 'inventario';
      render();
    });
    navListaSpesa.addEventListener('click', () => {
      state.currentView = 'listaSpesa';
      render();
    });
    
    copyShoppingListBtn.addEventListener('click', copiaListaSpesa);

    filtersDropdown.addEventListener('click', (e) => {
        let changed = false;
        if (e.target.id === 'view-compatta') {
            state.inventoryViewMode = 'compatta';
            changed = true;
        }
        if (e.target.id === 'view-completa') {
            state.inventoryViewMode = 'completa';
            changed = true;
        }
        
        if(changed) {
            render();
            filtersDropdown.classList.add('hidden');
        }
    });

    addProductForm.addEventListener('submit', aggiungiProdotto);

    document.body.addEventListener('click', (e) => {
      const forceButton = e.target.closest('.force-lista-btn');
      if (forceButton) {
        const id = forceButton.dataset.id;
        toggleForzaLista(id);
        return;
      }
      
      const removeButton = e.target.closest('.remove-btn');
      if (removeButton) {
        const id = removeButton.dataset.id;
        if (confirm("Sei sicuro di voler eliminare questo prodotto?")) {
          rimuoviProdotto(id);
        }
        return; 
      }
      
      const increaseButton = e.target.closest('.qty-increase');
      if (increaseButton) {
        const id = increaseButton.dataset.id;
        updateProductQuantity(id, 1);
        return;
      }
      
      const decreaseButton = e.target.closest('.qty-decrease');
      if (decreaseButton) {
        const id = decreaseButton.dataset.id;
        updateProductQuantity(id, -1);
        return;
      }
      
      if (!filtersDropdown.classList.contains('hidden') && !toggleFiltersBtn.contains(e.target) && !filtersDropdown.contains(e.target)) {
        filtersDropdown.classList.add('hidden');
      }
    });
    
    document.body.addEventListener('focusout', (e) => {
        if (e.target.classList.contains('editable-input')) {
            const { id, field } = e.target.dataset;
            updateProductField(id, field, e.target.value);
        }
    });

    showAddFormBtn.addEventListener('click', () => {
      formModalOverlay.classList.remove('hidden');
    });
    closeFormModalBtn.addEventListener('click', () => {
      formModalOverlay.classList.add('hidden');
    });
    formModalOverlay.addEventListener('click', (e) => {
      if (e.target === formModalOverlay) {
        formModalOverlay.classList.add('hidden');
      }
    });
    toggleFiltersBtn.addEventListener('click', (e) => {
      e.stopPropagation(); 
      filtersDropdown.classList.toggle('hidden');
    });
    
    themeToggle.addEventListener('change', (e) => {
        if (e.target.checked) {
            applyTheme('dark');
        } else {
            applyTheme('light');
        }
    });

    // --- NUOVE FUNZIONI DI IMPORTAZIONE CSV ---
    
    /**
     * Gestisce il caricamento del file CSV
     */
    async function handleCsvUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      loadingOverlay.classList.remove('hidden');
      loadingText.textContent = 'Lettura file CSV...';

      try {
        const fileContent = await file.text();
        const prodottiDaImportare = parseCSV(fileContent);
        
        if (prodottiDaImportare.length === 0) {
           alert("Nessun prodotto valido trovato nel CSV.");
           loadingOverlay.classList.add('hidden');
           return;
        }

        if (!confirm(`Trovati ${prodottiDaImportare.length} prodotti. Vuoi importarli ora? L'operazione controllerà i duplicati.`)) {
           loadingOverlay.classList.add('hidden');
           csvFileInput.value = ''; // Resetta l'input
           return;
        }
        
        await importaProdottiDaCsv(prodottiDaImportare);

      } catch (err) {
        console.error("Errore during CSV import:", err);
        alert("ERRORE: " + err.message);
        loadingOverlay.classList.add('hidden');
      } finally {
        csvFileInput.value = ''; // Resetta l'input file in ogni caso
      }
    }
    
    /**
     * Esegue il parsing del testo CSV e lo trasforma in un array di oggetti
     */
    function parseCSV(csvText) {
      const righe = csvText.split('\n').filter(Boolean); // Divide per riga e rimuove righe vuote
      if (righe.length <= 1) throw new Error("Il file CSV è vuoto o contiene solo l'intestazione.");

      // Pulisce e mappa le intestazioni (la prima riga)
      const intestazione = righe[0].split(',').map(h => h.trim().toLowerCase());
      
      const nomeIndex = intestazione.indexOf('nome');
      const categoriaIndex = intestazione.indexOf('categoria');
      const fornitoreIndex = intestazione.indexOf('fornitore');

      if (nomeIndex === -1 || categoriaIndex === -1 || fornitoreIndex === -1) {
        throw new Error("Intestazioni CSV non valide. Assicurati che la prima riga del file contenga 'nome', 'categoria' e 'fornitore'.");
      }

      const prodotti = [];
      for (let i = 1; i < righe.length; i++) {
        const campi = righe[i].split(',');
        
        // Pulisce i campi da eventuali spazi bianchi
        const nome = campi[nomeIndex]?.trim();
        const categoria = campi[categoriaIndex]?.trim();
        const fornitore = campi[fornitoreIndex]?.trim();

        if (nome && categoria && fornitore) {
          prodotti.push({ nome, categoria, fornitore });
        }
      }
      return prodotti;
    }

    /**
     * Esegue il loop di caricamento su Firebase
     */
    async function importaProdottiDaCsv(prodottiDaImportare) {
      loadingText.textContent = `Controllo ${prodottiDaImportare.length} prodotti...`;
      
      // 1. Crea un Set dei nomi dei prodotti ESISTENTI per un controllo rapido
      // Si usa toLowerCase() e trim() per un confronto più robusto
      const existingProductNames = new Set(
        state.products.map(p => p.nome.toLowerCase().trim())
      );

      let prodottiAggiunti = 0;
      let prodottiSaltati = 0;

      for (const item of prodottiDaImportare) {
        // Pulisce i campi prima del controllo
        const nomeProdottoCsv = item.nome ? item.nome.toLowerCase().trim() : '';
        const categoriaCsv = item.categoria ? item.categoria.trim() : 'Sconosciuto';
        const fornitoreCsv = item.fornitore ? item.fornitore.trim() : 'Sconosciuto';
        
        if (!nomeProdottoCsv) {
          console.log("Prodotto saltato (nome vuoto):", item);
          continue; // Salta righe senza nome
        }

        // 2. Controlla se il prodotto esiste GIÀ
        if (existingProductNames.has(nomeProdottoCsv)) {
          prodottiSaltati++;
          // Opzionale: log in console per il debug
          // console.log(`Prodotto saltato (duplicato): ${item.nome}`);
        } else {
          // 3. Se NON esiste, è un nuovo prodotto. Lo aggiungiamo.
          const prodottoCompleto = {
            nome: item.nome.trim(), // Salva il nome originale, non in minuscolo
            categoria: categoriaCsv,
            fornitore: fornitoreCsv,
            costoUnita: 0,
            quantitaAttuale: 0,
            quantitaMinima: 1, // Default
            unita: 'pz', // Default
            status: 'disponibile', // Default
            forceToLista: false
          };
          
          try {
            await addDoc(state.collectionRef, prodottoCompleto);
            prodottiAggiunti++;
            // Aggiungilo al Set per evitare doppi nel *medesimo file CSV*
            existingProductNames.add(nomeProdottoCsv); 
          } catch (err) {
            console.error("Errore importando prodotto: ", item.nome, err);
          }
        }
        
        // Aggiorna il testo del caricamento
        loadingText.textContent = `Aggiunti: ${prodottiAggiunti} / Saltati: ${prodottiSaltati}`;
      }
      
      // 4. Report finale
      loadingText.textContent = `Importazione completata!`;
      alert(`Importazione completata!\n\nProdotti nuovi aggiunti: ${prodottiAggiunti}\nProdotti duplicati saltati: ${prodottiSaltati}`);
      
      setTimeout(() => {
        loadingOverlay.classList.add('hidden');
        loadingText.textContent = 'Caricamento dati...'; // Resetta per il futuro
      }, 2500);
    }
    
    // MODIFICA: Aggiungi listener per il nuovo input file
    csvFileInput.addEventListener('change', handleCsvUpload);


    // --- INIZIALIZZAZIONE FIREBASE ---
    
    async function initApp() {
      initTheme(); // Inizializza il tema subito

      try {
        const app = initializeApp(firebaseConfig);
        state.db = getFirestore(app);
        state.auth = getAuth(app);
        
        state.collectionRef = collection(state.db, `inventario/${GRUPPO_ID}/prodotti`);

        await signInAnonymously(state.auth);
        
        onSnapshot(state.collectionRef, (snapshot) => {
          state.products = [];
          snapshot.forEach((doc) => {
            state.products.push({ id: doc.id, ...doc.data() });
          });
          
          if (!loadingOverlay.classList.contains('hidden')) {
             loadingText.textContent = 'Caricamento dati...'; // Resetta il testo
             loadingOverlay.classList.add('hidden');
          }
          
          // MODIFICA: Il pulsante di importazione CSV è sempre visibile
          importContainer.classList.remove('hidden');
          
          render(); // Ridisegna tutto con i nuovi dati
        }, (error) => {
          console.error("Errore onSnapshot: ", error);
          loadingOverlay.innerHTML = `<span class="text-red-400 text-lg font-medium p-4 text-center">Errore di caricamento dati.<br>Controlla le Regole di Sicurezza di Firebase.</span>`;
        });

      } catch (err) {
        console.error("Errore inizializzazione Firebase: ", err);
        
        if (err.code === 'auth/configuration-not-found') {
           loadingOverlay.innerHTML = `<span class="text-red-400 text-lg font-medium p-4 text-center">
            <strong>ERRORE: Autenticazione Anonima NON ABILITATA.</strong><br><br>
            Azione richiesta:<br>
            1. Vai alla tua Console Firebase<br>
            2. Clicca su "Authentication"<br>
            3. Vai alla scheda "Sign-in method"<br>
            4. Clicca su "Anonimo" e Abilitalo.
           </span>`;
        } else {
           loadingOverlay.innerHTML = `<span class="text-red-400 text-lg font-medium p-4 text-center">Errore di connessione.<br>Controlla la configurazione di Firebase e le Regole di Sicurezza.</span>`;
        }
      }
    }
    
    // Avvia l'app
    initApp();

  </script>
</body>
</html>

