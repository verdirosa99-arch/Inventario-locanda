<!DOCTYPE html>
<html lang="it" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kitchen OS - Food Cost & Inventario</title>

  <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96">
  <link rel="shortcut icon" href="favicon.ico">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            slate: { 850: '#151f2e', 900: '#0f172a' }, // Sfondo scuro professionale
            amber: { 500: '#f59e0b', 600: '#d97706' }, // Colore accento (Gold)
          }
        }
      }
    }
  </script>

  <style>
    /* Rimozione frecce input number */
    input[type='number']::-webkit-inner-spin-button,
    input[type='number']::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type='number'] { -moz-appearance: textfield; }
    
    /* Scrollbar personalizzata */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
  </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen font-sans selection:bg-amber-500 selection:text-white">

  <div id="loading-overlay" class="fixed inset-0 bg-slate-900/90 flex flex-col items-center justify-center z-[999] backdrop-blur-sm">
    <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-amber-500 border-solid mb-4"></div>
    <span class="text-amber-500 text-lg font-bold tracking-widest">KITCHEN OS</span>
  </div>

  <div id="custom-alert" class="fixed top-5 right-5 z-[1000] p-4 rounded-lg shadow-2xl max-w-sm hidden border-l-4 transform transition-all duration-300">
    <div class="flex items-start">
      <div id="custom-alert-icon" class="flex-shrink-0 mr-3"></div>
      <div class="flex-1">
        <p id="custom-alert-title" class="font-bold text-sm uppercase tracking-wider"></p>
        <p id="custom-alert-message" class="mt-1 text-sm text-slate-300"></p>
      </div>
      <button id="custom-alert-close-btn" class="ml-4 text-slate-400 hover:text-white">✕</button>
    </div>
  </div>

  <div class="max-w-7xl mx-auto p-4 md:p-6 pb-24">
    
    <header class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-slate-700 pb-4">
      <div class="flex items-center gap-3 mb-4 md:mb-0">
        <div class="bg-amber-500 text-slate-900 p-2 rounded-lg font-bold text-xl">OS</div>
        <h1 class="text-2xl md:text-3xl font-bold text-slate-100 tracking-tight">Kitchen Management</h1>
      </div>
      
      <nav class="flex bg-slate-800 p-1 rounded-xl shadow-lg">
        <button id="nav-inventario" class="nav-btn px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 bg-amber-500 text-slate-900 shadow">
          Inventario Check
        </button>
        <button id="nav-foodcost" class="nav-btn px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 text-slate-400 hover:text-white hover:bg-slate-700">
          Calcolo Food Cost
        </button>
        <button id="nav-cantina" class="nav-btn px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 text-slate-400 hover:text-white hover:bg-slate-700">
          Cantina Vini
        </button>
      </nav>
    </header>

    <main>
      
      <div id="view-inventario">
        
        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <div class="relative flex-1">
            <input type="text" id="search-bar" placeholder="Cerca ingrediente..." 
              class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-3 pl-10 rounded-xl focus:outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition-colors shadow-inner">
            <svg class="w-5 h-5 text-slate-500 absolute top-3.5 left-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
          
          <div class="flex gap-2">
            <div class="bg-slate-800 border border-slate-700 px-4 py-2 rounded-xl flex flex-col justify-center min-w-[120px]">
              <span class="text-xs text-slate-400 uppercase font-bold">Valore Magazzino</span>
              <span id="inventory-total-value" class="text-lg font-bold text-emerald-400">€ 0,00</span>
            </div>
          </div>
        </div>

        <div id="inventory-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          </div>
         <p id="no-products-message" class="text-center text-slate-500 py-10 hidden">Nessun prodotto. Usa il tasto + per aggiungere.</p>
      </div>


      <div id="view-foodcost" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          
          <div class="lg:col-span-2 space-y-6">
            <div class="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700">
              <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                Componi Piatto (Ricetta)
              </h2>
              
              <div class="flex flex-col sm:flex-row gap-3 mb-6 p-4 bg-slate-700/50 rounded-xl">
                <select id="fc-select-product" class="flex-1 bg-slate-900 border border-slate-600 text-white rounded-lg p-2.5 focus:border-amber-500 focus:outline-none">
                  <option value="">Seleziona ingrediente dall'inventario...</option>
                  </select>
                <input type="number" id="fc-input-qty" placeholder="Q.tà usata" class="w-full sm:w-32 bg-slate-900 border border-slate-600 text-white rounded-lg p-2.5 focus:border-amber-500 focus:outline-none">
                <button id="fc-add-btn" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                  Aggiungi
                </button>
              </div>

              <div class="overflow-x-auto rounded-lg border border-slate-700">
                <table class="w-full text-left text-slate-300">
                  <thead class="bg-slate-900 text-slate-400 text-xs uppercase">
                    <tr>
                      <th class="px-4 py-3">Ingrediente</th>
                      <th class="px-4 py-3 text-right">Q.tà</th>
                      <th class="px-4 py-3 text-right">Costo</th>
                      <th class="px-4 py-3 text-center">Azioni</th>
                    </tr>
                  </thead>
                  <tbody id="fc-recipe-body" class="divide-y divide-slate-700 bg-slate-800">
                    </tbody>
                </table>
              </div>
              <p id="fc-empty-msg" class="text-center text-slate-500 py-4 italic">Aggiungi ingredienti per calcolare il costo.</p>
            </div>
          </div>

          <div class="space-y-6">
            <div class="bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700 sticky top-6">
              <h3 class="text-lg font-bold text-slate-100 mb-4 border-b border-slate-700 pb-2">Analisi Costi</h3>
              
              <div class="space-y-4">
                <div class="flex justify-between items-center">
                  <span class="text-slate-400">Costo Materie Prime:</span>
                  <span id="fc-total-cost" class="text-2xl font-bold text-emerald-400">€ 0,00</span>
                </div>
                
                <div class="pt-4 border-t border-slate-700">
                  <label class="block text-sm font-medium text-slate-300 mb-1">Prezzo di Vendita (Proposto)</label>
                  <div class="relative">
                    <span class="absolute left-3 top-2.5 text-slate-500">€</span>
                    <input type="number" id="fc-sell-price" class="w-full bg-slate-900 border border-slate-600 text-white pl-8 pr-4 py-2 rounded-lg focus:border-amber-500 focus:outline-none font-bold text-lg" placeholder="0.00">
                  </div>
                </div>

                <div class="bg-slate-700/50 p-4 rounded-xl mt-4">
                  <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-bold text-slate-200">FOOD COST %</span>
                    <span id="fc-percent" class="text-xl font-black text-slate-100">0%</span>
                  </div>
                  <div class="w-full bg-slate-600 rounded-full h-2.5">
                    <div id="fc-percent-bar" class="bg-emerald-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                  </div>
                  <p id="fc-status-text" class="text-xs text-right mt-1 text-slate-400">Inserisci prezzo vendita</p>
                </div>
                
                <div class="pt-4 border-t border-slate-700 flex justify-between items-center">
                   <span class="text-slate-400">Margine Lordo:</span>
                   <span id="fc-margin" class="font-bold text-white">€ 0,00</span>
                </div>

                <button id="fc-reset-btn" class="w-full mt-4 border border-slate-600 text-slate-300 hover:bg-slate-700 hover:text-white py-2 rounded-lg text-sm transition-colors">
                  Resetta Calcolo
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>


      <div id="view-cantina" class="hidden">
        <div class="flex flex-col md:flex-row gap-4 mb-6">
           <div class="relative flex-1">
            <input type="text" id="search-bar-vini" placeholder="Cerca vino, cantina, anno..." 
              class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-3 pl-10 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 shadow-inner">
            <svg class="w-5 h-5 text-slate-500 absolute top-3.5 left-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
          <button id="btn-report-vini-pdf" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl font-bold shadow transition-colors flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            PDF Report
          </button>
        </div>

        <div id="wine-list-container" class="space-y-4">
          </div>
        <p id="no-wines-message" class="text-center text-slate-500 py-10 hidden">Cantina vuota.</p>
      </div>

    </main>
  </div>

  <button id="fab-add-btn" class="fixed bottom-8 right-8 bg-amber-500 hover:bg-amber-600 text-slate-900 p-4 rounded-full shadow-2xl transition-transform hover:scale-110 z-30">
    <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
    </svg>
  </button>

  <div id="modal-product" class="fixed inset-0 bg-slate-900/95 flex items-center justify-center p-4 z-40 hidden backdrop-blur-sm">
    <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg border border-slate-700">
      <div class="p-6 border-b border-slate-700 flex justify-between items-center">
        <h2 class="text-xl font-bold text-white">Nuovo Articolo</h2>
        <button id="close-modal-product" class="text-slate-400 hover:text-white">✕</button>
      </div>
      <form id="form-product" class="p-6 space-y-4">
        
        <div>
          <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nome Prodotto</label>
          <input type="text" id="inp-nome" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-amber-500 focus:outline-none" required placeholder="Es. Pomodori Pelati">
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Fornitore</label>
            <input type="text" id="inp-fornitore" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-amber-500 focus:outline-none" placeholder="Es. Metro">
          </div>
          <div>
            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Unità di Misura</label>
            <select id="inp-unita" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-amber-500 focus:outline-none">
              <option value="kg">kg</option>
              <option value="lt">lt</option>
              <option value="pz">pz</option>
              <option value="ct">cartone</option>
              <option value="gr">gr</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 bg-slate-700/30 p-3 rounded-xl border border-slate-700">
          <div>
            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Costo Unitario (€)</label>
            <input type="number" id="inp-costo" step="0.01" min="0" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-emerald-500 focus:outline-none" placeholder="0.00">
          </div>
          <div>
            <label class="block text-xs font-bold text-amber-500 uppercase mb-1">Porzioni per Unità</label>
            <input type="number" id="inp-resa" step="1" min="1" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-amber-500 focus:outline-none" placeholder="Es. 10" value="1">
            <p class="text-[10px] text-slate-400 mt-1">Es: 1kg fa 10 porzioni?</p>
          </div>
        </div>

        <div>
            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Giacenza Iniziale</label>
            <input type="number" id="inp-quantita" step="any" min="0" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white focus:border-amber-500 focus:outline-none" value="0">
        </div>

        <button type="submit" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-95 mt-4">
          Aggiungi all'Inventario
        </button>
      </form>
    </div>
  </div>

  <div id="modal-wine" class="fixed inset-0 bg-slate-900/95 flex items-center justify-center p-4 z-40 hidden backdrop-blur-sm">
    <div class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg border border-slate-700">
      <div class="p-6 border-b border-slate-700 flex justify-between items-center">
        <h2 class="text-xl font-bold text-white">Nuovo Vino</h2>
        <button id="close-modal-wine" class="text-slate-400 hover:text-white">✕</button>
      </div>
      <form id="form-wine" class="p-6 space-y-4">
        <input type="text" id="w-nome" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white" required placeholder="Nome Etichetta">
        <div class="grid grid-cols-2 gap-4">
            <input type="text" id="w-cantina" class="bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white" placeholder="Cantina">
            <input type="text" id="w-regione" class="bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white" placeholder="Regione">
        </div>
        <div class="grid grid-cols-2 gap-4">
            <input type="number" id="w-anno" class="bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white" placeholder="Anno" min="1900">
            <input type="number" id="w-quantita" class="bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white" placeholder="Q.tà Bottiglie">
        </div>
        <div class="grid grid-cols-2 gap-4">
            <input type="number" id="w-costo" step="0.01" class="bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white" placeholder="Costo Acquisto €">
            <input type="number" id="w-vendita" step="0.01" class="bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white" placeholder="Prezzo Vendita €">
        </div>
        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl mt-4">Salva in Cantina</button>
      </form>
    </div>
  </div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, doc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    // Configurazione Firebase (Invariata)
    const firebaseConfig = {
      apiKey: "AIzaSyDWS8urdhG9RdS62rihj0FBPV38aWUclGQ",
      authDomain: "inventario-a52a4.firebaseapp.com",
      projectId: "inventario-a52a4",
      storageBucket: "inventario-a52a4.firebasestorage.app",
      messagingSenderId: "531426475103",
      appId: "1:531426475103:web:9a3c9b74547fd19a0a6fea",
      measurementId: "G-8HSKSW2Q86"
    };

    const GRUPPO_ID = "inventario-segreto-123";
    let db, auth;
    
    // Stato Applicazione
    const state = {
        view: 'inventario', // inventario, foodcost, cantina
        products: [],
        vini: [],
        recipeIngredients: [] // { id, name, qtyUsed, unit, costPerUnit }
    };

    // Elementi DOM
    const els = {
        navInv: document.getElementById('nav-inventario'),
        navFood: document.getElementById('nav-foodcost'),
        navVin: document.getElementById('nav-cantina'),
        views: {
            inv: document.getElementById('view-inventario'),
            food: document.getElementById('view-foodcost'),
            vin: document.getElementById('view-cantina')
        },
        invList: document.getElementById('inventory-list-container'),
        invTotal: document.getElementById('inventory-total-value'),
        searchInv: document.getElementById('search-bar'),
        fab: document.getElementById('fab-add-btn'),
        modalProd: {
            el: document.getElementById('modal-product'),
            form: document.getElementById('form-product'),
            close: document.getElementById('close-modal-product')
        },
        modalWine: {
            el: document.getElementById('modal-wine'),
            form: document.getElementById('form-wine'),
            close: document.getElementById('close-modal-wine')
        },
        wineList: document.getElementById('wine-list-container'),
        searchWine: document.getElementById('search-bar-vini'),
        pdfBtn: document.getElementById('btn-report-vini-pdf'),
        
        // Food Cost Elements
        fcSelect: document.getElementById('fc-select-product'),
        fcInputQty: document.getElementById('fc-input-qty'),
        fcAddBtn: document.getElementById('fc-add-btn'),
        fcTableBody: document.getElementById('fc-recipe-body'),
        fcTotalCost: document.getElementById('fc-total-cost'),
        fcSellPrice: document.getElementById('fc-sell-price'),
        fcPercent: document.getElementById('fc-percent'),
        fcPercentBar: document.getElementById('fc-percent-bar'),
        fcStatus: document.getElementById('fc-status-text'),
        fcMargin: document.getElementById('fc-margin'),
        fcReset: document.getElementById('fc-reset-btn'),
        fcEmpty: document.getElementById('fc-empty-msg')
    };

    // --- INIZIALIZZAZIONE ---
    async function init() {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    startListeners();
                } else {
                    signInAnonymously(auth).catch(e => alert("Login Error: " + e.message));
                }
            });

            setupEvents();
        } catch (e) {
            console.error(e);
            alert("Errore Init: " + e.message);
        }
    }

    function startListeners() {
        // Prodotti
        onSnapshot(collection(db, "inventari", GRUPPO_ID, "prodotti"), (snap) => {
            state.products = snap.docs.map(d => ({id: d.id, ...d.data()}));
            document.getElementById('loading-overlay').classList.add('hidden');
            render();
        });
        // Vini
        onSnapshot(collection(db, "inventari", GRUPPO_ID, "vini"), (snap) => {
            state.vini = snap.docs.map(d => ({id: d.id, ...d.data()}));
            render();
        });
    }

    // --- RENDERING ---
    function render() {
        if (state.view === 'inventario') renderInventory();
        else if (state.view === 'foodcost') renderFoodCostView(); // Popola la select
        else if (state.view === 'cantina') renderWines();
        
        updateNav();
    }

    function updateNav() {
        const activeClass = "bg-amber-500 text-slate-900 shadow";
        const inactiveClass = "text-slate-400 hover:text-white hover:bg-slate-700";
        
        const setClass = (el, active) => {
            el.className = `nav-btn px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 ${active ? activeClass : inactiveClass}`;
        };

        setClass(els.navInv, state.view === 'inventario');
        setClass(els.navFood, state.view === 'foodcost');
        setClass(els.navVin, state.view === 'cantina');

        els.views.inv.classList.toggle('hidden', state.view !== 'inventario');
        els.views.food.classList.toggle('hidden', state.view !== 'foodcost');
        els.views.vin.classList.toggle('hidden', state.view !== 'cantina');

        // Colore FAB in base alla vista
        if(state.view === 'cantina') {
             els.fab.classList.remove('bg-amber-500', 'hover:bg-amber-600');
             els.fab.classList.add('bg-purple-600', 'hover:bg-purple-700', 'text-white');
             els.fab.style.display = 'block';
        } else if (state.view === 'inventario') {
             els.fab.classList.add('bg-amber-500', 'hover:bg-amber-600');
             els.fab.classList.remove('bg-purple-600', 'hover:bg-purple-700', 'text-white');
             els.fab.style.display = 'block';
        } else {
             els.fab.style.display = 'none'; // Nascondi su Food Cost
        }
    }

    // --- LOGICA INVENTARIO ---
    function renderInventory() {
        els.invList.innerHTML = '';
        const term = els.searchInv.value.toLowerCase();
        
        let totalVal = 0;
        
        // Ordina alfabetico
        const filtered = state.products
            .filter(p => p.nome.toLowerCase().includes(term))
            .sort((a,b) => a.nome.localeCompare(b.nome));

        if(filtered.length === 0) {
            document.getElementById('no-products-message').classList.remove('hidden');
            return;
        }
        document.getElementById('no-products-message').classList.add('hidden');

        filtered.forEach(p => {
            const costoUnitario = parseFloat(p.costo) || 0;
            const qta = parseFloat(p.quantita) || 0;
            const resa = parseFloat(p.resa) || 1; // Porzioni per unità
            const costoPorzione = resa > 0 ? (costoUnitario / resa) : 0;
            
            totalVal += (costoUnitario * qta);

            const card = document.createElement('div');
            card.className = "bg-slate-800 border border-slate-700 rounded-xl p-4 shadow-lg flex flex-col justify-between group hover:border-slate-600 transition-colors";
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="font-bold text-lg text-white leading-tight">${p.nome}</h3>
                        <p class="text-xs text-slate-400 uppercase tracking-wide">${p.fornitore} • ${formatMoney(costoUnitario)}/${p.unita}</p>
                    </div>
                    <button class="text-slate-500 hover:text-red-400 p-1" onclick="deleteItem('${p.id}', 'prodotti')">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>

                <div class="bg-slate-900/50 rounded-lg p-2 mb-3 flex items-center justify-between">
                    <span class="text-xs text-amber-500 font-semibold uppercase">Costo Porzione</span>
                    <span class="font-mono font-bold text-slate-200">${formatMoney(costoPorzione)}</span>
                </div>

                <div class="flex items-center justify-between mt-auto pt-2 border-t border-slate-700/50">
                    <span class="text-xs text-slate-400 font-bold uppercase">Giacenza</span>
                    <div class="flex items-center gap-3">
                        <button class="bg-slate-700 hover:bg-slate-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold" onclick="updateQty('${p.id}', ${qta - 1})">-</button>
                        <input type="number" value="${qta}" onchange="updateQty('${p.id}', this.value)" class="w-16 bg-transparent text-center text-xl font-bold text-white focus:outline-none">
                        <span class="text-sm text-slate-500 font-medium">${p.unita}</span>
                        <button class="bg-slate-700 hover:bg-slate-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold" onclick="updateQty('${p.id}', ${qta + 1})">+</button>
                    </div>
                </div>
            `;
            els.invList.appendChild(card);
        });

        els.invTotal.textContent = formatMoney(totalVal);
    }

    // --- LOGICA FOOD COST ---
    function renderFoodCostView() {
        // Popola select se vuota
        if (els.fcSelect.options.length <= 1) {
             const sorted = [...state.products].sort((a,b) => a.nome.localeCompare(b.nome));
             sorted.forEach(p => {
                 const opt = document.createElement('option');
                 opt.value = p.id;
                 opt.textContent = `${p.nome} (${formatMoney(p.costo)}/${p.unita})`;
                 els.fcSelect.appendChild(opt);
             });
        }
        renderRecipeTable();
    }

    function addToRecipe() {
        const pid = els.fcSelect.value;
        const qty = parseFloat(els.fcInputQty.value);
        if(!pid || isNaN(qty) || qty <= 0) return;

        const product = state.products.find(p => p.id === pid);
        if(!product) return;

        // Calcolo costo di questa riga
        // Se unita è kg e qty è 0.5 -> 0.5 * costo
        // Nota: Assumiamo che l'input qty sia nella STESSA unità del prodotto per semplicità,
        // oppure facciamo una conversione base se volessimo complicare. Qui: 1 to 1.
        const lineCost = qty * parseFloat(product.costo);

        state.recipeIngredients.push({
            id: Date.now(), // ID temporaneo per la riga
            name: product.nome,
            qty: qty,
            unit: product.unita,
            cost: lineCost
        });

        els.fcSelect.value = "";
        els.fcInputQty.value = "";
        renderRecipeTable();
    }

    function renderRecipeTable() {
        els.fcTableBody.innerHTML = '';
        let totalCost = 0;

        if (state.recipeIngredients.length === 0) {
            els.fcEmpty.classList.remove('hidden');
        } else {
            els.fcEmpty.classList.add('hidden');
            state.recipeIngredients.forEach((ing, index) => {
                totalCost += ing.cost;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium text-white">${ing.name}</td>
                    <td class="px-4 py-3 text-right text-slate-300 font-mono">${ing.qty} ${ing.unit}</td>
                    <td class="px-4 py-3 text-right text-slate-300 font-mono">${formatMoney(ing.cost)}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="removeRecipeItem(${index})" class="text-red-400 hover:text-red-300">✕</button>
                    </td>
                `;
                els.fcTableBody.appendChild(tr);
            });
        }

        els.fcTotalCost.textContent = formatMoney(totalCost);
        calculateMetrics(totalCost);
    }

    function calculateMetrics(cost) {
        const price = parseFloat(els.fcSellPrice.value) || 0;
        
        let percent = 0;
        let margin = 0;

        if (price > 0) {
            percent = (cost / price) * 100;
            margin = price - cost;
            els.fcPercent.textContent = percent.toFixed(1) + "%";
            els.fcMargin.textContent = formatMoney(margin);
            
            // Colore Barra e Testo
            els.fcPercentBar.style.width = Math.min(percent, 100) + "%";
            
            if(percent < 25) {
                els.fcPercentBar.className = "h-2.5 rounded-full bg-emerald-500 transition-all duration-500";
                els.fcStatus.textContent = "Margine Eccellente";
                els.fcStatus.className = "text-xs text-right mt-1 text-emerald-400";
            } else if (percent < 35) {
                els.fcPercentBar.className = "h-2.5 rounded-full bg-amber-500 transition-all duration-500";
                 els.fcStatus.textContent = "Margine Buono";
                 els.fcStatus.className = "text-xs text-right mt-1 text-amber-400";
            } else {
                els.fcPercentBar.className = "h-2.5 rounded-full bg-red-500 transition-all duration-500";
                els.fcStatus.textContent = "Attenzione: Costi Alti";
                els.fcStatus.className = "text-xs text-right mt-1 text-red-400";
            }
        } else {
            els.fcPercent.textContent = "0%";
            els.fcPercentBar.style.width = "0%";
            els.fcMargin.textContent = "€ 0,00";
            els.fcStatus.textContent = "Inserisci prezzo vendita";
        }
    }

    // --- LOGICA CANTINA (Accordion) ---
    function renderWines() {
        els.wineList.innerHTML = '';
        const term = els.searchWine.value.toLowerCase();
        
        const filtered = state.vini.filter(v => 
            v.nome.toLowerCase().includes(term) || 
            (v.cantina && v.cantina.toLowerCase().includes(term))
        );

        if(filtered.length === 0) {
            document.getElementById('no-wines-message').classList.remove('hidden');
            return;
        }
        document.getElementById('no-wines-message').classList.add('hidden');

        // Raggruppa per Regione
        const grouped = filtered.reduce((acc, v) => {
            const reg = v.regione || 'Altro';
            if(!acc[reg]) acc[reg] = [];
            acc[reg].push(v);
            return acc;
        }, {});

        Object.keys(grouped).sort().forEach(reg => {
            const groupDiv = document.createElement('div');
            groupDiv.className = "bg-slate-800 border border-slate-700 rounded-xl overflow-hidden";
            
            // Header Accordion
            groupDiv.innerHTML = `
                <button class="w-full px-6 py-4 flex justify-between items-center bg-slate-800 hover:bg-slate-750 transition-colors" onclick="this.nextElementSibling.classList.toggle('hidden')">
                    <span class="font-bold text-lg text-purple-400">${reg}</span>
                    <span class="bg-slate-700 text-xs px-2 py-1 rounded-full text-white">${grouped[reg].length}</span>
                </button>
                <div class="hidden border-t border-slate-700 p-4 grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-900/30">
                    ${grouped[reg].map(v => createWineCardHTML(v)).join('')}
                </div>
            `;
            els.wineList.appendChild(groupDiv);
        });
    }

    function createWineCardHTML(v) {
        return `
            <div class="bg-slate-800 border border-slate-700 p-4 rounded-lg relative">
                 <button class="absolute top-2 right-2 text-slate-500 hover:text-red-400" onclick="deleteItem('${v.id}', 'vini')">✕</button>
                 <h4 class="font-bold text-white">${v.nome} <span class="text-slate-500 font-normal">${v.anno}</span></h4>
                 <p class="text-sm text-slate-400 italic mb-2">${v.cantina}</p>
                 <div class="flex justify-between items-end">
                    <div>
                        <p class="text-xs text-slate-500">Costo: €${v.costo}</p>
                        <p class="text-xs text-slate-500">Vendita: €${v.vendita}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="text-slate-400 hover:text-white bg-slate-700 rounded px-2" onclick="updateWineQty('${v.id}', ${parseInt(v.quantita)-1})">-</button>
                        <span class="font-bold text-lg w-6 text-center">${v.quantita}</span>
                        <button class="text-slate-400 hover:text-white bg-slate-700 rounded px-2" onclick="updateWineQty('${v.id}', ${parseInt(v.quantita)+1})">+</button>
                    </div>
                 </div>
            </div>
        `;
    }

    // --- HELPER FUNCTIONS ---
    function formatMoney(val) {
        return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(val || 0);
    }

    function setupEvents() {
        // Navigazione
        els.navInv.onclick = () => { state.view = 'inventario'; render(); };
        els.navFood.onclick = () => { state.view = 'foodcost'; render(); };
        els.navVin.onclick = () => { state.view = 'cantina'; render(); };
        
        // Ricerca
        els.searchInv.oninput = renderInventory;
        els.searchWine.oninput = renderWines;

        // Modale Prodotti
        els.fab.onclick = () => {
            if(state.view === 'inventario') els.modalProd.el.classList.remove('hidden');
            if(state.view === 'cantina') els.modalWine.el.classList.remove('hidden');
        };
        els.modalProd.close.onclick = () => els.modalProd.el.classList.add('hidden');
        els.modalWine.close.onclick = () => els.modalWine.el.classList.add('hidden');

        // Form Submit Prodotti
        els.modalProd.form.onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                nome: document.getElementById('inp-nome').value,
                fornitore: document.getElementById('inp-fornitore').value,
                unita: document.getElementById('inp-unita').value,
                costo: parseFloat(document.getElementById('inp-costo').value)||0,
                resa: parseFloat(document.getElementById('inp-resa').value)||1,
                quantita: parseFloat(document.getElementById('inp-quantita').value)||0,
            };
            await addDoc(collection(db, "inventari", GRUPPO_ID, "prodotti"), data);
            els.modalProd.el.classList.add('hidden');
            els.modalProd.form.reset();
            showAlert('Prodotto Aggiunto', 'Inventario aggiornato');
        };

        // Form Submit Vini
        els.modalWine.form.onsubmit = async (e) => {
            e.preventDefault();
             const data = {
                nome: document.getElementById('w-nome').value,
                cantina: document.getElementById('w-cantina').value,
                regione: document.getElementById('w-regione').value,
                anno: document.getElementById('w-anno').value,
                quantita: document.getElementById('w-quantita').value,
                costo: document.getElementById('w-costo').value,
                vendita: document.getElementById('w-vendita').value,
            };
            await addDoc(collection(db, "inventari", GRUPPO_ID, "vini"), data);
            els.modalWine.el.classList.add('hidden');
            els.modalWine.form.reset();
            showAlert('Vino Aggiunto', 'Cantina aggiornata');
        };

        // Food Cost Buttons
        els.fcAddBtn.onclick = addToRecipe;
        els.fcSellPrice.oninput = () => calculateMetrics(parseFloat(els.fcTotalCost.textContent.replace(/[^\d,]/g, '').replace(',','.'))); // Quick hack to re-parse displayed cost
        els.fcReset.onclick = () => {
            state.recipeIngredients = [];
            els.fcSellPrice.value = '';
            renderRecipeTable();
        };

        // PDF Vini
        els.pdfBtn.onclick = generateWinePDF;
        
        // Esposizione funzioni globali per onclick inline
        window.updateQty = async (id, val) => {
            if(val < 0) val = 0;
            await updateDoc(doc(db, "inventari", GRUPPO_ID, "prodotti", id), { quantita: parseFloat(val) });
        };
        window.updateWineQty = async (id, val) => {
             if(val < 0) val = 0;
            await updateDoc(doc(db, "inventari", GRUPPO_ID, "vini", id), { quantita: parseInt(val) });
        };
        window.deleteItem = async (id, coll) => {
            if(confirm('Eliminare definitivamente?')) {
                await deleteDoc(doc(db, "inventari", GRUPPO_ID, coll, id));
            }
        };
        window.removeRecipeItem = (index) => {
            state.recipeIngredients.splice(index, 1);
            renderRecipeTable();
        };
    }

    function showAlert(title, msg) {
        const al = document.getElementById('custom-alert');
        document.getElementById('custom-alert-title').innerText = title;
        document.getElementById('custom-alert-message').innerText = msg;
        al.classList.remove('hidden');
        al.classList.add('bg-slate-800', 'border-amber-500', 'text-white');
        setTimeout(() => al.classList.add('hidden'), 3000);
    }

    // PDF Generator
    function generateWinePDF() {
         const { jsPDF } = window.jspdf;
         const doc = new jsPDF();
         
         doc.setFontSize(18);
         doc.text("Report Cantina Vini", 14, 22);
         
         const data = state.vini.map(v => [
             v.nome, 
             v.cantina, 
             v.anno, 
             v.quantita, 
             "€ " + v.costo, 
             "€ " + v.vendita
         ]);

         doc.autoTable({
             head: [['Vino', 'Cantina', 'Anno', 'Q.tà', 'Costo', 'Vendita']],
             body: data,
             startY: 30,
             theme: 'grid',
             styles: { fontSize: 9 }
         });
         
         doc.save('cantina_report.pdf');
    }

    // Start
    init();

  </script>
</body>
</html>
