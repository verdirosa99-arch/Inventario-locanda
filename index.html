<!DOCTYPE html>
<html lang="it"> <!-- La classe 'dark' verrÃ  aggiunta qui da JS -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Inventario (Firebase)</title>
  
  <!-- 1. Carica Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Stili CSS (invariati) */
    input[type='number']::-webkit-inner-spin-button,
    input[type='number']::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type='number'] {
      -moz-appearance: textfield;
    }
    /* Stili per il toggle scuro */
    .theme-switch-toggle {
      transition: all 0.2s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans dark:bg-gray-900">

  <!-- NUOVO: Overlay di caricamento -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center z-[999]">
    <svg class="animate-spin h-10 w-10 text-white mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <span class="text-white text-lg font-medium">Caricamento dati...</span>
  </div>

  <div class="max-w-7xl mx-auto">
    
    <!-- Intestazione e Navigazione Viste -->
    <header class="mb-6">
      <div class="flex justify-between items-center">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-gray-100">Gestione Inventario</h1>
        <div class="flex items-center space-x-4">
          <!-- Pulsante Home -->
          <button id="btn-go-home" class="hidden text-gray-500 hover:text-blue-600 transition-colors dark:text-gray-400 dark:hover:text-blue-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
            </svg>
          </button>
          
          <!-- Dark Mode Toggle -->
          <label for="theme-toggle" class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="theme-toggle" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-300 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2 text-gray-500 dark:text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" class="hidden dark:block"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" class="block dark:hidden"/>
            </svg>
          </label>
        </div>
      </div>

      <!-- Wrapper per le schede di navigazione -->
      <nav id="main-nav-tabs" class="flex space-x-2 mt-4 hidden">
        <button id="nav-inventario"
          class="px-3 py-2 md:px-4 text-sm md:text-base rounded-lg font-semibold shadow-md transition-all duration-200 bg-blue-600 text-white">
          Inventario
        </button>
        <button id="nav-listaSpesa"
          class="px-3 py-2 md:px-4 text-sm md:text-base rounded-lg font-semibold shadow-md transition-all duration-200 bg-white text-gray-700 dark:bg-gray-700 dark:text-gray-200">
          Lista Spesa
          <span id="shopping-list-badge" class="ml-2 bg-red-500 text-white text-xs font-bold rounded-full px-2 py-1 hidden">
          </span>
        </button>
      </nav>
    </header>

    <!-- Sezione Viste -->
    <main>
      
      <!-- VISTA: Home -->
      <div id="view-home">
        <h2 class="text-2xl font-semibold text-gray-700 mb-6 dark:text-gray-200">Menu Principale</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Bottone Inventario -->
          <button id="btn-go-inventario" class="flex flex-col items-center justify-center bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow text-center dark:bg-gray-800 dark:hover:shadow-lg dark:hover:shadow-gray-700/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-600 dark:text-blue-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
            </svg>
            <span class="text-xl font-semibold text-gray-800 dark:text-gray-100">Inventario</span>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Gestisci e aggiungi prodotti</p>
          </button>
          
          <!-- Bottone Lista Spesa -->
          <button id="btn-go-listaspesa" class="flex flex-col items-center justify-center bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow text-center dark:bg-gray-800 dark:hover:shadow-lg dark:hover:shadow-gray-700/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500 dark:text-red-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span class="text-xl font-semibold text-gray-800 dark:text-gray-100">Lista Spesa</span>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Vedi i prodotti da ordinare</p>
          </button>
          
          <!-- Bottone Report Costi -->
          <button id="btn-go-costi" class="flex flex-col items-center justify-center bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow text-center dark:bg-gray-800 dark:hover:shadow-lg dark:hover:shadow-gray-700/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-600 dark:text-green-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span class="text-xl font-semibold text-gray-800 dark:text-gray-100">Report Costi</span>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Visualizza valore inventario</p>
          </button>
        </div>
      </div>
      
      <!-- VISTA: Inventario -->
      <div id="view-inventario" class="hidden">
        <div class="space-y-6">
          
          <!-- Filtri Vista Inventario (NUOVA VERSIONE A TENDINA) -->
          <div class="relative">
            <!-- Pulsante per aprire il menu a tendina -->
            <button id="toggle-filters-btn" class="flex items-center space-x-2 bg-white px-4 py-2 rounded-lg shadow-md font-medium text-gray-700 hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
              </svg>
              <span>Opzioni Vista</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 dark:text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
      
            <!-- Contenitore del menu a tendina -->
            <div id="filters-dropdown" class="absolute top-full left-0 mt-2 bg-white rounded-lg shadow-xl p-4 z-30 hidden w-full md:w-auto dark:bg-gray-800 dark:border dark:border-gray-700">
              <div class="flex flex-col md:flex-row gap-6">
                <!-- Sezione Raggruppa -->
                <div>
                  <span class="font-medium text-gray-700 block mb-2 dark:text-gray-200">Raggruppa per:</span>
                  <div class="flex flex-col sm:flex-row gap-2">
                    <button id="group-categoria" class="px-3 py-1 rounded-md text-sm font-medium bg-blue-500 text-white">
                      Categoria
                    </button>
                    <button id="group-fornitore" class="px-3 py-1 rounded-md text-sm font-medium bg-white shadow-sm dark:bg-gray-600 dark:text-gray-200">
                      Fornitore
                    </button>
                  </div>
                </div>
                <!-- Sezione Vista -->
                <div class="border-t md:border-t-0 md:border-l border-gray-200 pt-4 md:pt-0 md:pl-4 dark:border-gray-700">
                  <span class="font-medium text-gray-700 block mb-2 dark:text-gray-200">Vista:</span>
                  <div class="flex flex-col sm:flex-row gap-2">
                    <button id="view-compatta" class="px-3 py-1 rounded-md text-sm font-medium bg-blue-500 text-white">
                      Compatta
                    </button>
                    <button id="view-completa" class="px-3 py-1 rounded-md text-sm font-medium bg-white shadow-sm dark:bg-gray-600 dark:text-gray-200">
                      Completa
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>


          <!-- Lista Prodotti Inventario -->
          <div id="inventory-list-container" class="space-y-6">
            <!-- Contenuto generato da JS -->
          </div>
        </div>
      </div>

      <!-- VISTA: Lista Spesa -->
      <div id="view-listaSpesa" class="hidden">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md dark:bg-gray-800">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100">Lista della Spesa</h2>
            <!-- Pulsante Copia -->
            <button id="copy-shopping-list-btn" class="mt-4 md:mt-0 flex items-center justify-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-200 font-semibold dark:hover:bg-blue-500">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
              <span>Copia Lista per Fornitori</span>
            </button>
          </div>
          <div id="shopping-list-container" class="space-y-8">
            <!-- Contenuto generato da JS -->
          </div>
        </div>
      </div>
      
      <!-- VISTA: Report Costi -->
      <div id="view-costi" class="hidden">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md dark:bg-gray-800">
          <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 dark:text-gray-100">Report Valore Inventario</h2>
          <div id="cost-report-container" class="space-y-8">
            <!-- Contenuto generato da JS -->
          </div>
        </div>
      </div>
      
    </main>

  </div>

  <!-- ================== Modale Form Aggiungi Prodotto ================== -->
  <div id="form-modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-40 hidden">
    
    <!-- Contenuto Modale -->
    <div class="bg-white p-4 md:p-6 rounded-lg shadow-md w-full max-w-4xl relative max-h-[90vh] overflow-y-auto dark:bg-gray-800">
      
      <!-- Pulsante Chiudi Modale -->
      <button id="close-form-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 z-10 dark:hover:text-gray-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <!-- Form Aggiungi Prodotto (spostato qui) -->
      <h2 class="text-xl md:text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Aggiungi Nuovo Prodotto</h2>
      <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Colonna 1 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Nome Prodotto</label>
          <input type="text" name="nome" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Categoria</label>
          <input type="text" name="categoria" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <!-- Colonna 2 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Fornitore</label>
          <input type="text" name="fornitore" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <!-- Etichetta Costo -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Costo per UnitÃ  (â¬)</label>
          <input type="number" name="costoUnita" min="0" step="0.01" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <!-- Colonna 3 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Q.tÃ  Attuale</label>
          <input type="number" name="quantitaAttuale" min="0" step="1" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Q.tÃ  Minima</label>
          <input type="number" name="quantitaMinima" min="0" step="1" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <!-- Colonna 4 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">UnitÃ </label>
          <select name="unita" class="border rounded-md p-2 w-full bg-white shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
            <option value="kg">kg</option>
            <option value="gr">gr</option>
            <option value="pz" selected>pz</option>
            <option value="ct">ct</option>
          </select>
        </div>
        
        <button type="submit" class="w-full md:col-span-2 lg:col-span-1 bg-blue-600 text-white rounded-md p-2.5 font-semibold shadow-md hover:bg-blue-700 transition-all duration-200 h-full self-end mt-2 md:mt-0 dark:hover:bg-blue-500">
          Aggiungi Prodotto
        </button>
      </form>
    </div>
  </div>

  <!-- Pulsante "+" Fluttuante -->
  <button id="show-add-form-btn" class="fixed bottom-6 right-6 bg-blue-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:bg-blue-700 transition z-50 dark:hover:bg-blue-500">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
    </svg>
  </button>


  <!-- ================== SCRIPT APP (versione FIREBASE) ================== -->
  
  <!-- 1. Importa i moduli di Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, 
      onSnapshot, collection, query, where, getDocs, setLogLevel
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { 
      getAuth, signInAnonymously 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    // --- Passaggio 1: Configurazione Firebase ---
    // QUESTA Ã LA TUA CONFIGURAZIONE (giÃ  inserita)
    const firebaseConfig = {
      apiKey: "AIzaSyDWS8urdhG9RdS62rihj0FBPV38aWUclGQ",
      authDomain: "inventario-a52a4.firebaseapp.com",
      projectId: "inventario-a52a4",
      storageBucket: "inventario-a52a4.firebasestorage.app",
      messagingSenderId: "531426475103",
      appId: "1:531426475103:web:9a3c9b74547fd19a0a6fea",
      measurementId: "G-8HSKSW2Q86"
    };

    // --- Passaggio 2: ID Gruppo Condiviso ---
    // Cambia questa "password" se vuoi, ma tu e il tuo collega dovete avere LA STESSA.
    const GRUPPO_ID = "inventario-segreto-123";

    // --- STATO LOCALE E COSTANTI ---
    const THEME_KEY = 'inventarioAppTheme';
    const state = {
      currentView: 'home', 
      groupBy: 'categoria',
      inventoryViewMode: 'compatta',
      products: [],
      db: null, // Riferimento al database
      auth: null, // Riferimento all'autenticazione
      collectionRef: null // Riferimento alla collezione
    };
    
    const unitOptions = ['kg', 'gr', 'pz', 'ct'];

    // --- SELETTORI DOM (Invariati) ---
    const $ = (selector) => document.querySelector(selector);
    const viewHome = $('#view-home');
    const viewInventario = $('#view-inventario');
    const viewListaSpesa = $('#view-listaSpesa');
    const viewCosti = $('#view-costi');
    const mainNavTabs = $('#main-nav-tabs');
    const btnGoHome = $('#btn-go-home');
    const btnGoInventario = $('#btn-go-inventario');
    const btnGoListaSpesa = $('#btn-go-listaspesa');
    const btnGoCosti = $('#btn-go-costi');
    const navInventario = $('#nav-inventario');
    const navListaSpesa = $('#nav-listaSpesa');
    const groupCategoria = $('#group-categoria');
    const groupFornitore = $('#group-fornitore');
    const viewCompatta = $('#view-compatta');
    const viewCompleta = $('#view-completa');
    const toggleFiltersBtn = $('#toggle-filters-btn');
    const filtersDropdown = $('#filters-dropdown');
    const addProductForm = $('#add-product-form');
    const showAddFormBtn = $('#show-add-form-btn');
    const formModalOverlay = $('#form-modal-overlay');
    const closeFormModalBtn = $('#close-form-modal-btn');
    const inventoryListContainer = $('#inventory-list-container');
    const shoppingListContainer = $('#shopping-list-container');
    const costReportContainer = $('#cost-report-container');
    const shoppingListBadge = $('#shopping-list-badge');
    const copyShoppingListBtn = $('#copy-shopping-list-btn');
    const themeToggle = $('#theme-toggle');
    const loadingOverlay = $('#loading-overlay'); // Selettore per il loading

    // --- FUNZIONI DI LOGICA (Modificate per Firebase) ---

    // (generateId non serve piÃ¹)
    // (saveProductsToLocalStorage non serve piÃ¹)
    // (loadProducts Ã¨ sostituito da onSnapshot)

    /** Raggruppa i prodotti (invariato) */
    function getGroupedProducts() {
      const groupKey = state.groupBy;
      const grouped = state.products.reduce((acc, prodotto) => {
        const key = prodotto[groupKey] || 'Non Assegnato';
        if (!acc.has(key)) {
          acc.set(key, []);
        }
        acc.get(key).push(prodotto);
        return acc;
      }, new Map());
      
      return new Map([...grouped.entries()].sort((a, b) => a[0].localeCompare(b[0])));
    }

    /** Filtra e raggruppa lista spesa (invariato) */
    function getShoppingListGrouped() {
      const prodottiDaAcquistare = state.products.filter(
        p => p.quantitaAttuale <= p.quantitaMinima
      );
      const grouped = prodottiDaAcquistare.reduce((acc, prodotto) => {
        const key = prodotto.fornitore || 'Sconosciuto';
        if (!acc.has(key)) {
          acc.set(key, []);
        }
        acc.get(key).push(prodotto);
        return acc;
      }, new Map());
      
      return new Map([...grouped.entries()].sort((a, b) => a[0].localeCompare(b[0])));
    }

    /** Aggiunge un nuovo prodotto a Firebase */
    async function aggiungiProdotto(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const newProduct = {};
      
      for (let [key, value] of formData.entries()) {
        if (key === 'costoUnita' || key === 'quantitaAttuale' || key === 'quantitaMinima') {
          newProduct[key] = parseFloat(value) || 0;
        } else {
          newProduct[key] = value;
        }
      }
      
      try {
        await addDoc(state.collectionRef, newProduct);
        // Non serve `render()` qui, onSnapshot lo farÃ 
        e.target.reset();
        formModalOverlay.classList.add('hidden');
      } catch (err) {
        console.error("Errore aggiungendo prodotto: ", err);
        alert("Errore nell'aggiunta del prodotto.");
      }
    }

    /** Rimuove un prodotto da Firebase */
    async function rimuoviProdotto(id) {
      try {
        const docRef = doc(state.db, `inventario/${GRUPPO_ID}/prodotti`, id);
        await deleteDoc(docRef);
        // onSnapshot aggiornerÃ  la UI
      } catch (err) {
        console.error("Errore rimuovendo prodotto: ", err);
        alert("Errore nella rimozione del prodotto.");
      }
    }

    /** Aggiorna un campo del prodotto su Firebase */
    async function updateProductField(id, field, value) {
      const product = state.products.find(p => p.id === id);
      if (!product) return;
      
      let parsedValue = value;
      if (field === 'costoUnita' || field === 'quantitaAttuale' || field === 'quantitaMinima') {
        parsedValue = parseFloat(value) || 0;
      }
      
      // Evita scritture inutili se il valore non Ã¨ cambiato
      if (product[field] === parsedValue) {
        return;
      }

      try {
        const docRef = doc(state.db, `inventario/${GRUPPO_ID}/prodotti`, id);
        await updateDoc(docRef, {
          [field]: parsedValue // Sintassi per usare una variabile come nome chiave
        });
        // onSnapshot aggiornerÃ  la UI
      } catch (err) {
        console.error("Errore aggiornando prodotto: ", err);
        alert("Errore nell'aggiornamento del prodotto.");
      }
    }
    
    /** Aggiorna la quantitÃ  con +1 o -1 su Firebase */
    async function updateProductQuantity(id, change) {
      const product = state.products.find(p => p.id === id);
      if (!product) return;
      
      let currentQuantity = parseFloat(product.quantitaAttuale) || 0;
      let newQuantity = currentQuantity + change;
      
      if (newQuantity < 0) {
        newQuantity = 0; // Impedisce quantitÃ  negative
      }

      // Evita scritture inutili
      if (product.quantitaAttuale === newQuantity) {
        return;
      }

      try {
        const docRef = doc(state.db, `inventario/${GRUPPO_ID}/prodotti`, id);
        await updateDoc(docRef, {
          quantitaAttuale: newQuantity
        });
        // onSnapshot aggiornerÃ  la UI
      } catch (err) {
        console.error("Errore aggiornando quantitÃ : ", err);
        alert("Errore nell'aggiornamento della quantitÃ .");
      }
    }
    
    /** Copia la lista spesa negli appunti (invariato) */
    function copiaListaSpesa() {
        const grouped = getShoppingListGrouped();
        if (grouped.size === 0) {
            alert("Lista della spesa vuota!");
            return;
        }
        
        let testoLista = "Lista della Spesa:\n";
        
        for (let [fornitore, prodotti] of grouped) {
            testoLista += `\n--- Fornitore: ${fornitore} ---\n`;
            prodotti.forEach(prodotto => {
                 testoLista += `- ${prodotto.nome} (Att: ${prodotto.quantitaAttuale} / Min: ${prodotto.quantitaMinima}) - ${prodotto.unita}\n`;
            });
        }

        navigator.clipboard.writeText(testoLista).then(() => {
            const originalText = copyShoppingListBtn.innerHTML;
            copyShoppingListBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
              </svg>
              <span>Copiato!</span>`;
            setTimeout(() => {
                copyShoppingListBtn.innerHTML = originalText;
            }, 2000);
        }).catch(err => {
            console.error('Errore nel copiare la lista: ', err);
            alert("Errore: Impossibile copiare la lista.");
        });
    }

    // --- FUNZIONI DI RENDER (Invariate) ---
    // Queste funzioni leggono solo da `state.products`, 
    // quindi non hanno bisogno di sapere se i dati 
    // provengono da Firebase o localStorage.

    function render() {
      renderNav();
      renderViews();
      if (state.currentView === 'inventario') {
        renderInventoryList();
      }
      if (state.currentView === 'listaSpesa') {
        renderShoppingList();
      }
      if (state.currentView === 'costi') {
        renderCosti();
      }
      renderBadge();
    }

    function renderNav() {
      const isHome = state.currentView === 'home';
      
      mainNavTabs.classList.toggle('hidden', isHome);
      btnGoHome.classList.toggle('hidden', isHome);
      
      showAddFormBtn.classList.toggle('hidden', state.currentView !== 'inventario');

      if (!isHome) {
        if (state.currentView === 'inventario') {
          navInventario.classList.add('bg-blue-600', 'text-white');
          navInventario.classList.remove('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
          navListaSpesa.classList.add('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
          navListaSpesa.classList.remove('bg-blue-600', 'text-white');
        } else { // 'listaSpesa' o 'costi'
          navListaSpesa.classList.add('bg-blue-600', 'text-white');
          navListaSpesa.classList.remove('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
          navInventario.classList.add('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
          navInventario.classList.remove('bg-blue-600', 'text-white');
        }
      }
      
      // Aggiorna lo stile dei pulsanti dentro il dropdown
      if (state.groupBy === 'categoria') {
        groupCategoria.classList.add('bg-blue-500', 'text-white');
        groupCategoria.classList.remove('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        groupFornitore.classList.add('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        groupFornitore.classList.remove('bg-blue-500', 'text-white');
      } else {
        groupFornitore.classList.add('bg-blue-500', 'text-white');
        groupFornitore.classList.remove('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        groupCategoria.classList.add('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        groupCategoria.classList.remove('bg-blue-500', 'text-white');
      }
      
      if (state.inventoryViewMode === 'compatta') {
        viewCompatta.classList.add('bg-blue-500', 'text-white');
        viewCompatta.classList.remove('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        viewCompleta.classList.add('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        viewCompleta.classList.remove('bg-blue-500', 'text-white');
      } else {
        viewCompleta.classList.add('bg-blue-500', 'text-white');
        viewCompleta.classList.remove('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        viewCompatta.classList.add('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        viewCompatta.classList.remove('bg-blue-500', 'text-white');
      }
    }

    function renderViews() {
      viewHome.classList.toggle('hidden', state.currentView !== 'home');
      viewInventario.classList.toggle('hidden', state.currentView !== 'inventario');
      viewListaSpesa.classList.toggle('hidden', state.currentView !== 'listaSpesa');
      viewCosti.classList.toggle('hidden', state.currentView !== 'costi');
    }

    function getUnitOptionsHTML(selectedValue) {
      return unitOptions.map(unita => 
        `<option value="${unita}" ${unita === selectedValue ? 'selected' : ''}>${unita}</option>`
      ).join('');
    }

    function renderInventoryList() {
      const grouped = getGroupedProducts();
      if (state.products.length === 0) {
        inventoryListContainer.innerHTML = `<div class="bg-white p-6 rounded-lg shadow text-center text-gray-500 dark:bg-gray-800 dark:text-gray-400">
          Nessun prodotto nell'inventario. Inizia aggiungendone uno!
        </div>`;
        return;
      }
      
      let html = '';
      for (let [groupKey, prodotti] of grouped) {
        html += `<section>
          <h2 class="text-xl md:text-2xl font-bold text-gray-700 mt-6 mb-3 border-b-2 border-gray-300 pb-2 capitalize dark:text-gray-200 dark:border-gray-600">
            ${groupKey}
          </h2>
          <div class="grid grid-cols-1 ${state.inventoryViewMode === 'completa' ? 'xl:grid-cols-2' : ''} gap-4">
            ${prodotti.map(prodotto => {
              const borderClass = prodotto.quantitaAttuale <= prodotto.quantitaMinima ? 'border-l-4 border-red-500' : 'border-transparent dark:border-transparent';
              const qtyClass = prodotto.quantitaAttuale <= prodotto.quantitaMinima ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400';
              
              const cardTop = `
                <div class="flex justify-between items-start mb-3">
                  <input type="text" value="${prodotto.nome}" data-id="${prodotto.id}" data-field="nome"
                    class="editable-input text-lg md:text-xl font-bold text-blue-800 border-b-2 border-transparent focus:border-blue-300 outline-none w-2/3 dark:text-blue-400 dark:bg-transparent dark:focus:border-blue-500">
                  <button class="remove-btn text-red-500 hover:text-red-700 font-semibold transition-colors text-sm flex-shrink-0 ml-2 dark:hover:text-red-400" data-id="${prodotto.id}">
                    Rimuovi
                  </button>
                </div>`;
                
              let cardBottom = '';
              
              if (state.inventoryViewMode === 'compatta') {
                cardBottom = `
                  <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mt-2 text-sm text-gray-600 dark:text-gray-400">
                    <div class="flex items-center space-x-2">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Q.tÃ :</label>
                      <button data-id="${prodotto.id}" class="qty-decrease bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 rounded-full w-6 h-6 flex items-center justify-center text-lg font-bold text-gray-700 dark:text-gray-200 hover:bg-gray-300 transition-colors">-</button>
                      <input type="number" value="${prodotto.quantitaAttuale}" data-id="${prodotto.id}" data-field="quantitaAttuale"
                        class="editable-input w-20 border rounded-md p-1 text-center font-medium ${qtyClass} dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                      <button data-id="${prodotto.id}" class="qty-increase bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 rounded-full w-6 h-6 flex items-center justify-center text-lg font-bold text-gray-700 dark:text-gray-200 hover:bg-gray-300 transition-colors">+</button>
                    </div>
                    <div class="flex items-center space-x-1">
                       <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">UnitÃ :</label>
                       <span class="font-medium dark:text-gray-300">${prodotto.unita}</span>
                    </div>
                    <div class="flex items-center space-x-1">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Min:</label>
                      <span class="font-medium dark:text-gray-300">${prodotto.quantitaMinima}</span>
                    </div>
                  </div>`;
              } else {
                cardBottom = `
                  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-3 text-sm text-gray-600 dark:text-gray-400">
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Categoria</label>
                      <input type="text" value="${prodotto.categoria}" data-id="${prodotto.id}" data-field="categoria"
                        class="editable-input border-b border-transparent focus:border-gray-300 outline-none w-full dark:bg-transparent dark:focus:border-gray-500 dark:text-gray-100">
                    </div>
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Fornitore</label>
                      <input type="text" value="${prodotto.fornitore}" data-id="${prodotto.id}" data-field="fornitore"
                        class="editable-input border-b border-transparent focus:border-gray-300 outline-none w-full dark:bg-transparent dark:focus:border-gray-500 dark:text-gray-100">
                    </div>
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Costo/UnitÃ </label>
                      <div class="flex items-center">
                        <span class="mr-1 dark:text-gray-400">â¬</span>
                        <input type="number" value="${prodotto.costoUnita}" data-id="${prodotto.id}" data-field="costoUnita"
                          class="editable-input w-20 border-b border-transparent focus:border-gray-300 outline-none dark:bg-transparent dark:focus:border-gray-500 dark:text-gray-100">
                      </div>
                    </div>
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Q.tÃ  Attuale</label>
                      <input type="number" value="${prodotto.quantitaAttuale}" data-id="${prodotto.id}" data-field="quantitaAttuale"
                        class="editable-input w-16 border-b border-transparent focus:border-gray-300 outline-none font-medium ${qtyClass} dark:bg-transparent dark:focus:border-gray-500">
                    </div>
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Q.tÃ  Minima</label>
                      <input type="number" value="${prodotto.quantitaMinima}" data-id="${prodotto.id}" data-field="quantitaMinima"
                        class="editable-input w-16 border-b border-transparent focus:border-gray-300 outline-none dark:bg-transparent dark:focus:border-gray-500 dark:text-gray-100">
                    </div>
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">UnitÃ </label>
                      <select data-id="${prodotto.id}" data-field="unita"
                        class="editable-input w-20 border-b bg-white border-transparent focus:border-gray-300 outline-none dark:bg-gray-800 dark:text-gray-100 dark:focus:border-gray-500">
                        ${getUnitOptionsHTML(prodotto.unita)}
                      </select>
                    </div>
                  </div>`;
              }
              
              return `<div class="bg-white shadow-lg rounded-lg p-4 transition-all duration-300 ${borderClass} dark:bg-gray-800 dark:shadow-none">
                ${cardTop}
                ${cardBottom}
              </div>`;
              
            }).join('')}
          </div>
        </section>`;
      }
      inventoryListContainer.innerHTML = html;
    }

    function renderShoppingList() {
      const grouped = getShoppingListGrouped();
      if (grouped.size === 0) {
        shoppingListContainer.innerHTML = `<div class="text-center text-gray-500 py-10 dark:text-gray-400">
          <p class="text-lg">La tua lista della spesa Ã¨ vuota!</p>
          <p class="text-sm md:text-base">I prodotti appariranno qui automaticamente quando la loro quantitÃ  scende sotto il minimo.</p>
        </div>`;
        copyShoppingListBtn.disabled = true;
        copyShoppingListBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        let html = '';
        for (let [groupKey, prodotti] of grouped) {
          html += `<section>
            <h3 class="text-xl md:text-2xl font-semibold text-blue-700 mb-3 border-b border-blue-200 pb-2 dark:text-blue-400 dark:border-blue-700">
              Fornitore: <span class="font-bold">${groupKey}</span>
            </h3>
            <ul class="list-disc list-inside pl-2 md:pl-4 space-y-2">
              ${prodotti.map(prodotto => `
                <li class="text-gray-800 text-base md:text-lg dark:text-gray-200">
                  <span class="font-semibold">${prodotto.nome}</span>
                  <span class="block text-sm text-gray-600 ml-6 md:ml-2 md:inline dark:text-gray-400">
                    (Attuale: <strong class="text-red-600 dark:text-red-400">${prodotto.quantitaAttuale}</strong> / Min: ${prodotto.quantitaMinima}) - ${prodotto.unita}
                  </span>
                </li>
              `).join('')}
            </ul>
          </section>`;
        }
        shoppingListContainer.innerHTML = html;
        copyShoppingListBtn.disabled = false;
        copyShoppingListBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }
    
    function renderCosti() {
      if (state.products.length === 0) {
        costReportContainer.innerHTML = `<div class="text-center text-gray-500 py-10 dark:text-gray-400">
          <p class="text-lg">Nessun prodotto nell'inventario.</p>
          <p class="text-sm md:text-base">Aggiungi prodotti e imposta il loro "Costo per UnitÃ " per vedere il report.</p>
        </div>`;
        return;
      }
      
      const groupedByCategoria = state.products.reduce((acc, prodotto) => {
        const key = prodotto.categoria || 'Non Assegnato';
        if (!acc.has(key)) {
          acc.set(key, []);
        }
        acc.get(key).push(prodotto);
        return acc;
      }, new Map());
      
      const sortedGroups = new Map([...groupedByCategoria.entries()].sort((a, b) => a[0].localeCompare(b[0])));

      let html = '';
      let costoTotaleInventario = 0;

      for (let [categoria, prodotti] of sortedGroups) {
        let costoCategoria = 0;
        
        const prodottiHtml = prodotti.map(prodotto => {
          const costoProdotto = (prodotto.costoUnita || 0) * (prodotto.quantitaAttuale || 0);
          costoCategoria += costoProdotto;
          
          return `<li class="flex justify-between items-center text-gray-700 text-sm md:text-base py-1 dark:text-gray-300">
            <span>
              <span class="font-medium">${prodotto.nome}</span>
              <span class="text-gray-500 text-xs md:text-sm ml-2 dark:text-gray-400">(${prodotto.quantitaAttuale} ${prodotto.unita} Ã ${formatCurrency(prodotto.costoUnita)})</span>
            </span>
            <span class="font-semibold">${formatCurrency(costoProdotto)}</span>
          </li>`;
        }).join('');
        
        html += `<section>
          <h3 class="text-xl md:text-2xl font-semibold text-blue-700 mb-3 border-b border-blue-200 pb-2 capitalize dark:text-blue-400 dark:border-blue-700">
            ${categoria}
          </h3>
          <ul class="divide-y divide-gray-200 dark:divide-gray-700 mb-3">
            ${prodottiHtml}
          </ul>
          <div class="text-right font-bold text-gray-800 text-lg border-t border-gray-300 pt-2 dark:text-gray-100 dark:border-gray-600">
            Totale Categoria: ${formatCurrency(costoCategoria)}
          </div>
        </section>`;
        
        costoTotaleInventario += costoCategoria;
      }
      
      const totalHtml = `
        <div class="bg-gray-200 p-4 rounded-lg mb-8 dark:bg-gray-700">
          <h2 class="text-xl md:text-2xl font-bold text-gray-900 text-center dark:text-gray-100">
            Valore Totale Inventario:
            <span class="text-green-700 dark:text-green-400">${formatCurrency(costoTotaleInventario)}</span>
          </h2>
        </div>
      `;
      
      costReportContainer.innerHTML = totalHtml + html;
    }
    
    function formatCurrency(value) {
      return (value || 0).toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
    }
    
    function renderBadge() {
        const grouped = getShoppingListGrouped();
        const totalItems = Array.from(grouped.values()).reduce((acc, prodotti) => acc + prodotti.length, 0);
        
        if (totalItems > 0) {
            shoppingListBadge.textContent = totalItems;
            shoppingListBadge.classList.remove('hidden');
        } else {
            shoppingListBadge.classList.add('hidden');
        }
    }
    
    // --- FUNZIONI DARK MODE (Invariate) ---
    
    function applyTheme(theme) {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            localStorage.setItem(THEME_KEY, 'dark');
            themeToggle.checked = true;
        } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem(THEME_KEY, 'light');
            themeToggle.checked = false;
        }
    }
    
    function initTheme() {
        const savedTheme = localStorage.getItem(THEME_KEY);
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark') {
            applyTheme('dark');
        } else if (savedTheme === 'light') {
            applyTheme('light');
        } else if (prefersDark) {
            applyTheme('dark'); 
        } else {
            applyTheme('light'); 
        }
    }

    // --- EVENT LISTENERS (Invariati) ---

    btnGoHome.addEventListener('click', () => {
      state.currentView = 'home';
      render();
    });
    btnGoInventario.addEventListener('click', () => {
      state.currentView = 'inventario';
      render();
    });
    btnGoListaSpesa.addEventListener('click', () => {
      state.currentView = 'listaSpesa';
      render();
    });
    btnGoCosti.addEventListener('click', () => {
      state.currentView = 'costi';
      render();
    });
    navInventario.addEventListener('click', () => {
      state.currentView = 'inventario';
      render();
    });
    navListaSpesa.addEventListener('click', () => {
      state.currentView = 'listaSpesa';
      render();
    });
    
    copyShoppingListBtn.addEventListener('click', copiaListaSpesa);

    filtersDropdown.addEventListener('click', (e) => {
        let changed = false;
        if (e.target.id === 'group-categoria') {
            state.groupBy = 'categoria';
            changed = true;
        }
        if (e.target.id === 'group-fornitore') {
            state.groupBy = 'fornitore';
            changed = true;
        }
        if (e.target.id === 'view-compatta') {
            state.inventoryViewMode = 'compatta';
            changed = true;
        }
        if (e.target.id === 'view-completa') {
            state.inventoryViewMode = 'completa';
            changed = true;
        }
        
        if(changed) {
            render();
            filtersDropdown.classList.add('hidden');
        }
    });

    addProductForm.addEventListener('submit', aggiungiProdotto);

    document.body.addEventListener('click', (e) => {
      const removeButton = e.target.closest('.remove-btn');
      if (removeButton) {
        const id = removeButton.dataset.id;
        if (confirm("Sei sicuro di voler eliminare questo prodotto?")) {
          rimuoviProdotto(id);
        }
        return; 
      }
      
      const increaseButton = e.target.closest('.qty-increase');
      if (increaseButton) {
        const id = increaseButton.dataset.id;
        updateProductQuantity(id, 1);
        return;
      }
      
      const decreaseButton = e.target.closest('.qty-decrease');
      if (decreaseButton) {
        const id = decreaseButton.dataset.id;
        updateProductQuantity(id, -1);
        return;
      }
      
      if (!filtersDropdown.classList.contains('hidden') && !toggleFiltersBtn.contains(e.target) && !filtersDropdown.contains(e.target)) {
        filtersDropdown.classList.add('hidden');
      }
    });
    
    document.body.addEventListener('focusout', (e) => {
        if (e.target.classList.contains('editable-input')) {
            const { id, field } = e.target.dataset;
            // Trova il prodotto nello stato locale per confronto
            const product = state.products.find(p => p.id === id);
            if(product && product[field] != e.target.value) {
                updateProductField(id, field, e.target.value);
            }
        }
    });

    showAddFormBtn.addEventListener('click', () => {
      formModalOverlay.classList.remove('hidden');
    });
    closeFormModalBtn.addEventListener('click', () => {
      formModalOverlay.classList.add('hidden');
    });
    formModalOverlay.addEventListener('click', (e) => {
      if (e.target === formModalOverlay) {
        formModalOverlay.classList.add('hidden');
      }
    });
    toggleFiltersBtn.addEventListener('click', (e) => {
      e.stopPropagation(); 
      filtersDropdown.classList.toggle('hidden');
    });
    
    themeToggle.addEventListener('change', (e) => {
        if (e.target.checked) {
            applyTheme('dark');
        } else {
            applyTheme('light');
        }
    });


    // --- INIZIALIZZAZIONE FIREBASE ---
    
    async function initApp() {
      initTheme(); // Inizializza il tema subito

      try {
        const app = initializeApp(firebaseConfig);
        state.db = getFirestore(app);
        state.auth = getAuth(app);
        
        // Collezione di riferimento
        state.collectionRef = collection(state.db, `inventario/${GRUPPO_ID}/prodotti`);

        // Autenticazione anonima
        await signInAnonymously(state.auth);
        
        // Imposta il listener per i dati
        onSnapshot(state.collectionRef, (snapshot) => {
          state.products = [];
          snapshot.forEach((doc) => {
            state.products.push({ id: doc.id, ...doc.data() });
          });
          
          // Nascondi il loading solo dopo il primo caricamento
          if (!loadingOverlay.classList.contains('hidden')) {
             loadingOverlay.classList.add('hidden');
          }
          
          render(); // Ridisegna tutto con i nuovi dati
        }, (error) => {
          console.error("Errore onSnapshot: ", error);
          loadingOverlay.innerHTML = `<span class="text-red-400 text-lg font-medium p-4 text-center">Errore di caricamento dati.<br>Controlla le Regole di Sicurezza di Firebase.</span>`;
        });

      } catch (err) {
        console.error("Errore inizializzazione Firebase: ", err);
        
        // MODIFICA: Controlla l'errore specifico e mostra un messaggio chiaro
        if (err.code === 'auth/configuration-not-found') {
           loadingOverlay.innerHTML = `<span class="text-red-400 text-lg font-medium p-4 text-center">
            <strong>ERRORE: Autenticazione Anonima NON ABILITATA.</strong><br><br>
            Azione richiesta:<br>
            1. Vai alla tua Console Firebase<br>
            2. Clicca su "Authentication"<br>
            3. Vai alla scheda "Sign-in method"<br>
            4. Clicca su "Anonimo" e Abilitalo.
           </span>`;
        } else {
           loadingOverlay.innerHTML = `<span class="text-red-400 text-lg font-medium p-4 text-center">Errore di connessione.<br>Controlla la configurazione di Firebase e le Regole di Sicurezza.</span>`;
        }
      }
    }
    
    // Avvia l'app
    initApp();

  </script>
</body>
</html>

