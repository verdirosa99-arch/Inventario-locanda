<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Inventario (Firebase)</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.js"></script>
  
  <!-- 1. Carica Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Stili CSS (invariati) */
    input[type='number']::-webkit-inner-spin-button,
    input[type='number']::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type='number'] {
      -moz-appearance: textfield;
    }

    /* Stili per il bordo di stato */
    .status-border-red {
      border-left: 5px solid #EF4444; /* red-500 */
    }
    .status-border-yellow {
      border-left: 5px solid #F59E0B; /* amber-500 */
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans dark:bg-gray-900">

  <!-- Overlay di caricamento -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center z-[999]">
    <svg class="animate-spin h-10 w-10 text-white mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <span class="text-white text-lg font-medium">Caricamento dati...</span>
  </div>

  <!-- Contenitore Custom Alert -->
  <div id="custom-alert" class="fixed top-5 right-5 z-[1000] p-4 rounded-lg shadow-lg max-w-sm hidden animate-pulse">
    <div class="flex items-start">
      <div id="custom-alert-icon" class="flex-shrink-0">
        <!-- Icona (cambia con JS) -->
      </div>
      <div class="ml-3 w-0 flex-1 pt-0.5">
        <p id="custom-alert-title" class="text-sm font-semibold"></p>
        <p id="custom-alert-message" class="mt-1 text-sm"></p>
      </div>
      <div class="ml-4 flex-shrink-0 flex">
        <button id="custom-alert-close-btn" class="inline-flex rounded-md p-1.5 focus:outline-none focus:ring-2 focus:ring-offset-2">
          <span class="sr-only">Chiudi</span>
          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>
    </div>
  </div>


  <div class="max-w-7xl mx-auto">
    
    <!-- Intestazione e Navigazione Viste -->
    <header class="mb-6">
      <div class="flex justify-between items-center">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-gray-100">Gestione Inventario</h1>
        <div class="flex items-center space-x-4">
          <!-- Pulsante Home -->
          <button id="btn-go-home" class="hidden text-gray-500 hover:text-blue-600 transition-colors dark:text-gray-400 dark:hover:text-blue-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
            </svg>
          </button>
          
        </div>
      </div>

      <!-- Wrapper per le schede di navigazione -->
      <nav id="main-nav-tabs" class="flex flex-wrap gap-2 mt-4 hidden">
        <button id="nav-inventario"
          class="px-3 py-2 md:px-4 text-sm md:text-base rounded-lg font-semibold shadow-md transition-all duration-200 bg-blue-600 text-white">
          Inventario
        </button>
        <button id="nav-listaSpesa"
          class="px-3 py-2 md:px-4 text-sm md:text-base rounded-lg font-semibold shadow-md transition-all duration-200 bg-white text-gray-700 dark:bg-gray-700 dark:text-gray-200">
          Lista Spesa
          <span id="shopping-list-badge" class="ml-2 bg-red-500 text-white text-xs font-bold rounded-full px-2 py-1 hidden">
          </span>
        </button>
        <!-- NUOVO: Pulsante Navigazione Cantina Aggiunto -->
        <button id="nav-cantina"
          class="px-3 py-2 md:px-4 text-sm md:text-base rounded-lg font-semibold shadow-md transition-all duration-200 bg-white text-gray-700 dark:bg-gray-700 dark:text-gray-200">
          Cantina Vini
        </button>
         <!-- NUOVO: Pulsante Report Vini -->
        <button id="nav-report-vini"
          class="px-3 py-2 md:px-4 text-sm md:text-base rounded-lg font-semibold shadow-md transition-all duration-200 bg-white text-gray-700 dark:bg-gray-700 dark:text-gray-200">
          Report Vini
        </button>
      </nav>
    </header>

    <!-- Sezione Viste -->
    <main>
      
      <!-- VISTA: Home -->
      <div id="view-home">
        <h2 class="text-2xl font-semibold text-gray-700 mb-6 dark:text-gray-200">Menu Principale</h2>
        <!-- MODIFICATO: grid-cols-2 per un layout bilanciato -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          <!-- Bottone Inventario -->
          <button id="btn-go-inventario" class="flex flex-col items-center justify-center bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow text-center dark:bg-gray-800 dark:hover:shadow-lg dark:hover:shadow-gray-700/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-600 dark:text-blue-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
            </svg>
            <span class="text-xl font-semibold text-gray-800 dark:text-gray-100">Inventario</span>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Gestisci e aggiungi prodotti</p>
          </button>
          
          <!-- Bottone Lista Spesa -->
          <button id="btn-go-listaspesa" class="flex flex-col items-center justify-center bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow text-center dark:bg-gray-800 dark:hover:shadow-lg dark:hover:shadow-gray-700/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500 dark:text-red-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span class="text-xl font-semibold text-gray-800 dark:text-gray-100">Lista Spesa</span>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Vedi i prodotti da ordinare</p>
          </button>
          
          <!-- Bottone Report Costi -->
          <button id="btn-go-costi" class="flex flex-col items-center justify-center bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow text-center dark:bg-gray-800 dark:hover:shadow-lg dark:hover:shadow-gray-700/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-600 dark:text-green-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span class="text-xl font-semibold text-gray-800 dark:text-gray-100">Report Inventario</span>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Valore inventario prodotti</p>
          </button>

          <!-- NUOVO: Bottone Cantina Vini -->
          <button id="btn-go-cantina" class="flex flex-col items-center justify-center bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow text-center dark:bg-gray-800 dark:hover:shadow-lg dark:hover:shadow-gray-700/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-purple-600 dark:text-purple-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h6m-6 4h6m-6 4h6" />
            </svg>
            <span class="text-xl font-semibold text-gray-800 dark:text-gray-100">Cantina Vini</span>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Gestisci la tua cantina</p>
          </button>
          
          <!-- NUOVO: Bottone Report Vini -->
          <button id="btn-go-report-vini" class="flex flex-col items-center justify-center bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow text-center dark:bg-gray-800 dark:hover:shadow-lg dark:hover:shadow-gray-700/50">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-indigo-600 dark:text-indigo-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2z" />
            </svg>
            <span class="text-xl font-semibold text-gray-800 dark:text-gray-100">Report Vini</span>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Valore e margini cantina</p>
          </button>

        </div>

        <!-- Bottoni CSV (rimangono full-width) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Bottone Carica CSV -->
          <div class="md:col-span-3 mt-4">
             <button id="btn-show-csv-upload" class="flex w-full items-center justify-center bg-gray-600 text-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow text-center dark:bg-gray-700 dark:hover:shadow-lg dark:hover:shadow-gray-600/50">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-100 mb-3 md:mb-0 md:mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h10a4 4 0 014 4v5a4 4 0 01-4 4H7zM7 16V7m0 9v5m0-5h10m0 0v5m0-5V7" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 16h10" />
              </svg>
              <div class="text-left">
                <!-- TESTO MODIFICATO -->
                <span class="text-xl font-semibold text-white">Importa CSV Inventario</span>
                <p class="text-sm text-gray-300 mt-1">Carica un file .csv con 'nome', 'categoria', 'fornitore'. Evita duplicati.</p>
              </div>
            </button>
            <input type="file" id="csv-file-input" accept=".csv" class="hidden">
          </div>

          <!-- NUOVO: Bottone Carica CSV Vini -->
          <div class="md:col-span-3 mt-4">
             <button id="btn-show-csv-upload-vini" class="flex w-full items-center justify-center bg-purple-600 text-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow text-center dark:bg-purple-700 dark:hover:shadow-lg dark:hover:shadow-gray-600/50">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-100 mb-3 md:mb-0 md:mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h10a4 4 0 014 4v5a4 4 0 01-4 4H7zM7 16V7m0 9v5m0-5h10m0 0v5m0-5V7" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 16h10" />
              </svg>
              <div class="text-left">
                <span class="text-xl font-semibold text-white">Importa CSV Vini</span>
                <p class="text-sm text-gray-300 mt-1">Carica un file .csv con 'nome', 'anno', 'cantina', 'regione', 'costo', 'vendita', 'quantita'.</p>
              </div>
            </button>
            <input type="file" id="csv-file-input-vini" accept=".csv" class="hidden">
          </div>

          <!-- Bottone Esporta CSV (NUOVO) -->
          <div class="md:col-span-3 mt-4">
             <button id="btn-export-csv" class="flex w-full items-center justify-center bg-green-600 text-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow text-center dark:bg-green-700 dark:hover:shadow-lg dark:hover:shadow-gray-600/50">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-100 mb-3 md:mb-0 md:mr-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
              </svg>
              <div class="text-left">
                <span class="text-xl font-semibold text-white">Esporta Backup CSV</span>
                <p class="text-sm text-gray-300 mt-1">Salva una copia di backup di tutto l'inventario in un file .csv.</p>
              </div>
            </button>
          </div>
          
        </div>
      </div>
      
      <!-- VISTA: Inventario -->
      <div id="view-inventario" class="hidden">
        <div class="space-y-6">

          <!-- Barra di Ricerca -->
          <div class="relative">
            <input type="text" id="search-bar" placeholder="Cerca prodotto..." class="w-full px-4 py-3 pr-10 rounded-lg shadow-md border border-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-gray-100">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 absolute top-1/2 right-3 -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          
          <!-- Filtri Vista Inventario (MODIFICATO) -->
          <div class="relative">
            <!-- Pulsante per aprire il menu a tendina -->
            <button id="toggle-filters-btn" class="flex items-center space-x-2 bg-white px-4 py-2 rounded-lg shadow-md font-medium text-gray-700 hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
              <!-- Icona "Sliders" (MODIFICATA) -->
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 dark:text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-1.57 2.106A1.532 1.532 0 013.17 7.49c-1.56.38-1.56 2.6 0 2.98a1.532 1.532 0 01.948 2.286c-.836 1.372.734 2.942 2.106 1.57A1.532 1.532 0 017.49 16.83c.38 1.56 2.6 1.56 2.98 0a1.532 1.532 0 012.286-.948c1.372.836 2.942-.734 1.57-2.106A1.532 1.532 0 0116.83 12.51c1.56-.38 1.56-2.6 0-2.98a1.532 1.532 0 01-.948-2.286c.836-1.372-.734-2.942-2.106-1.57A1.532 1.532 0 0112.51 3.17zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
              </svg>
              <span>Opzioni Vista</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 dark:text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
      
            <!-- Contenitore del menu a tendina (MODIFICATO) -->
            <div id="filters-dropdown" class="absolute top-full left-0 mt-2 bg-white rounded-lg shadow-xl p-4 z-30 hidden w-full md:w-auto dark:bg-gray-800 dark:border dark:border-gray-700">
              <div class="flex flex-col md:flex-row gap-6">
                
                <!-- Sezione Vista -->
                <div>
                  <span class="font-medium text-gray-700 block mb-2 dark:text-gray-200">Vista:</span>
                  <div class="flex flex-col sm:flex-row gap-2">
                    <button id="view-compatta" class="px-3 py-1 rounded-md text-sm font-medium bg-blue-500 text-white">
                      Compatta
                    </button>
                    <button id="view-completa" class="px-3 py-1 rounded-md text-sm font-medium bg-white shadow-sm dark:bg-gray-600 dark:text-gray-200">
                      Completa
                    </button>
                  </div>
                </div>

                <!-- NUOVA Sezione Ordinamento -->
                <div>
                  <span class="font-medium text-gray-700 block mb-2 dark:text-gray-200">Ordina per:</span>
                  <select id="sort-by-select" class="bg-white border border-gray-300 rounded-md shadow-sm p-2 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="nome-asc">Nome (A-Z)</option>
                    <option value="nome-desc">Nome (Z-A)</option>
                    <option value="carenza-desc">Carenza (Più urgenti)</option>
                    <option value="costo-desc">Costo (Decrescente)</option>
                    <option value="costo-asc">Costo (Crescente)</option>
                  </select>
                </div>

              </div>
            </div>
          </div>


          <!-- Lista Prodotti Inventario -->
          <div id="inventory-list-container" class="space-y-3">
            <!-- Contenuto generato da JS -->
            <p id="no-products-message" class="text-center text-gray-500 dark:text-gray-400 py-10 text-lg hidden">
              Nessun prodotto nell'inventario.
            </p>
            <p id="no-search-results-message" class="text-center text-gray-500 dark:text-gray-400 py-10 text-lg hidden">
              Nessun prodotto trovato.
            </p>
          </div>
        </div>
      </div>

      <!-- VISTA: Lista Spesa (RIPRISTINATA) -->
      <div id="view-listaSpesa" class="hidden">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md dark:bg-gray-800">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100">Lista della Spesa</h2>
            <!-- Pulsante Copia -->
            <button id="copy-shopping-list-btn" class="mt-4 md:mt-0 flex items-center justify-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-200 font-semibold dark:hover:bg-blue-500">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
              <span>Copia Lista per Fornitori</span>
            </button>
          </div>
          <div id="shopping-list-container" class="space-y-8">
            <!-- Contenuto generato da JS -->
          </div>
        </div>
      </div>
      
      <!-- VISTA: Report Costi (RIPRISTINATA) -->
      <div id="view-costi" class="hidden">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md dark:bg-gray-800">
          <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 dark:text-gray-100">Report Valore Inventario</h2>
          <div id="cost-report-container" class="space-y-8">
            <!-- Contenuto generato da JS -->
          </div>
        </div>
      </div>

      <!-- NUOVA VISTA: Cantina Vini -->
      <div id="view-cantina" class="hidden">
        <div class="space-y-6">

          <!-- Barra di Ricerca Vini -->
          <div class="relative">
            <input type="text" id="search-bar-vini" placeholder="Cerca per nome, anno, cantina, regione..." class="w-full px-4 py-3 pr-10 rounded-lg shadow-md border border-transparent focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-700 dark:text-gray-100">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 absolute top-1/2 right-3 -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>

          <!-- MODIFICATO: Lista Vini (Layout a Tendina) -->
          <!-- Rimosse le classi grid, aggiunto space-y-4 -->
          <div id="wine-list-container" class="space-y-4">
            <!-- Contenuto generato da JS (ora saranno le tendine) -->
            <p id="no-wines-message" class="text-center text-gray-500 dark:text-gray-400 py-10 text-lg hidden">
              Nessun vino nella cantina.
            </p>
            <p id="no-search-results-wines-message" class="text-center text-gray-500 dark:text-gray-400 py-10 text-lg hidden">
              Nessun vino trovato.
            </p>
          </div>
        </div>
      </div>
      
      <!-- NUOVA VISTA: Report Costi Vini -->
      <div id="view-report-vini" class="hidden">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-md dark:bg-gray-800">
          <button id="btn-scarica-pdf-vini" 
        class="mb-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200">
  Scarica Report PDF Completo
</button>
          <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 dark:text-gray-100">Report Costi e Margini Cantina</h2>
          <div id="wine-cost-report-container" class="space-y-8">
            <!-- Contenuto generato da JS -->
          </div>
        </div>
      </div>

    </main>

  </div>

  <!-- ================== Pulsante Flottante + (Inventario) ================== -->
  <button id="open-form-modal-btn" class="fixed bottom-6 right-6 md:bottom-10 md:right-10 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition-all duration-200 z-30">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
    </svg>
  </button>

  <!-- ================== NUOVO Pulsante Flottante + (Cantina) ================== -->
  <button id="open-wine-modal-btn" class="fixed bottom-6 right-6 md:bottom-10 md:right-10 bg-purple-600 text-white p-4 rounded-full shadow-lg hover:bg-purple-700 transition-all duration-200 z-30 hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
    </svg>
  </button>

  <!-- ================== Modale Form Aggiungi Prodotto ================== -->
  <div id="form-modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-40 hidden">
    
    <!-- Contenuto Modale -->
    <div class="bg-white p-4 md:p-6 rounded-lg shadow-md w-full max-w-4xl relative max-h-[90vh] overflow-y-auto dark:bg-gray-800">
      
      <!-- Pulsante Chiudi Modale -->
      <button id="close-form-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 z-10 dark:hover:text-gray-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <!-- Form Aggiungi Prodotto -->
      <h2 class="text-xl md:text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Aggiungi Nuovo Prodotto</h2>
      
      <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Colonna 1 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 dark:text-gray-300">Nome Prodotto</label>
          <input type="text" id="new-nome" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" required>
        </div>
        
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 dark:text-gray-300">Categoria</label>
          <input type="text" id="new-categoria" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" required>
        </div>

        <!-- Colonna 2 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 dark:text-gray-300">Fornitore</label>
          <input type="text" id="new-fornitore" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" required>
        </div>
        
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 dark:text-gray-300">Costo per Unità (€)</label>
          <input type="number" id="new-costo" min="0" step="0.01" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" placeholder="0.00">
        </div>

        <!-- Colonna 3 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 dark:text-gray-300">Unità</label>
          <select id="new-unita" class="border rounded-md p-2 w-full shadow-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" required>
            <option value="pz">pz</option>
            <option value="kg">kg</option>
            <option value="gr">gr</option>
            <option value="ct">ct</option>
            <option value="lt">lt</option>
            <option value="cl">cl</option>
            <option value="ml">ml</option>
          </select>
        </div>

        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 dark:text-gray-300">Q.tà Attuale</label>
          <!-- MODIFICATO: step="any" per decimali -->
          <input type="number" id="new-quantita" min="0" step="any" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" placeholder="0" required>
        </div>
        
        <!-- Colonna 4 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 dark:text-gray-300">Q.tà Minima</label>
          <!-- MODIFICATO: step="any" per decimali -->
          <input type="number" id="new-quantitaMinima" min="0" step="any" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" placeholder="0" required>
        </div>

        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 dark:text-gray-300">Stato</label>
          <select id="new-stato" class="border rounded-md p-2 w-full shadow-sm bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" required>
            <option value="Disponibile">Disponibile</option>
            <option value="Non Necessario">Non Necessario</option>
            <option value="Confezione Aperta">Confezione Aperta</option>
          </select>
        </div>

        <!-- Pulsante Submit -->
        <div class="md:col-span-2 lg:col-span-4 flex justify-end mt-4">
          <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-200 font-semibold">
            Aggiungi Prodotto
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ================== NUOVO Modale Form Aggiungi Vino ================== -->
  <div id="wine-modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-40 hidden">
    
    <!-- Contenuto Modale -->
    <div class="bg-white p-4 md:p-6 rounded-lg shadow-md w-full max-w-2xl relative max-h-[90vh] overflow-y-auto dark:bg-gray-800">
      
      <!-- Pulsante Chiudi Modale -->
      <button id="close-wine-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 z-10 dark:hover:text-gray-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <!-- Form Aggiungi Vino -->
      <h2 class="text-xl md:text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Aggiungi Nuovo Vino</h2>
      
      <form id="add-wine-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        
        <div class="flex flex-col md:col-span-2">
          <label class="mb-1 font-medium text-gray-600 dark:text-gray-300">Nome Vino (Etichetta)</label>
          <input type="text" id="new-vino-nome" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" required>
        </div>
        
        <!-- NUOVI CAMPI -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 dark:text-gray-300">Cantina (Produttore)</label>
          <input type="text" id="new-vino-cantina" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" placeholder="Es. Gaja">
        </div>
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 dark:text-gray-300">Regione</label>
          <input type="text" id="new-vino-regione" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" placeholder="Es. Piemonte">
        </div>
        <!-- FINE NUOVI CAMPI -->

        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 dark:text-gray-300">Anno</label>
          <input type="number" id="new-vino-anno" min="1900" max="2100" step="1" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" placeholder="Es. 2020" required>
        </div>

        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 dark:text-gray-300">Quantità (Bottiglie)</label>
          <input type="number" id="new-vino-quantita" min="0" step="1" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" placeholder="0" required>
        </div>
        
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 dark:text-gray-300">Costo Acquisto (€)</label>
          <input type="number" id="new-vino-costo" min="0" step="0.01" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" placeholder="0.00" required>
        </div>

        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 dark:text-gray-300">Prezzo Vendita (€)</label>
          <input type="number" id="new-vino-vendita" min="0" step="0.01" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" placeholder="0.00" required>
        </div>

        <!-- Pulsante Submit -->
        <div class="md:col-span-2 flex justify-end mt-4">
          <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-purple-700 transition-all duration-200 font-semibold">
            Aggiungi Vino
          </button>
        </div>
      </form>
    </div>
  </div>


  <!-- ================== Inizio Script JS ================== -->
  <script type="module">
    // --- VERSIONE SCRIPT: 2.4 (Cantina a tendina + Report Vini) ---

    // 2. Importa le funzioni di Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getFirestore, doc, getDoc, setDoc, onSnapshot, collection, 
      query, where, addDoc, getDocs, updateDoc, deleteDoc, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { 
      getAuth, signInAnonymously, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    // --- Passaggio 1: Configurazione Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyDWS8urdhG9RdS62rihj0FBPV38aWUclGQ",
      authDomain: "inventario-a52a4.firebaseapp.com",
      projectId: "inventario-a52a4",
      storageBucket: "inventario-a52a4.firebasestorage.app",
      messagingSenderId: "531426475103",
      appId: "1:531426475103:web:9a3c9b74547fd19a0a6fea",
      measurementId: "G-8HSKSW2Q86"
    };

    // --- Passaggio 2: ID Gruppo Condiviso ---
    const GRUPPO_ID = "inventario-segreto-123";

    // --- Variabili Globali ---
    let db, auth;
    let unsubscribeProducts = null; // Funzione per staccare il listener
    let unsubscribeWines = null; // NUOVO: Listener per i vini
    let currentUserId = null; // UID dell'utente anonimo

    // Stato dell'applicazione
    const state = {
      products: [],         // Array di tutti i prodotti
      vini: [],             // NUOVO: Array di tutti i vini
      view: 'home',         // 'home', 'inventario', 'listaSpesa', 'costi', 'cantina', 'reportVini'
      groupBy: 'categoria', 
      inventoryView: 'compatta', // 'compatta', 'completa'
      shoppingListManual: {}, // Prodotti aggiunti/rimossi manually { id: 'add'/'remove' }
      searchTerm: '',         // Termine di ricerca
      searchTermVini: '',   // NUOVO: Termine di ricerca per i vini
      sortBy: 'nome-asc',   // NUOVO: Criterio di ordinamento
      expandedRegions: new Set(), // NUOVO: Per lo stato tendina della cantina
    };

    // Selettori Elementi DOM (raggruppati per comodità)
    const dom = {
      loadingOverlay: document.getElementById('loading-overlay'),
      customAlert: {
        element: document.getElementById('custom-alert'),
        icon: document.getElementById('custom-alert-icon'),
        title: document.getElementById('custom-alert-title'),
        message: document.getElementById('custom-alert-message'),
        closeBtn: document.getElementById('custom-alert-close-btn'),
      },
      header: {
        goHomeBtn: document.getElementById('btn-go-home'),
        navTabs: document.getElementById('main-nav-tabs'),
        navInventario: document.getElementById('nav-inventario'),
        navListaSpesa: document.getElementById('nav-listaSpesa'),
        navCantina: document.getElementById('nav-cantina'), // NUOVO
        navReportVini: document.getElementById('nav-report-vini'), // NUOVO
        shoppingListBadge: document.getElementById('shopping-list-badge'),
      },
      views: {
        home: document.getElementById('view-home'),
        inventario: document.getElementById('view-inventario'),
        listaSpesa: document.getElementById('view-listaSpesa'),
        costi: document.getElementById('view-costi'),
        cantina: document.getElementById('view-cantina'), // NUOVO
        reportVini: document.getElementById('view-report-vini'), // NUOVO
      },
      home: {
        goInventario: document.getElementById('btn-go-inventario'),
        goListaSpesa: document.getElementById('btn-go-listaspesa'),
        goCosti: document.getElementById('btn-go-costi'),
        goCantina: document.getElementById('btn-go-cantina'), // NUOVO
        goReportVini: document.getElementById('btn-go-report-vini'), // NUOVO
        showCsvUpload: document.getElementById('btn-show-csv-upload'),
        csvFileInput: document.getElementById('csv-file-input'),
        showCsvUploadVini: document.getElementById('btn-show-csv-upload-vini'), // NUOVO
        csvFileInputVini: document.getElementById('csv-file-input-vini'), // NUOVO
        btnExportCsv: document.getElementById('btn-export-csv'), // NUOVO
      },
      inventario: {
        searchBar: document.getElementById('search-bar'),
        toggleFiltersBtn: document.getElementById('toggle-filters-btn'),
        filtersDropdown: document.getElementById('filters-dropdown'),
        sortBySelect: document.getElementById('sort-by-select'), // NUOVO
        viewCompatta: document.getElementById('view-compatta'),
        viewCompleta: document.getElementById('view-completa'),
        listContainer: document.getElementById('inventory-list-container'),
        noProductsMsg: document.getElementById('no-products-message'),
        noSearchResultsMsg: document.getElementById('no-search-results-message'),
      },
      // NUOVO: Selettori Cantina
      cantina: {
        searchBar: document.getElementById('search-bar-vini'),
        listContainer: document.getElementById('wine-list-container'),
        noWinesMsg: document.getElementById('no-wines-message'),
        noSearchResultsWinesMsg: document.getElementById('no-search-results-wines-message'),
      },
      listaSpesa: {
        copyBtn: document.getElementById('copy-shopping-list-btn'),
        container: document.getElementById('shopping-list-container'),
      },
      costi: {
        container: document.getElementById('cost-report-container'),
      },
      // NUOVO: Selettori Report Vini
      reportVini: {
          container: document.getElementById('wine-cost-report-container'),
      },
      formModal: {
        overlay: document.getElementById('form-modal-overlay'),
        openBtn: document.getElementById('open-form-modal-btn'),
        closeBtn: document.getElementById('close-form-modal-btn'),
        form: document.getElementById('add-product-form'),
        inputs: {
          nome: document.getElementById('new-nome'),
          categoria: document.getElementById('new-categoria'),
          fornitore: document.getElementById('new-fornitore'),
          costo: document.getElementById('new-costo'),
          unita: document.getElementById('new-unita'),
          quantita: document.getElementById('new-quantita'),
          quantitaMinima: document.getElementById('new-quantitaMinima'),
          stato: document.getElementById('new-stato'),
        }
      },
      // NUOVO: Selettori Modale Vini
      wineModal: {
        overlay: document.getElementById('wine-modal-overlay'),
        openBtn: document.getElementById('open-wine-modal-btn'),
        closeBtn: document.getElementById('close-wine-modal-btn'),
        form: document.getElementById('add-wine-form'),
        inputs: {
          nome: document.getElementById('new-vino-nome'),
          anno: document.getElementById('new-vino-anno'),
          quantita: document.getElementById('new-vino-quantita'),
          costo: document.getElementById('new-vino-costo'),
          vendita: document.getElementById('new-vino-vendita'),
          // NUOVI
          cantina: document.getElementById('new-vino-cantina'),
          regione: document.getElementById('new-vino-regione'),
        }
      }
    };

    // --- FUNZIONI DI INIZIALIZZAZIONE ---

    /**
     * Inizializza l'app: Firebase, Auth, Listener e UI.
     */
    async function initApp() {
      try {
        // 1. Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // 2. Gestisci Autenticazione Anonima
        onAuthStateChanged(auth, (user) => {
          if (user) {
            // Utente già loggato
            currentUserId = user.uid;
            attachProductsListener(); // Avvia l'ascolto dei dati inventario
            attachWinesListener();  // NUOVO: Avvia l'ascolto dei vini
          } else {
            // Utente non loggato, prova a loggare
            signInAnonymously(auth).catch((error) => {
              console.error("Errore signInAnonymously:", error);
              if (error.code === 'auth/configuration-not-found') {
                showCustomAlert(
                  'Errore Configurazione Firebase', 
                  "L'accesso 'Anonimo' non è abilitato. Vai nella tua Console Firebase -> Authentication -> Sign-in method e abilita 'Anonimo'.", 
                  'error'
                );
              } else {
                showCustomAlert('Errore Autenticazione', error.message, 'error');
              }
            });
          }
        });

        // 3. Inizializza Listener UI
        initUIListeners();
        
      } catch (error) {
        console.error("Errore inizializzazione Firebase: ", error);
        showCustomAlert('Errore Critico', `Impossibile inizializzare Firebase: ${error.message}`, 'error');
        dom.loadingOverlay.style.display = 'none'; // Nascondi comunque il caricamento
      }
    }

    /**
     * Collega il listener a Firestore per aggiornamenti in tempo reale.
     */
    function attachProductsListener() {
      // Stacca il listener precedente se esiste
      if (unsubscribeProducts) {
        unsubscribeProducts();
      }
      
      const productsCollectionRef = collection(db, "inventari", GRUPPO_ID, "prodotti");
      
      // Ascolta la collezione
      unsubscribeProducts = onSnapshot(productsCollectionRef, (snapshot) => {
        state.products = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        dom.loadingOverlay.style.display = 'none'; // Nascondi overlay
        render(); // Ridisegna tutto

      }, (error) => {
        console.error("Errore in onSnapshot: ", error);
        showCustomAlert('Errore Database', `Impossibile caricare i dati: ${error.message}`, 'error');
        dom.loadingOverlay.style.display = 'none';
      });
    }

    /**
     * NUOVO: Collega il listener a Firestore per i VINI.
     */
    function attachWinesListener() {
      if (unsubscribeWines) {
        unsubscribeWines();
      }
      
      const winesCollectionRef = collection(db, "inventari", GRUPPO_ID, "vini");
      
      unsubscribeWines = onSnapshot(winesCollectionRef, (snapshot) => {
        state.vini = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Ordina alfabeticamente di default (verrà ri-ordinato nel render se serve)
        state.vini.sort((a, b) => a.nome.localeCompare(b.nome));
        render(); // Ridisegna tutto

      }, (error) => {
        console.error("Errore in onSnapshot (Vini): ", error);
        showCustomAlert('Errore Database Vini', `Impossibile caricare i vini: ${error.message}`, 'error');
      });
    }

    /**
     * Aggiunge tutti i listener per i pulsanti e gli input.
     */
    function initUIListeners() {
      // Navigazione Viste
      dom.header.navInventario.addEventListener('click', () => updateState({ view: 'inventario' }));
      dom.header.navListaSpesa.addEventListener('click', () => updateState({ view: 'listaSpesa' }));
      dom.header.navCantina.addEventListener('click', () => updateState({ view: 'cantina' })); // NUOVO
      dom.header.navReportVini.addEventListener('click', () => updateState({ view: 'reportVini' })); // NUOVO
      dom.header.goHomeBtn.addEventListener('click', () => updateState({ view: 'home' }));
      
      dom.home.goInventario.addEventListener('click', () => updateState({ view: 'inventario' }));
      dom.home.goListaSpesa.addEventListener('click', () => updateState({ view: 'listaSpesa' }));
      dom.home.goCosti.addEventListener('click', () => updateState({ view: 'costi' }));
      dom.home.goCantina.addEventListener('click', () => updateState({ view: 'cantina' })); // NUOVO
      dom.home.goReportVini.addEventListener('click', () => updateState({ view: 'reportVini' })); // NUOVO

      // CSV Upload / Export
      dom.home.showCsvUpload.addEventListener('click', () => dom.home.csvFileInput.click());
      dom.home.csvFileInput.addEventListener('change', handleCsvUpload);
      dom.home.btnExportCsv.addEventListener('click', handleExportCSV); // NUOVO
      
      // NUOVI LISTENER PER CSV VINI
      dom.home.showCsvUploadVini.addEventListener('click', () => dom.home.csvFileInputVini.click());
      dom.home.csvFileInputVini.addEventListener('change', handleWineCsvUpload);

      // Ricerca
      dom.inventario.searchBar.addEventListener('input', (e) => {
        updateState({ searchTerm: e.target.value });
      });

      // NUOVO: Ricerca Vini
      dom.cantina.searchBar.addEventListener('input', (e) => {
        // Quando cerco, resetto le tendine per evitare confusione
        updateState({ searchTermVini: e.target.value, expandedRegions: new Set() });
      });

      // Filtri Inventario
      dom.inventario.toggleFiltersBtn.addEventListener('click', () => { 
        dom.inventario.filtersDropdown.classList.toggle('hidden');
      });
      // Chiudi dropdown se clicchi fuori
      document.addEventListener('click', (e) => {
        if (!dom.inventario.toggleFiltersBtn.contains(e.target) && !dom.inventario.filtersDropdown.contains(e.target)) {
          dom.inventario.filtersDropdown.classList.add('hidden');
        }
      });
      
      // NUOVO: Listener Ordinamento
      dom.inventario.sortBySelect.addEventListener('change', (e) => {
        updateState({ sortBy: e.target.value });
      });

      dom.inventario.viewCompatta.addEventListener('click', () => updateState({ inventoryView: 'compatta' }));
      dom.inventario.viewCompleta.addEventListener('click', () => updateState({ inventoryView: 'completa' }));

      // Modale Form
      dom.formModal.openBtn.addEventListener('click', () => {
        dom.formModal.overlay.classList.remove('hidden');
      });
      dom.formModal.closeBtn.addEventListener('click', closeFormModal);
      dom.formModal.overlay.addEventListener('click', (e) => {
        if (e.target === dom.formModal.overlay) {
          closeFormModal();
        }
      });
      dom.formModal.form.addEventListener('submit', handleAddProduct);

      // NUOVO: Modale Vini
      dom.wineModal.openBtn.addEventListener('click', () => {
        dom.wineModal.overlay.classList.remove('hidden');
      });
      dom.wineModal.closeBtn.addEventListener('click', closeWineModal);
      dom.wineModal.overlay.addEventListener('click', (e) => {
        if (e.target === dom.wineModal.overlay) {
          closeWineModal();
        }
      });
      dom.wineModal.form.addEventListener('submit', handleAddWine);

      // Lista Spesa
      dom.listaSpesa.copyBtn.addEventListener('click', copyShoppingListToClipboard);

      // Alert
      dom.customAlert.closeBtn.addEventListener('click', () => {
        dom.customAlert.element.classList.add('hidden');
      });
    }

    // --- FUNZIONI DI RENDER ---

    /**
     * Funzione principale di disegno. Chiamata ogni volta che lo stato cambia.
     */
    function render() {
      // 1. Render Viste (Home, Inventario, Lista, Costi)
      renderViews();
      
      // 2. Render Filtri (pulsanti attivi e select ordinamento)
      renderFilters();

      // 3. Render Contenuto Viste
      // Solo se la vista è quella attiva
      if (state.view === 'inventario') {
        renderInventoryList();
      }
      if (state.view === 'listaSpesa') {
        renderShoppingList();
      }
      if (state.view === 'costi') {
        renderCostReport();
      }
      if (state.view === 'cantina') {
        renderWineList(); // NUOVO
      }
      if (state.view === 'reportVini') {
        renderWineCostReport(); // NUOVO
      }
      
      // 4. Render Badge Lista Spesa
      const shoppingList = getShoppingList();
      if (shoppingList.length > 0) {
        dom.header.shoppingListBadge.textContent = shoppingList.length;
        dom.header.shoppingListBadge.classList.remove('hidden');
      } else {
        dom.header.shoppingListBadge.classList.add('hidden');
      }
    }

    /**
     * Mostra/Nasconde le viste principali (Home, Inventario, ecc.)
     */
    function renderViews() {
      dom.views.home.classList.add('hidden');
      dom.views.inventario.classList.add('hidden');
      dom.views.listaSpesa.classList.add('hidden');
      dom.views.costi.classList.add('hidden');
      dom.views.cantina.classList.add('hidden'); // NUOVO
      dom.views.reportVini.classList.add('hidden'); // NUOVO
      
      dom.header.navTabs.classList.add('hidden');
      dom.header.goHomeBtn.classList.add('hidden');
      dom.formModal.openBtn.classList.add('hidden'); // Nascondi + inventario
      dom.wineModal.openBtn.classList.add('hidden'); // NUOVO: Nascondi + vini

      if (state.view === 'home') {
        dom.views.home.classList.remove('hidden');
      } else {
        // Se non siamo in Home, mostra i tab e il pulsante Home
        dom.header.navTabs.classList.remove('hidden');
        dom.header.goHomeBtn.classList.remove('hidden');

        // Reset stato attivo tab
        dom.header.navInventario.classList.add('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
        dom.header.navInventario.classList.remove('bg-blue-600', 'text-white');
        dom.header.navListaSpesa.classList.add('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
        dom.header.navListaSpesa.classList.remove('bg-blue-600', 'text-white');
        dom.header.navCantina.classList.add('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
        dom.header.navCantina.classList.remove('bg-purple-600', 'text-white');
        dom.header.navReportVini.classList.add('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
        dom.header.navReportVini.classList.remove('bg-indigo-600', 'text-white'); // NUOVO
        
        if (state.view === 'inventario') {
          dom.views.inventario.classList.remove('hidden');
          dom.formModal.openBtn.classList.remove('hidden'); // Mostra + inventario
          // Stato attivo tab
          dom.header.navInventario.classList.add('bg-blue-600', 'text-white');
          dom.header.navInventario.classList.remove('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
        } else if (state.view === 'listaSpesa') {
          dom.views.listaSpesa.classList.remove('hidden');
          // Stato attivo tab
          dom.header.navListaSpesa.classList.add('bg-blue-600', 'text-white');
          dom.header.navListaSpesa.classList.remove('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
        } else if (state.view === 'costi') {
          dom.views.costi.classList.remove('hidden');
        } else if (state.view === 'cantina') {
          dom.views.cantina.classList.remove('hidden');
          dom.wineModal.openBtn.classList.remove('hidden'); // Mostra + vini
          // Stato attivo tab
          dom.header.navCantina.classList.add('bg-purple-600', 'text-white');
          dom.header.navCantina.classList.remove('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
        } else if (state.view === 'reportVini') { // NUOVO
          dom.views.reportVini.classList.remove('hidden');
          // Stato attivo tab
          dom.header.navReportVini.classList.add('bg-indigo-600', 'text-white');
          dom.header.navReportVini.classList.remove('bg-white', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
        }
      }
    }

    /**
     * Aggiorna lo stato attivo dei pulsanti filtro e select ordinamento.
     */
    function renderFilters() {
      // Filtri Vista
      const btnCompatta = dom.inventario.viewCompatta;
      const btnCompleta = dom.inventario.viewCompleta;
      
      if (state.inventoryView === 'compatta') {
        btnCompatta.classList.add('bg-blue-500', 'text-white');
        btnCompatta.classList.remove('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        btnCompleta.classList.add('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        btnCompleta.classList.remove('bg-blue-500', 'text-white');
      } else {
        btnCompleta.classList.add('bg-blue-500', 'text-white');
        btnCompleta.classList.remove('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        btnCompatta.classList.add('bg-white', 'shadow-sm', 'dark:bg-gray-600', 'dark:text-gray-200');
        btnCompatta.classList.remove('bg-blue-500', 'text-white');
      }

      // NUOVO: Imposta il valore corretto per la select di ordinamento
      dom.inventario.sortBySelect.value = state.sortBy;
    }

    /**
     * Disegna la lista dei prodotti nell'inventario.
     */
    function renderInventoryList() {
      const container = dom.inventario.listContainer;
      container.innerHTML = ''; // Pulisci lista

      // 1. Applica Ordinamento (NUOVO)
      const sortedProducts = sortProducts(state.products, state.sortBy);

      // 2. Filtra i prodotti in base alla ricerca
      const filteredProducts = sortedProducts.filter(p => 
        p.nome.toLowerCase().includes(state.searchTerm.toLowerCase())
      );
      
      // 3. Gestisci messaggi di "nessun prodotto"
      dom.inventario.noProductsMsg.classList.add('hidden');
      dom.inventario.noSearchResultsMsg.classList.add('hidden');

      if (state.products.length === 0) {
        dom.inventario.noProductsMsg.classList.remove('hidden');
        return;
      }

      if (filteredProducts.length === 0 && state.searchTerm) {
        dom.inventario.noSearchResultsMsg.classList.remove('hidden');
        return;
      }

      // 4. Disegna i prodotti filtrati
      filteredProducts.forEach(product => {
        const card = createProductCard(product);
        container.appendChild(card);
      });
    }

    /**
     * Crea il singolo elemento card per un prodotto.
     */
    function createProductCard(product) {
      const isCompatta = state.inventoryView === 'compatta';
      const div = document.createElement('div');
      
      // Logica Bordo Colorato
      const needsShopping = isProductInShoppingList(product, true); // true = controlla solo auto
      let borderColorClass = '';
      if (needsShopping) {
        if (product.stato === 'Disponibile') {
          borderColorClass = 'status-border-red'; // Rosso
        } else {
          borderColorClass = 'status-border-yellow'; // Giallo
        }
      }

      div.className = `product-card bg-white rounded-lg shadow-md overflow-hidden transition-all duration-200 dark:bg-gray-800 ${borderColorClass}`;
      
      // Contenuto HTML (Compatto o Completo)
      div.innerHTML = isCompatta 
        ? getCompattaCardHTML(product) 
        : getCompletaCardHTML(product);

      // Aggiungi Listener (per entrambe le viste)
      
      // Pulsanti +/- (solo vista compatta)
      if (isCompatta) {
        const btnMinus = div.querySelector('.btn-minus');
        const btnPlus = div.querySelector('.btn-plus');
        
        btnMinus.addEventListener('click', (e) => {
          e.preventDefault(); // MODIFICA: previene zoom mobile
          e.stopPropagation(); 
          let newQuantita = (parseFloat(product.quantita) || 0) - 1;
          if (newQuantita < 0) newQuantita = 0;
          handleProductUpdate(product.id, 'quantita', newQuantita);
        });

        btnPlus.addEventListener('click', (e) => {
          e.preventDefault(); // MODIFICA: previene zoom mobile
          e.stopPropagation();
          let newQuantita = (parseFloat(product.quantita) || 0) + 1;
          handleProductUpdate(product.id, 'quantita', newQuantita);
        });
      }

      // Input Modificabili
      // (Listener 'change' per salvare)
      const inputs = div.querySelectorAll('[data-field]');
      inputs.forEach(input => {
        input.addEventListener('change', (e) => {
          const field = e.target.dataset.field;
          let value = (e.target.type === 'number') ? parseFloat(e.target.value) : e.target.value;
          
          // Assicura che i numeri siano validi
          if (e.target.type === 'number' && isNaN(value)) {
            value = 0;
          }

          handleProductUpdate(product.id, field, value);
        });
        // Impedisci al click sull'input di propagarsi (es. per il +/-)
        input.addEventListener('click', e => e.stopPropagation());
      });
      
      // Pulsante Rimuovi
      const deleteBtn = div.querySelector('.delete-btn');
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        handleDeleteProduct(product.id, product.nome);
      });

      // Pulsante Lista Spesa Manuale
      const shopBtn = div.querySelector('.shop-list-btn');
      shopBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        handleManualShoppingList(product.id);
      });

      return div;
    }

    /**
     * Ritorna l'HTML per la card in Vista Compatta
     */
    function getCompattaCardHTML(product) {
      const statoBadge = getStatoBadge(product.stato);
      const shoppingBtnHTML = getShoppingButtonHTML(product);
      
      return `
        <div class="p-3">
          <div class="flex items-center justify-between">
            <!-- Info Prodotto (Sinistra) -->
            <div class="flex-1 min-w-0 mr-3">
              <div class="flex items-center">
                <input type="text" value="${product.nome}" data-field="nome" class="text-lg font-semibold text-gray-800 truncate bg-transparent focus:outline-none focus:ring-1 focus:ring-blue-500 rounded-md px-1 -ml-1 w-full dark:text-gray-100 dark:focus:bg-gray-700">
              </div>
              <div class="flex items-center space-x-2">
                ${statoBadge}
                <span class="text-sm text-gray-500 dark:text-gray-400">
                  Q.Min: ${product.quantitaMinima} ${product.unita}
                </span>
              </div>
            </div>
            
            <!-- Controlli Quantità (Destra) -->
            <div class="flex items-center space-x-2">
              <button class="btn-minus p-1 rounded-full bg-red-100 text-red-600 hover:bg-red-200 dark:bg-red-900/50 dark:text-red-300 dark:hover:bg-red-900">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
                </svg>
              </button>
              
              <!-- MODIFICATO: step="any" per decimali -->
              <input type="number" value="${product.quantita}" data-field="quantita" step="any" class="w-16 text-center text-lg font-bold border rounded-md p-1 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
              
              <button class="btn-plus p-1 rounded-full bg-green-100 text-green-600 hover:bg-green-200 dark:bg-green-900/50 dark:text-green-300 dark:hover:bg-green-900">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
              </button>

              ${shoppingBtnHTML}

              <button class="delete-btn p-1 text-gray-400 hover:text-red-500 ml-2 dark:hover:text-red-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    /**
     * Ritorna l'HTML per la card in Vista Completa
     */
    function getCompletaCardHTML(product) {
      const shoppingBtnHTML = getShoppingButtonHTML(product);

      return `
        <div class="p-4">
          <!-- Riga 1: Nome, Q.tà, Pulsanti -->
          <div class="flex items-center justify-between mb-3">
            <input type="text" value="${product.nome}" data-field="nome" class="text-xl font-semibold text-gray-800 truncate bg-transparent focus:outline-none focus:ring-1 focus:ring-blue-500 rounded-md px-1 -ml-1 w-full dark:text-gray-100 dark:focus:bg-gray-700">
            
            <div class="flex items-center space-x-3 ml-4">
              <div class="flex flex-col items-center">
                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Q.tà Attuale</label>
                <!-- MODIFICATO: step="any" per decimali -->
                <input type="number" value="${product.quantita}" data-field="quantita" step="any" class="w-20 text-center text-lg font-bold border rounded-md p-1 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
              </div>
              
              ${shoppingBtnHTML}
              
              <button class="delete-btn p-1 text-gray-400 hover:text-red-500 dark:hover:text-red-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </div>
          
          <!-- Riga 2: Tutti gli altri campi -->
          <!-- MODIFICATO: grid-cols-1 sm:grid-cols-2 per mobile -->
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
            
            <!-- Categoria -->
            <div class="flex flex-col">
              <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Categoria</label>
              <input type="text" value="${product.categoria}" data-field="categoria" class="text-sm border rounded-md p-1.5 shadow-sm w-full dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
            </div>

            <!-- Fornitore -->
            <div class="flex flex-col">
              <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Fornitore</label>
              <input type="text" value="${product.fornitore}" data-field="fornitore" class="text-sm border rounded-md p-1.5 shadow-sm w-full dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
            </div>

            <!-- Costo -->
            <div class="flex flex-col">
              <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Costo (€)</label>
              <input type="number" value="${product.costo}" data-field="costo" min="0" step="0.01" class="text-sm border rounded-md p-1.5 shadow-sm w-full dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
            </div>
            
            <!-- Unità -->
            <div class="flex flex-col">
              <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Unità</label>
              <select data-field="unita" class="text-sm border rounded-md p-1.5 shadow-sm w-full bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                <option value="pz" ${product.unita === 'pz' ? 'selected' : ''}>pz</option>
                <option value="kg" ${product.unita === 'kg' ? 'selected' : ''}>kg</option>
                <option value="gr" ${product.unita === 'gr' ? 'selected' : ''}>gr</option>
                <option value="ct" ${product.unita === 'ct' ? 'selected' : ''}>ct</option>
                <option value="lt" ${product.unita === 'lt' ? 'selected' : ''}>lt</option>
                <option value="cl" ${product.unita === 'cl' ? 'selected' : ''}>cl</option>
                <option value="ml" ${product.unita === 'ml' ? 'selected' : ''}>ml</option>
              </select>
            </div>
            
            <!-- Q.tà Minima -->
            <div class="flex flex-col">
              <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Q.tà Minima</label>
              <!-- MODIFICATO: step="any" per decimali -->
              <input type="number" value="${product.quantitaMinima}" data-field="quantitaMinima" min="0" step="any" class="text-sm border rounded-md p-1.5 shadow-sm w-full dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
            </div>

            <!-- Stato -->
            <div class="flex flex-col">
              <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Stato</label>
              <select data-field="stato" class="text-sm border rounded-md p-1.5 shadow-sm w-full bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                <option value="Disponibile" ${product.stato === 'Disponibile' ? 'selected' : ''}>Disponibile</option>
                <option value="Non Necessario" ${product.stato === 'Non Necessario' ? 'selected' : ''}>Non Necessario</option>
                <option value="Confezione Aperta" ${product.stato === 'Confezione Aperta' ? 'selected' : ''}>Confezione Aperta</option>
              </select>
            </div>
            
          </div>
        </div>
      `;
    }

    /**
     * Ritorna l'HTML per il badge di stato.
     */
    function getStatoBadge(stato) {
      if (stato === 'Non Necessario') {
        return `<span class="text-xs font-medium bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full dark:bg-gray-600 dark:text-gray-200">${stato}</span>`;
      }
      if (stato === 'Confezione Aperta') {
        return `<span class="text-xs font-medium bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full dark:bg-yellow-900/50 dark:text-yellow-300">${stato}</span>`;
      }
      return ''; // Default (Disponibile) non mostra nulla
    }
    
    /**
     * Ritorna l'HTML per il pulsante di aggiunta/rimozione dalla lista spesa
     */
    function getShoppingButtonHTML(product) {
      const isManual = state.shoppingListManual[product.id];
      const isAuto = isProductInShoppingList(product, true);

      if (isManual === 'add' || (isAuto && isManual !== 'remove')) {
        // È sulla lista (o forzato o auto non rimosso)
        let icon, text, color;
        if (isManual === 'add') {
          // Forzato manually
          icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-10.293a1 1 0 00-1.414-1.414L9 9.586 7.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
          text = "Rimuovi da Lista";
          color = "bg-yellow-100 text-yellow-700 hover:bg-yellow-200 dark:bg-yellow-900/50 dark:text-yellow-300 dark:hover:bg-yellow-900";
        } else {
          // Automatico
          icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>`;
          text = "Già in Lista";
          color = "bg-gray-100 text-gray-500 dark:bg-gray-700 dark:text-gray-400";
        }
        return `
          <button title="${text}" class="shop-list-btn p-2 rounded-full ${color} transition-all">
            ${icon}
          </button>
        `;
      } else {
        // Non è sulla lista (o è stato rimosso manually)
        let icon, text, color;
        if (isManual === 'remove') {
          // Rimosso manually
          icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>`;
          text = "Rimetti (annulla)";
          color = "bg-red-100 text-red-600 hover:bg-red-200 dark:bg-red-900/50 dark:text-red-300 dark:hover:bg-red-900";
        } else {
          // Default, non in lista
          icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
          text = "Aggiungi a Lista";
          color = "bg-green-100 text-green-600 hover:bg-green-200 dark:bg-green-900/50 dark:text-green-300 dark:hover:bg-green-900";
        }
        return `
          <button title="${text}" class="shop-list-btn p-2 rounded-full ${color} transition-all">
            ${icon}
          </button>
        `;
      }
    }
    
    /**
     * Disegna la lista della spesa, raggruppata per fornitore.
     */
    function renderShoppingList() {
      const container = dom.listaSpesa.container;
      const groupedList = getShoppingListGrouped();

      if (Object.keys(groupedList).length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-10 text-lg">
          La lista della spesa è vuota.
        </p>`;
        dom.listaSpesa.copyBtn.classList.add('hidden');
        return;
      }
      
      dom.listaSpesa.copyBtn.classList.remove('hidden');
      container.innerHTML = ''; // Pulisci

      Object.keys(groupedList).sort().forEach(fornitore => {
        const groupDiv = document.createElement('div');
        groupDiv.className = "mb-6";
        
        const title = document.createElement('h3');
        title.className = "text-xl font-semibold text-gray-700 border-b border-gray-300 pb-2 mb-3 dark:text-gray-200 dark:border-gray-700";
        title.textContent = fornitore;
        groupDiv.appendChild(title);
        
        const listUl = document.createElement('ul');
        listUl.className = "list-disc list-inside space-y-2";
        
        groupedList[fornitore].forEach(product => {
          const li = document.createElement('li');
          li.className = "text-gray-800 dark:text-gray-300";
          li.innerHTML = `
            <span class="font-medium">${product.nome}</span> 
            <span class="text-sm text-gray-600 dark:text-gray-400">
              (Q.tà: ${product.quantita} / Min: ${product.quantitaMinima} ${product.unita})
            </span>
          `;
          listUl.appendChild(li);
        });
        
        groupDiv.appendChild(listUl);
        container.appendChild(groupDiv);
      });
    }

    /**
     * Disegna il report dei costi.
     */
    function renderCostReport() {
      const container = dom.costi.container;
      
      // 1. Raggruppa prodotti per categoria
      const groupedByCategoria = state.products.reduce((acc, p) => {
        const categoria = p.categoria || 'Senza Categoria';
        if (!acc[categoria]) {
          acc[categoria] = [];
        }
        acc[categoria].push(p);
        return acc;
      }, {});
      
      if (state.products.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-10 text-lg">
          Nessun prodotto nell'inventario per calcolare i costi.
        </p>`;
        return;
      }

      container.innerHTML = ''; // Pulisci
      let granTotale = 0;

      // 2. Itera sulle categorie e crea le tabelle
      Object.keys(groupedByCategoria).sort().forEach(categoria => {
        const products = groupedByCategoria[categoria];
        let totaleCategoria = 0;
        
        const groupDiv = document.createElement('div');
        groupDiv.className = "mb-8";
        
        const title = document.createElement('h3');
        title.className = "text-xl font-semibold text-gray-700 border-b border-gray-300 pb-2 mb-3 dark:text-gray-200 dark:border-gray-700";
        title.textContent = categoria;
        groupDiv.appendChild(title);

        const table = document.createElement('table');
        table.className = "w-full min-w-full divide-y divide-gray-200 dark:divide-gray-700";
        table.innerHTML = `
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Prodotto</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Q.tà x Costo/Unità</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Valore Totale</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
          </tbody>
          <tfoot class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <td colspan="2" class="px-4 py-2 text-right text-sm font-bold text-gray-700 dark:text-gray-100">Totale Categoria</td>
              <td id="totale-cat" class="px-4 py-2 text-right text-sm font-bold text-gray-900 dark:text-white"></td>
            </tr>
          </tfoot>
        `;
        
        const tbody = table.querySelector('tbody');
        
        products.forEach(p => {
          const costo = parseFloat(p.costo) || 0;
          const quantita = parseFloat(p.quantita) || 0;
          const valore = costo * quantita;
          totaleCategoria += valore;
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-4 py-2 text-sm font-medium text-gray-900 dark:text-gray-100">${p.nome}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 text-right">
              ${quantita} ${p.unita} x ${formatCurrency(costo)}
            </td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200 text-right">${formatCurrency(valore)}</td>
          `;
          tbody.appendChild(tr);
        });
        
        table.querySelector('#totale-cat').textContent = formatCurrency(totaleCategoria);
        groupDiv.appendChild(table);
        container.appendChild(groupDiv);
        
        granTotale += totaleCategoria;
      });
      
      // 3. Aggiungi Gran Totale
      const granTotaleDiv = document.createElement('div');
      granTotaleDiv.className = "mt-8 pt-4 border-t-2 border-blue-600 flex justify-end";
      granTotaleDiv.innerHTML = `
        <span class="text-2xl font-bold text-gray-800 dark:text-gray-100">Valore Totale Inventario:</span>
        <span class="text-2xl font-bold text-blue-700 dark:text-blue-400 ml-4">${formatCurrency(granTotale)}</span>
      `;
      container.appendChild(granTotaleDiv);
    }
    
    /**
     * NUOVA: Ordina l'array dei prodotti in base alla chiave di ordinamento.
     */
    function sortProducts(products, sortBy) {
      const sorted = [...products]; // Crea una copia
      
      switch (sortBy) {
        case 'nome-asc':
          sorted.sort((a, b) => a.nome.localeCompare(b.nome));
          break;
        case 'nome-desc':
          sorted.sort((a, b) => b.nome.localeCompare(a.nome));
          break;
        case 'costo-asc':
          sorted.sort((a, b) => (a.costo || 0) - (b.costo || 0));
          break;
        case 'costo-desc':
          sorted.sort((a, b) => (b.costo || 0) - (a.costo || 0));
          break;
        case 'carenza-desc':
          // Carenza = qtaMinima - qta (un numero più alto è più urgente)
          sorted.sort((a, b) => {
            const carenzaA = (a.quantitaMinima || 0) - (a.quantita || 0);
            const carenzaB = (b.quantitaMinima || 0) - (b.quantita || 0);
            // I prodotti con carenza maggiore (più negativi) vanno prima
            return carenzaB - carenzaA;
          });
          break;
      }
      return sorted;
    }


    // --- NUOVE FUNZIONI PER CANTINA VINI ---

    /**
     * NUOVO: Disegna la lista dei vini nella cantina.
     * MODIFICATO: per raggruppamento a tendina per REGIONE
     */
    function renderWineList() {
      const container = dom.cantina.listContainer;
      container.innerHTML = ''; // Pulisci container

      // 1. Filtra i vini in base alla ricerca (nome, anno, cantina, regione)
      const searchTerm = state.searchTermVini.toLowerCase();
      const filteredWines = state.vini.filter(v => 
        v.nome.toLowerCase().includes(searchTerm) ||
        String(v.anno).includes(searchTerm) ||
        (v.cantina && v.cantina.toLowerCase().includes(searchTerm)) ||
        (v.regione && v.regione.toLowerCase().includes(searchTerm))
      );
      
      // 2. Gestisci messaggi "nessun vino"
      dom.cantina.noWinesMsg.classList.add('hidden');
      dom.cantina.noSearchResultsWinesMsg.classList.add('hidden');

      if (state.vini.length === 0) {
        dom.cantina.noWinesMsg.classList.remove('hidden');
        return;
      }

      if (filteredWines.length === 0 && state.searchTermVini) {
        dom.cantina.noSearchResultsWinesMsg.classList.remove('hidden');
        return;
      }

      // 3. Raggruppa i vini filtrati per REGIONE
      const groupedByRegion = filteredWines.reduce((acc, wine) => {
        const region = wine.regione || 'Senza Regione';
        if (!acc[region]) {
          acc[region] = [];
        }
        acc[region].push(wine);
        return acc;
      }, {});

      // 4. Ordina i vini all'interno di ogni regione per CANTINA
      for (const region in groupedByRegion) {
        groupedByRegion[region].sort((a, b) => {
          const cantinaA = a.cantina || '';
          const cantinaB = b.cantina || '';
          return cantinaA.localeCompare(cantinaB);
        });
      }

      // 5. Ordina le regioni alfabeticamente
      const sortedRegions = Object.keys(groupedByRegion).sort();

      // 6. Disegna le tendine
      sortedRegions.forEach(region => {
        const winesInRegion = groupedByRegion[region];
        const isExpanded = state.expandedRegions.has(region);

        const accordionWrapper = document.createElement('div');
        accordionWrapper.className = "bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden";
        
        // Pulsante Header Tendina
        const headerButton = document.createElement('button');
        headerButton.className = "w-full flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700";
        headerButton.innerHTML = `
          <div class="flex items-center">
            <span class="text-xl font-semibold text-purple-700 dark:text-purple-300">${region}</span>
            <span class="ml-3 px-2 py-0.5 bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-200 text-sm font-medium rounded-full">${winesInRegion.length} vini</span>
          </div>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 dark:text-gray-400 transition-transform duration-200 ${isExpanded ? 'transform rotate-180' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        `;
        
        // Contenuto Tendina (griglia di card)
        const contentDiv = document.createElement('div');
        contentDiv.className = `region-content p-4 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 ${isExpanded ? '' : 'hidden'}`;

        winesInRegion.forEach(wine => {
          const card = createWineCard(wine); // La funzione createWineCard rimane invariata
          contentDiv.appendChild(card);
        });

        // Aggiungi listener al pulsante
        headerButton.addEventListener('click', () => {
          if (state.expandedRegions.has(region)) {
            state.expandedRegions.delete(region);
          } else {
            state.expandedRegions.add(region);
          }
          renderWineList(); // Ridisegna la lista per aggiornare lo stato (aperto/chiuso)
        });

        accordionWrapper.appendChild(headerButton);
        accordionWrapper.appendChild(contentDiv);
        container.appendChild(accordionWrapper);
      });
    }

    /**
     * NUOVO: Disegna il report dei costi per i VINI.
     */
    function renderWineCostReport() {
      const container = dom.reportVini.container;

      // 1. Raggruppa vini per REGIONE
      const groupedByRegion = state.vini.reduce((acc, v) => {
        const region = v.regione || 'Senza Regione';
        if (!acc[region]) {
          acc[region] = [];
        }
        acc[region].push(v);
        return acc;
      }, {});
      
      if (state.vini.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-10 text-lg">
          Nessun vino nella cantina per calcolare i costi.
        </p>`;
        return;
      }

      container.innerHTML = ''; // Pulisci
      let granTotaleValore = 0;
      let granTotaleVendita = 0;
      let granTotaleMargine = 0;
      let granTotaleBottiglie = 0;

      // 2. Itera sulle regioni e crea le tabelle
      Object.keys(groupedByRegion).sort().forEach(region => {
        const wines = groupedByRegion[region];
        let totaleRegioneValore = 0;
        let totaleRegioneVendita = 0;
        let totaleRegioneMargine = 0;
        let totaleRegioneBottiglie = 0;
        
        const groupDiv = document.createElement('div');
        groupDiv.className = "mb-8";
        
        const title = document.createElement('h3');
        title.className = "text-xl font-semibold text-gray-700 border-b border-gray-300 pb-2 mb-3 dark:text-gray-200 dark:border-gray-700";
        title.textContent = region;
        groupDiv.appendChild(title);

        const table = document.createElement('table');
        table.className = "w-full min-w-full divide-y divide-gray-200 dark:divide-gray-700";
        table.innerHTML = `
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Vino (Cantina)</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Q.tà</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Valore (Costo)</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Valore (Vendita)</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Margine Tot.</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
          </tbody>
          <tfoot class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <td class="px-4 py-2 text-right text-sm font-bold text-gray-700 dark:text-gray-100">Totale Regione</td>
              <td id="totale-qta" class="px-4 py-2 text-right text-sm font-bold text-gray-900 dark:text-white"></td>
              <td id="totale-valore" class="px-4 py-2 text-right text-sm font-bold text-gray-900 dark:text-white"></td>
              <td id="totale-vendita" class="px-4 py-2 text-right text-sm font-bold text-gray-900 dark:text-white"></td>
              <td id="totale-margine" class="px-4 py-2 text-right text-sm font-bold text-gray-900 dark:text-white"></td>
            </tr>
          </tfoot>
        `;
        
        const tbody = table.querySelector('tbody');
        
        wines.forEach(v => {
          const costo = parseFloat(v.costo) || 0;
          const vendita = parseFloat(v.vendita) || 0;
          const quantita = parseInt(v.quantita) || 0;
          
          const valoreCosto = costo * quantita;
          const valoreVendita = vendita * quantita;
          const valoreMargine = valoreVendita - valoreCosto;

          totaleRegioneValore += valoreCosto;
          totaleRegioneVendita += valoreVendita;
          totaleRegioneMargine += valoreMargine;
          totaleRegioneBottiglie += quantita;
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-4 py-2 text-sm font-medium text-gray-900 dark:text-gray-100">
              ${v.nome} ${v.anno}
              <span class="text-xs text-gray-500 block dark:text-gray-400">${v.cantina || 'Sconosciuta'}</span>
            </td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200 text-right">${quantita} btg.</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 text-right">${formatCurrency(valoreCosto)}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200 text-right">${formatCurrency(valoreVendita)}</td>
            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium ${valoreMargine > 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'} text-right">
              ${formatCurrency(valoreMargine)}
            </td>
          `;
          tbody.appendChild(tr);
        });
        
        table.querySelector('#totale-qta').textContent = `${totaleRegioneBottiglie} btg.`;
        table.querySelector('#totale-valore').textContent = formatCurrency(totaleRegioneValore);
        table.querySelector('#totale-vendita').textContent = formatCurrency(totaleRegioneVendita);
        table.querySelector('#totale-margine').textContent = formatCurrency(totaleRegioneMargine);
        groupDiv.appendChild(table);
        container.appendChild(groupDiv);
        
        granTotaleValore += totaleRegioneValore;
        granTotaleVendita += totaleRegioneVendita;
        granTotaleMargine += totaleRegioneMargine;
        granTotaleBottiglie += totaleRegioneBottiglie;
      });
      
      // 3. Aggiungi Gran Totale
      const granTotaleDiv = document.createElement('div');
      granTotaleDiv.className = "mt-8 pt-4 border-t-2 border-indigo-600 space-y-2";
      
      granTotaleDiv.innerHTML = `
        <div class="flex justify-between items-center">
          <span class="text-xl font-bold text-gray-800 dark:text-gray-100">Totale Bottiglie:</span>
          <span class="text-xl font-bold text-indigo-700 dark:text-indigo-400">${granTotaleBottiglie} btg.</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-xl font-bold text-gray-800 dark:text-gray-100">Valore Totale (Costo):</span>
          <span class="text-xl font-bold text-indigo-700 dark:text-indigo-400">${formatCurrency(granTotaleValore)}</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-xl font-bold text-gray-800 dark:text-gray-100">Valore Totale (Vendita):</span>
          <span class="text-xl font-bold text-indigo-700 dark:text-indigo-400">${formatCurrency(granTotaleVendita)}</span>
        </div>
        <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-300 dark:border-gray-600">
          <span class="text-2xl font-bold text-gray-800 dark:text-gray-100">Margine Totale Cantina:</span>
          <span class="text-2xl font-bold ${granTotaleMargine > 0 ? 'text-green-700 dark:text-green-400' : 'text-red-700 dark:text-red-400'}">
            ${formatCurrency(granTotaleMargine)}
          </span>
        </div>
      `;
      container.appendChild(granTotaleDiv);
    }


    /**
     * NUOVO: Crea il singolo elemento card per un vino.
     * (Questa funzione è rimasta uguale, viene solo chiamata da un'altra parte)
     */
    function createWineCard(wine) {
      const div = document.createElement('div');
      div.className = "wine-card bg-white rounded-lg shadow-lg overflow-hidden dark:bg-gray-800 flex flex-col relative"; // Aggiunto relative
      
      const costo = parseFloat(wine.costo) || 0;
      const vendita = parseFloat(wine.vendita) || 0;
      const margine = vendita - costo;
      
      const margineColor = margine > 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';

      div.innerHTML = `
        <!-- Intestazione Carta Vino -->
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
          <input type="text" value="${wine.nome}" data-field="nome" class="text-xl font-semibold text-gray-800 truncate bg-transparent focus:outline-none focus:ring-1 focus:ring-purple-500 rounded-md px-1 -ml-1 w-full dark:text-gray-100 dark:focus:bg-gray-700">
          
          <!-- Wrapper per campi secondari -->
          <div class="grid grid-cols-2 gap-x-4 mt-2">
            <div class="flex items-center">
              <span class="text-sm font-medium text-gray-500 dark:text-gray-400 mr-2 w-12">Anno:</span>
              <input type="number" value="${wine.anno}" data-field="anno" min="1900" max="2100" class="w-full text-sm border rounded-md p-1 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
            </div>
            
            <!-- CAMPO REGIONE -->
            <div class="flex items-center">
              <span class="text-sm font-medium text-gray-500 dark:text-gray-400 mr-2 w-12">Regione:</span>
              <input type="text" value="${wine.regione || ''}" data-field="regione" class="w-full text-sm border rounded-md p-1 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
            </div>

            <!-- CAMPO CANTINA (su riga nuova) -->
            <div class="flex items-center col-span-2 mt-2">
              <span class="text-sm font-medium text-gray-500 dark:text-gray-400 mr-2 w-12">Cantina:</span>
              <input type="text" value="${wine.cantina || ''}" data-field="cantina" class="w-full text-sm border rounded-md p-1 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
            </div>
          </div>
        </div>
        
        <!-- Corpo Carta Vino (Quantità) -->
        <div class="p-4 flex-grow">
          <div class="flex items-center justify-between">
            <span class="text-lg font-medium text-gray-700 dark:text-gray-200">Quantità</span>
            <div class="flex items-center space-x-2">
              <button class="btn-minus-vino p-1 rounded-full bg-red-100 text-red-600 hover:bg-red-200 dark:bg-red-900/50 dark:text-red-300 dark:hover:bg-red-900">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
              </button>
              
              <input type="number" value="${wine.quantita}" data-field="quantita" step="1" min="0" class="w-16 text-center text-lg font-bold border rounded-md p-1 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
              
              <button class="btn-plus-vino p-1 rounded-full bg-green-100 text-green-600 hover:bg-green-200 dark:bg-green-900/50 dark:text-green-300 dark:hover:bg-green-900">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Footer Carta Vino (Costi) -->
        <div class="p-4 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700">
          <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col">
              <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Costo (€)</label>
              <input type="number" value="${costo}" data-field="costo" min="0" step="0.01" class="text-sm border rounded-md p-1.5 shadow-sm w-full dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
            </div>
            <div class="flex flex-col">
              <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Vendita (€)</label>
              <input type="number" value="${vendita}" data-field="vendita" min="0" step="0.01" class="text-sm border rounded-md p-1.5 shadow-sm w-full dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
            </div>
          </div>
          <div class="mt-3 flex justify-between items-center">
            <span class="text-sm font-bold text-gray-700 dark:text-gray-200">Margine:</span>
            <span class="text-lg font-bold ${margineColor}">
              ${formatCurrency(margine)}
            </span>
          </div>
        </div>
        
        <!-- Pulsante Elimina -->
        <button class="delete-btn-vino absolute top-3 right-3 p-1 text-gray-400 hover:text-red-500 dark:hover:text-red-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>
      `;

      // Aggiungi Listener
      
      // Pulsanti +/-
      const btnMinus = div.querySelector('.btn-minus-vino');
      const btnPlus = div.querySelector('.btn-plus-vino');
      
      btnMinus.addEventListener('click', (e) => {
        e.preventDefault(); e.stopPropagation();
        let newQuantita = (parseInt(wine.quantita) || 0) - 1;
        if (newQuantita < 0) newQuantita = 0;
        handleWineUpdate(wine.id, 'quantita', newQuantita);
      });

      btnPlus.addEventListener('click', (e) => {
        e.preventDefault(); e.stopPropagation();
        let newQuantita = (parseInt(wine.quantita) || 0) + 1;
        handleWineUpdate(wine.id, 'quantita', newQuantita);
      });

      // Input Modificabili
      const inputs = div.querySelectorAll('[data-field]');
      inputs.forEach(input => {
        input.addEventListener('change', (e) => {
          const field = e.target.dataset.field;
          let value = (e.target.type === 'number') ? parseFloat(e.target.value) : e.target.value;
          if (e.target.type === 'number' && isNaN(value)) value = 0;
          
          // Se l'anno è un numero, assicurati che sia intero
          if (field === 'anno') value = parseInt(value) || 1900;
          // Se la quantità è un numero, assicurati che sia intero
          if (field === 'quantita') value = parseInt(value) || 0;

          handleWineUpdate(wine.id, field, value);
        });
        input.addEventListener('click', e => e.stopPropagation());
      });
      
      // Pulsante Rimuovi
      const deleteBtn = div.querySelector('.delete-btn-vino');
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        handleDeleteWine(wine.id, wine.nome);
      });

      return div;
    }


    // --- FUNZIONI DI LOGICA (GETTERS) ---

    /**
     * Ritorna true se un prodotto deve essere sulla lista spesa.
     * @param {object} product - L'oggetto prodotto.
     * @param {boolean} [autoOnly=false] - Se true, ignora le forzature manually.
     */
    function isProductInShoppingList(product, autoOnly = false) {
      const isAuto = (product.quantita < product.quantitaMinima) && 
                     (product.stato === 'Disponibile'); // Logica Modificata
                     
      if (autoOnly) {
        return isAuto;
      }
      
      const manualStatus = state.shoppingListManual[product.id];
      
      if (manualStatus === 'add') return true;
      if (manualStatus === 'remove') return false;
      
      return isAuto;
    }
    
    /**
     * Ritorna l'array completo dei prodotti per la lista spesa.
     */
    function getShoppingList() {
      return state.products.filter(p => isProductInShoppingList(p));
    }
    
    /**
     * Ritorna i prodotti della lista spesa raggruppati per fornitore.
     */
    function getShoppingListGrouped() {
      const shoppingList = getShoppingList();
      return shoppingList.reduce((acc, p) => {
        const fornitore = p.fornitore || 'Sconosciuto';
        if (!acc[fornitore]) {
          acc[fornitore] = [];
        }
        acc[fornitore].push(p);
        return acc;
      }, {});
    }


    // --- FUNZIONI DI AZIONE (HANDLERS) ---

    /**
     * Aggiorna lo stato globale e chiama render().
     */
    function updateState(newState) {
      Object.assign(state, newState);
      
      // Chiudi il menu a tendina se si cambia vista
      if (newState.view || newState.inventoryView || newState.sortBy) {
        dom.inventario.filtersDropdown.classList.add('hidden');
      }

      render();
    }
    
    /**
     * Chiude il modale e resetta il form.
     */
    function closeFormModal() {
      dom.formModal.overlay.classList.add('hidden');
      dom.formModal.form.reset();
    }

    /**
     * NUOVO: Chiude il modale VINI e resetta il form.
     */
    function closeWineModal() {
      dom.wineModal.overlay.classList.add('hidden');
      dom.wineModal.form.reset();
    }

    /**
     * Gestisce l'invio del form per un nuovo prodotto.
     */
    async function handleAddProduct(e) {
      e.preventDefault();
      
      const newProduct = {
        nome: dom.formModal.inputs.nome.value,
        categoria: dom.formModal.inputs.categoria.value,
        fornitore: dom.formModal.inputs.fornitore.value,
        costo: parseFloat(dom.formModal.inputs.costo.value) || 0,
        unita: dom.formModal.inputs.unita.value,
        quantita: parseFloat(dom.formModal.inputs.quantita.value) || 0,
        quantitaMinima: parseFloat(dom.formModal.inputs.quantitaMinima.value) || 0,
        stato: dom.formModal.inputs.stato.value,
      };

      try {
        const productsCollectionRef = collection(db, "inventari", GRUPPO_ID, "prodotti");
        await addDoc(productsCollectionRef, newProduct);
        
        closeFormModal();
        showCustomAlert('Successo!', `Prodotto "${newProduct.nome}" aggiunto.`, 'success');
        
      } catch (error) {
        console.error("Errore aggiunta prodotto: ", error);
        showCustomAlert('Errore', `Impossibile aggiungere il prodotto: ${error.message}`, 'error');
      }
    }

    /**
     * NUOVO: Gestisce l'invio del form per un nuovo vino.
     */
    async function handleAddWine(e) {
      e.preventDefault();
      
      const newWine = {
        nome: dom.wineModal.inputs.nome.value,
        anno: parseInt(dom.wineModal.inputs.anno.value) || 1900,
        quantita: parseInt(dom.wineModal.inputs.quantita.value) || 0,
        costo: parseFloat(dom.wineModal.inputs.costo.value) || 0,
        vendita: parseFloat(dom.wineModal.inputs.vendita.value) || 0,
        // NUOVI
        cantina: dom.wineModal.inputs.cantina.value || '',
        regione: dom.wineModal.inputs.regione.value || '',
      };

      try {
        const winesCollectionRef = collection(db, "inventari", GRUPPO_ID, "vini");
        await addDoc(winesCollectionRef, newWine);
        
        closeWineModal();
        showCustomAlert('Successo!', `Vino "${newWine.nome}" aggiunto alla cantina.`, 'success');
        
      } catch (error) {
        console.error("Errore aggiunta vino: ", error);
        showCustomAlert('Errore', `Impossibile aggiungere il vino: ${error.message}`, 'error');
      }
    }

    /**
     * Aggiorna un campo di un prodotto esistente su Firebase.
     */
    async function handleProductUpdate(productId, field, value) {
      const productRef = doc(db, "inventari", GRUPPO_ID, "prodotti", productId);
      
      try {
        await updateDoc(productRef, {
          [field]: value
        });
        // Non serve un alert per ogni modifica, è troppo invasivo
      } catch (error) {
        console.error(`Errore aggiornamento campo ${field}: `, error);
        showCustomAlert('Errore', `Impossibile aggiornare ${field}: ${error.message}`, 'error');
        // NOTA: il listener onSnapshot ricaricherà il vecchio valore, 
        // annullando la modifica fallita
      }
    }

    /**
     * NUOVO: Aggiorna un campo di un vino esistente su Firebase.
     */
    async function handleWineUpdate(wineId, field, value) {
      const wineRef = doc(db, "inventari", GRUPPO_ID, "vini", wineId);
      
      try {
        await updateDoc(wineRef, {
          [field]: value
        });
      } catch (error) {
        console.error(`Errore aggiornamento vino ${field}: `, error);
        showCustomAlert('Errore', `Impossibile aggiornare ${field}: ${error.message}`, 'error');
      }
    }

    /**
     * Cancella un prodotto da Firebase.
     */
    async function handleDeleteProduct(productId, productName) {
      // Sostituisci window.confirm con un modale custom (futuro)
      if (true) { // Per ora, salta la conferma
        try {
          const productRef = doc(db, "inventari", GRUPPO_ID, "prodotti", productId);
          await deleteDoc(productRef);
          showCustomAlert('Successo!', `Prodotto "${productName}" eliminato.`, 'success');
        } catch (error) {
          console.error("Errore eliminazione prodotto: ", error);
          showCustomAlert('Errore', `Impossibile eliminare: ${error.message}`, 'error');
        }
      }
    }

    /**
     * NUOVO: Cancella un vino da Firebase.
     */
    async function handleDeleteWine(wineId, wineName) {
      if (true) { // Salta conferma per ora
        try {
          const wineRef = doc(db, "inventari", GRUPPO_ID, "vini", wineId);
          await deleteDoc(wineRef);
          showCustomAlert('Successo!', `Vino "${wineName}" eliminato.`, 'success');
        } catch (error) {
          console.error("Errore eliminazione vino: ", error);
          showCustomAlert('Errore', `Impossibile eliminare: ${error.message}`, 'error');
        }
      }
    }

    /**
     * Gestisce l'aggiunta/rimozione manuale dalla lista spesa.
     */
    function handleManualShoppingList(productId) {
      const product = state.products.find(p => p.id === productId);
      if (!product) return;

      const isAuto = isProductInShoppingList(product, true);
      const manualStatus = state.shoppingListManual[productId];

      const newManualState = { ...state.shoppingListManual };

      if (manualStatus === 'add') {
        // Era forzato 'add' -> ora default (lascia decidere l'auto)
        delete newManualState[productId];
      } else if (manualStatus === 'remove') {
        // Era forzato 'remove' -> ora forzato 'add'
        newManualState[productId] = 'add';
      } else {
        // Era default
        if (isAuto) {
          // Era auto -> ora forzato 'remove'
          newManualState[productId] = 'remove';
        } else {
          // Era non-auto -> ora forzato 'add'
          newManualState[productId] = 'add';
        }
      }

      // Aggiorna lo stato (solo localmente, non serve salvare su DB)
      updateState({ shoppingListManual: newManualState });
    }

    /**
     * Gestisce il caricamento e il parsing di un file CSV.
     */
    async function handleCsvUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      dom.loadingOverlay.style.display = 'flex'; // Mostra caricamento

      try {
        const csvText = await file.text();
        const { headers, data } = parseCSV(csvText);

        // --- INIZIO MODIFICA: Controllo header migliorato ---
        const headersFound = headers.map(h => h.toLowerCase().trim());
        
        const findHeader = (possibleNames) => {
            for (const name of possibleNames) {
                const index = headersFound.indexOf(name);
                if (index !== -1) return index;
            }
            return -1;
        };

        // Cerca gli indici delle colonne necessarie
        const nomeIndex = findHeader(['nome']);
        const categoriaIndex = findHeader(['categoria']);
        const fornitoreIndex = findHeader(['fornitore']);

        const requiredHeaders = ['nome', 'categoria', 'fornitore'];
        const missingHeaders = [];

        if (nomeIndex === -1) missingHeaders.push('nome');
        if (categoriaIndex === -1) missingHeaders.push('categoria');
        if (fornitoreIndex === -1) missingHeaders.push('fornitore');

        if (missingHeaders.length > 0) {
          // Messaggio di errore migliorato
          const headersFoundString = headersFound.length > 0 ? headersFound.join(', ') : 'Nessuna';
          throw new Error(`File CSV non valido. Colonne richieste mancanti: [${missingHeaders.join(', ')}]. Colonne trovate nel file: [${headersFoundString}]`);
        }
        // --- FINE MODIFICA ---
        
        // Controlla i duplicati
        // Prendi i nomi dei prodotti esistenti
        const existingNamesLower = state.products.map(p => p.nome.toLowerCase());
        
        const productsToAdd = [];
        let skipped = 0;

        data.forEach(row => {
          const nome = row[nomeIndex];
          if (nome) {
            const nomeLower = nome.toLowerCase();
            if (!existingNamesLower.includes(nomeLower)) {
              // Prodotto nuovo, aggiungi alla lista
              productsToAdd.push({
                nome: nome,
                categoria: row[categoriaIndex] || 'Sconosciuta',
                fornitore: row[fornitoreIndex] || 'Sconosciuto',
                costo: 0,
                unita: 'pz',
                quantita: 0,
                quantitaMinima: 0,
                stato: 'Disponibile'
              });
              // Aggiungi subito all'elenco per evitare duplicati nello stesso file
              existingNamesLower.push(nomeLower); 
            } else {
              skipped++; // Prodotto duplicato, salta
            }
          }
        });

        // Esegui il caricamento massivo (Batch Write)
        if (productsToAdd.length > 0) {
          const batch = writeBatch(db);
          const productsCollectionRef = collection(db, "inventari", GRUPPO_ID, "prodotti");
          
          productsToAdd.forEach(product => {
            const newDocRef = doc(productsCollectionRef); // Crea un nuovo ID
            batch.set(newDocRef, product);
          });
          
          await batch.commit();
        }
        
        showCustomAlert('Importazione Completata', 
          `Prodotti nuovi aggiunti: ${productsToAdd.length}. Prodotti duplicati saltati: ${skipped}.`, 
          'success');

      } catch (error) {
        console.error("Errore importazione CSV: ", error);
        showCustomAlert('Errore Importazione', error.message, 'error');
      } finally {
        dom.loadingOverlay.style.display = 'none'; // Nascondi caricamento
        event.target.value = null; // Resetta l'input file
      }
    }

    /**
     * NUOVO: Gestisce il caricamento e il parsing di un file CSV per i VINI.
     */
    async function handleWineCsvUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      dom.loadingOverlay.style.display = 'flex'; // Mostra caricamento

      try {
        const csvText = await file.text();
        const { headers, data } = parseCSV(csvText);

        // --- INIZIO MODIFICA: Controllo header migliorato ---
        const headersFound = headers.map(h => h.toLowerCase().trim());
        
        const findHeader = (possibleNames) => {
            for (const name of possibleNames) {
                const index = headersFound.indexOf(name);
                if (index !== -1) return index;
            }
            return -1;
        };

        // Cerca gli indici delle colonne necessarie per i vini
        const nomeIndex = findHeader(['nome']);
        const annoIndex = findHeader(['anno']);
        const cantinaIndex = findHeader(['cantina']);
        const regioneIndex = findHeader(['regione']);
        const costoIndex = findHeader(['costo']);
        const venditaIndex = findHeader(['vendita']);
        const quantitaIndex = findHeader(['quantita', 'quantità']); // ACCETTA ENTRAMBI

        const requiredHeaders = ['nome', 'anno', 'costo', 'vendita', 'quantita/quantità'];
        const missingHeaders = [];

        if (nomeIndex === -1) missingHeaders.push('nome');
        if (annoIndex === -1) missingHeaders.push('anno');
        if (costoIndex === -1) missingHeaders.push('costo');
        if (venditaIndex === -1) missingHeaders.push('vendita');
        if (quantitaIndex === -1) missingHeaders.push('quantita/quantità');

        if (missingHeaders.length > 0) {
          // Messaggio di errore migliorato
          const headersFoundString = headersFound.length > 0 ? headersFound.join(', ') : 'Nessuna';
          throw new Error(`File CSV non valido. Colonne richieste mancanti: [${missingHeaders.join(', ')}]. Colonne trovate nel file: [${headersFoundString}]`);
        }
        // --- FINE MODIFICA ---
        
        // Controlla i duplicati (basato sui vini esistenti)
        const existingNamesLower = state.vini.map(v => v.nome.toLowerCase());
        
        const winesToAdd = [];
        let skipped = 0;

        data.forEach(row => {
          const nome = row[nomeIndex];
          if (nome) {
            const nomeLower = nome.toLowerCase();
            if (!existingNamesLower.includes(nomeLower)) {
              // Vino nuovo, aggiungi alla lista
              winesToAdd.push({
                nome: nome,
                anno: parseInt(row[annoIndex]) || 1900,
                cantina: row[cantinaIndex] || '',
                regione: row[regioneIndex] || '',
                costo: parseFloat(row[costoIndex]) || 0,
                vendita: parseFloat(row[venditaIndex]) || 0,
                quantita: parseInt(row[quantitaIndex]) || 0,
              });
              // Aggiungi subito all'elenco per evitare duplicati nello stesso file
              existingNamesLower.push(nomeLower); 
            } else {
              skipped++; // Vino duplicato, salta
            }
          }
        });

        // Esegui il caricamento massivo (Batch Write)
        if (winesToAdd.length > 0) {
          const batch = writeBatch(db);
          // Salva nella collezione VINI
          const winesCollectionRef = collection(db, "inventari", GRUPPO_ID, "vini");
          
          winesToAdd.forEach(wine => {
            const newDocRef = doc(winesCollectionRef); // Crea un nuovo ID
            batch.set(newDocRef, wine);
          });
          
          await batch.commit();
        }
        
        showCustomAlert('Importazione Vini Completata', 
          `Vini nuovi aggiunti: ${winesToAdd.length}. Vini duplicati saltati: ${skipped}.`, 
          'success');

      } catch (error) {
        console.error("Errore importazione CSV Vini: ", error);
        showCustomAlert('Errore Importazione Vini', error.message, 'error');
      } finally {
        dom.loadingOverlay.style.display = 'none'; // Nascondi caricamento
        event.target.value = null; // Resetta l'input file
      }
    }

    /**
     * NUOVA: Esporta l'inventario corrente in un file CSV.
     */
    function handleExportCSV() {
      if (state.products.length === 0) {
        showCustomAlert('Niente da esportare', 'L\'inventario è vuoto.', 'info');
        return;
      }

      const headers = ["nome", "categoria", "fornitore", "costo", "unita", "quantita", "quantitaMinima", "stato"];
      let csvContent = headers.join(",") + "\n";

      // Funzione helper per gestire virgole e virgolette nei nomi
      const escapeCSV = (str) => {
        let s = String(str || '').replace(/"/g, '""'); // Raddoppia le virgolette
        if (s.includes(',') || s.includes('"') || s.includes('\n')) {
          s = `"${s}"`; // Metti tra virgolette
        }
        return s;
      };
      
      // Ordina i prodotti alfabeticamente per l'esportazione
      const productsToExport = sortProducts(state.products, 'nome-asc');

      productsToExport.forEach(product => {
        const row = [
          escapeCSV(product.nome),
          escapeCSV(product.categoria),
          escapeCSV(product.fornitore),
          product.costo || 0,
          escapeCSV(product.unita),
          product.quantita || 0,
          product.quantitaMinima || 0,
          escapeCSV(product.stato)
        ];
        csvContent += row.join(",") + "\n";
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      
      if (link.download !== undefined) { 
        const url = URL.createObjectURL(blob);
        const date = new Date().toISOString().split('T')[0];
        link.setAttribute("href", url);
        link.setAttribute("download", `inventario_backup_${date}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showCustomAlert('Esportazione Avviata', 'Il download del CSV è iniziato.', 'success');
      } else {
        showCustomAlert('Errore', 'Il tuo browser non supporta il download automatico.', 'error');
      }
    }


    // --- FUNZIONI DI UTILITÀ ---
    
    /**
     * Funzione di utility per il parsing di un file CSV.
     * (MODIFICATA PER GESTIRE VIRGOLE E PUNTO/VIRGOLA)
     */
    function parseCSV(text) {
      const lines = text.replace(/\r/g, '').split('\n');
      const headers = [];
      const data = [];

      if (lines.length === 0) return { headers, data };

      const headerLine = lines[0];
      
      // --- NUOVO: Rilevamento automatico separatore ---
      const commaCount = (headerLine.match(/,/g) || []).length;
      const semicolonCount = (headerLine.match(/;/g) || []).length;
      const separator = semicolonCount > commaCount ? ';' : ',';
      // Crea il Regex dinamicamente in base al separatore
      // Spiegazione: Cerca (inizio riga O separatore), seguito da
      // 1. (un campo tra virgolette) OPPURE 2. (un campo non-separatore)
      const csvRegex = new RegExp(`(?:^|${separator})(?:"([^"]*)"|([^${separator}]*))`, 'g');
      // --- FINE NUOVO ---

      // 1. Estrai Intestazioni (Headers)
      let match;
      // Pulisce gli header da eventuali virgolette
      while (match = csvRegex.exec(headerLine)) {
          const header = match[1] ? match[1] : match[2];
          headers.push(header.trim().replace(/^"|"$/g, ''));
      }

      // 2. Estrai Dati (Data)
      for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim() === '') continue; // Salta righe vuote
        
        const row = [];
        let lineMatch;
        const line = lines[i];
        
        csvRegex.lastIndex = 0; // Resetta l'indice del regex
        
        while (lineMatch = csvRegex.exec(line)) {
            // Pulisce i valori da eventuali virgolette
            const value = (lineMatch[1] ? lineMatch[1] : lineMatch[2]).trim().replace(/^"|"$/g, '');
            row.push(value);
        }
        
        if (row.length > 0) {
             data.push(row);
        }
      }
      return { headers, data };
    }

    /**
     * Copia la lista della spesa formattata negli appunti.
     */
    function copyShoppingListToClipboard() {
      const groupedList = getShoppingListGrouped();
      let textToCopy = "LISTA SPESA:\n\n";

      Object.keys(groupedList).sort().forEach(fornitore => {
        textToCopy += `--- ${fornitore.toUpperCase()} ---\n`;
        groupedList[fornitore].forEach(product => {
          textToCopy += `- ${product.nome}\n`;
        });
        textToCopy += "\n"; // Spazio tra i fornitori
      });
      
      // Usa un trucco per copiare (navigator.clipboard non sempre funziona in iframe)
      const textArea = document.createElement("textarea");
      textArea.value = textToCopy;
      textArea.style.position = "fixed";  // Rimuovi dallo schermo
      textArea.style.left = "-9999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        document.execCommand('copy');
        showCustomAlert('Copiato!', 'Lista della spesa copiata negli appunti.', 'success');
      } catch (err) {
        showCustomAlert('Errore', 'Impossibile copiare la lista.', 'error');
      }
      document.body.removeChild(textArea);
    }
    
    /**
     * Formatta un numero come valuta.
     */
    function formatCurrency(value) {
      return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(value || 0);
    }
    
    /**
     * Mostra un alert customizzato (success, error, info).
     */
    function showCustomAlert(title, message, type = 'info') {
      const alert = dom.customAlert.element;
      const icon = dom.customAlert.icon;
      
      // Resetta classi
      alert.classList.remove('bg-green-50', 'bg-red-50', 'bg-blue-50', 'dark:bg-green-800/50', 'dark:bg-red-800/50', 'dark:bg-blue-800/50', 'hidden');
      icon.innerHTML = '';
      dom.customAlert.title.classList.remove('text-green-800', 'text-red-800', 'text-blue-800', 'dark:text-green-200', 'dark:text-red-200', 'dark:text-blue-200');
      dom.customAlert.message.classList.remove('text-green-700', 'text-red-700', 'text-blue-700', 'dark:text-green-300', 'dark:text-red-300', 'dark:text-blue-300');
      dom.customAlert.closeBtn.classList.remove('text-green-400', 'text-red-400', 'text-blue-400', 'hover:text-green-500', 'hover:text-red-500', 'hover:text-blue-500');

      let iconSvg = '';
      let baseColor = '';

      switch (type) {
        case 'success':
          baseColor = 'green';
          iconSvg = `<svg class="h-6 w-6 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
          break;
        case 'error':
          baseColor = 'red';
          iconSvg = `<svg class="h-6 w-6 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 101.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`;
          break;
        default: // info
          baseColor = 'blue';
          iconSvg = `<svg class="h-6 w-6 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>`;
          break;
      }
      
      alert.classList.add(`bg-${baseColor}-50`, `dark:bg-${baseColor}-800/50`);
      icon.innerHTML = iconSvg;
      dom.customAlert.title.classList.add(`text-${baseColor}-800`, `dark:text-${baseColor}-200`);
      dom.customAlert.message.classList.add(`text-${baseColor}-700`, `dark:text-${baseColor}-300`);
      dom.customAlert.closeBtn.classList.add(`text-${baseColor}-400`, `hover:text-${baseColor}-500`);

      dom.customAlert.title.textContent = title;
      dom.customAlert.message.textContent = message;
      alert.classList.remove('hidden', 'animate-pulse');
      
      // Auto-chiudi dopo 5 secondi
      setTimeout(() => {
        alert.classList.add('hidden');
      }, 5000);
    }


    // --- AVVIO APPLICAZIONE ---
    initApp();
// --- INIZIO: NUOVA Logica per Scaricare PDF Report Vini ---

// 1. Collega la funzione al pulsante (Senza "DOMContentLoaded")
// Lo colleghiamo subito, perché lo script è a fine pagina e il pulsante esiste già.

const downloadButton = document.getElementById('btn-scarica-pdf-vini');

if (downloadButton) {
  // Trovato! Attacchiamo il filo.
  downloadButton.addEventListener('click', scaricaReportCostiViniPDF);
} else {
  // Questo ci aiuta a capire se ancora non lo trova
  console.error('ERRORE: Impossibile trovare il pulsante "btn-scarica-pdf-vini" da collegare.');
}

// --- INIZIO: NUOVA Logica per Scaricare PDF (Versione Corretta) ---

// (Il codice per collegare il pulsante va bene e rimane dov'è)

// 2. NUOVA Funzione PDF (Questa SOSTITUISCE interamente la vecchia)
function scaricaReportCostiViniPDF() {
  console.log('Avvio creazione PDF con i dati da state.vini...');

  try {
    // 1. Carica la libreria PRINCIPALE
    // Usiamo window.jspdf.jsPDF che è più sicuro
    const jsPDF = window.jspdf.jsPDF;

    if (typeof jsPDF === 'undefined') {
      console.error('jsPDF non è caricata! Controlla lo script nella <head>.');
      alert('Errore: Impossibile caricare la libreria PDF.');
      return;
    }

    // 2. Crea il documento
    const doc = new jsPDF();
    
    // 3. Controlla se il PLUGIN 'autoTable' è stato caricato
    // Il plugin si "attacca" al documento. Se non c'è, doc.autoTable sarà undefined.
    if (typeof doc.autoTable === 'undefined') {
      console.error('Il plugin jsPDF-autoTable non è caricato! Controlla il secondo script nella <head>.');
      alert('Errore: Impossibile caricare il plugin per le tabelle PDF.');
      return;
    }

    // 4. Controlla se ci sono dati nello stato
    if (!state.vini || state.vini.length === 0) {
      alert('Nessun dato sui vini da esportare.');
      return;
    }

    // 5. Definisci le colonne del PDF
    const head = [[
      'Nome Vino', 
      'Cantina', 
      'Regione', 
      'Anno', 
      'Q.tà', 
      'Costo Acq. (€)', 
      'Prezzo Vend. (€)', 
      'Margine (€)'
    ]];

    // 6. Prepara le righe del PDF (il corpo)
    const viniOrdinati = [...state.vini].sort((a, b) => {
      const regA = a.regione || 'Senza Regione';
      const regB = b.regione || 'Senza Regione';
      return regA.localeCompare(regB);
    });
    
    let totaleValoreAcquisto = 0;
    let totaleValoreVendita = 0;
    let totaleQuantita = 0;

    const body = viniOrdinati.map(v => {
      const costo = v.costo || 0;
      const vendita = v.vendita || 0;
      const quantita = v.quantita || 0;
      const margine = (vendita - costo) * quantita;

      totaleValoreAcquisto += costo * quantita;
      totaleValoreVendita += vendita * quantita;
      totaleQuantita += quantita;

      return [
        v.nome,
        v.cantina || '-',
        v.regione || '-',
        v.anno || '-',
        quantita,
        costo.toFixed(2),
        vendita.toFixed(2),
        margine.toFixed(2)
      ];
    });
    
    // 7. Calcola i totali per il piè di pagina
    const totaleMargineComplessivo = totaleValoreVendita - totaleValoreAcquisto;
    
    const foot = [[
      'TOTALI',
      '', // cantina
      '', // regione
      '', // anno
      totaleQuantita,
      totaleValoreAcquisto.toFixed(2),
      totaleValoreVendita.toFixed(2),
      totaleMargineComplessivo.toFixed(2)
    ]];

    // 8. Crea la tabella nel PDF
    doc.autoTable({
      head: head,
      body: body,
      foot: foot, 
      startY: 22,
      theme: 'grid',
      styles: { fontSize: 8, cellPadding: 2 },
      headStyles: { fillColor: [22, 78, 99], textColor: 255, fontStyle: 'bold' },
      footStyles: { fillColor: [241, 245, 249], textColor: 0, fontStyle: 'bold' } 
    });

    // 9. Salva il file PDF
    doc.save('report-vini-completo.pdf');
    console.log('PDF creato e salvato.');

  } catch (error) {
    console.error('Errore imprevisto durante la creazione del PDF:', error);
    alert('Si è verificato un errore sconosciuto. Controlla la console (F12).');
  }
}

// --- FINE: NUOVA Logica per Scaricare PDF (Versione Corretta) ---
  </script>

</body>
</html>
