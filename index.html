<!DOCTYPE html>
<html lang="it"> <!-- La classe 'dark' verrà aggiunta qui da JS -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Inventario (Firebase)</title>
  
  <!-- 1. Carica Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Stili CSS (invariati) */
    input[type='number']::-webkit-inner-spin-button,
    input[type='number']::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type='number'] {
      -moz-appearance: textfield;
    }
    /* Stili per il toggle scuro */
    .theme-switch-toggle {
      transition: all 0.2s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans dark:bg-gray-900">

  <!-- Overlay di caricamento -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center z-[999]">
    <svg class="animate-spin h-10 w-10 text-white mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <span class="text-white text-lg font-medium">Caricamento dati...</span>
  </div>

  <div class="max-w-7xl mx-auto">
    
    <!-- Intestazione e Navigazione Viste -->
    <header class="mb-6">
      <!-- (Intestazione invariata) -->
      <div class="flex justify-between items-center">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-gray-100">Gestione Inventario</h1>
        <div class="flex items-center space-x-4">
          <!-- Pulsante Home -->
          <button id="btn-go-home" class="hidden text-gray-500 hover:text-blue-600 transition-colors dark:text-gray-400 dark:hover:text-blue-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
            </svg>
          </button>
          
          <!-- Dark Mode Toggle -->
          <label for="theme-toggle" class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="theme-toggle" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-300 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2 text-gray-500 dark:text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" class="hidden dark:block"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" class="block dark:hidden"/>
            </svg>
          </label>
        </div>
      </div>
      <!-- Wrapper per le schede di navigazione -->
      <nav id="main-nav-tabs" class="flex space-x-2 mt-4 hidden">
        <button id="nav-inventario"
          class="px-3 py-2 md:px-4 text-sm md:text-base rounded-lg font-semibold shadow-md transition-all duration-200 bg-blue-600 text-white">
          Inventario
        </button>
        <button id="nav-listaSpesa"
          class="px-3 py-2 md:px-4 text-sm md:text-base rounded-lg font-semibold shadow-md transition-all duration-200 bg-white text-gray-700 dark:bg-gray-700 dark:text-gray-200">
          Lista Spesa
          <span id="shopping-list-badge" class="ml-2 bg-red-500 text-white text-xs font-bold rounded-full px-2 py-1 hidden">
          </span>
        </button>
      </nav>
    </header>

    <!-- Sezione Viste -->
    <main>
      
      <!-- VISTA: Home (invariata) -->
      <div id="view-home">
        <!-- ... (codice home invariato) ... -->
      </div>
      
      <!-- VISTA: Inventario (invariata) -->
      <div id="view-inventario" class="hidden">
        <!-- ... (codice filtri e contenitore lista invariati) ... -->
      </div>

      <!-- VISTA: Lista Spesa (invariata) -->
      <div id="view-listaSpesa" class="hidden">
        <!-- ... (codice lista spesa invariato) ... -->
      </div>
      
      <!-- VISTA: Report Costi (invariata) -->
      <div id="view-costi" class="hidden">
        <!-- ... (codice report costi invariato) ... -->
      </div>
      
    </main>

  </div>

  <!-- ================== Modale Form Aggiungi Prodotto ================== -->
  <div id="form-modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-40 hidden">
    
    <!-- Contenuto Modale -->
    <div class="bg-white p-4 md:p-6 rounded-lg shadow-md w-full max-w-4xl relative max-h-[90vh] overflow-y-auto dark:bg-gray-800">
      
      <!-- Pulsante Chiudi Modale -->
      <button id="close-form-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-gray-600 z-10 dark:hover:text-gray-200">
        <!-- ... (icona X invariata) ... -->
      </button>

      <!-- Form Aggiungi Prodotto (spostato qui) -->
      <h2 class="text-xl md:text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Aggiungi Nuovo Prodotto</h2>
      
      <!-- MODIFICA: Aggiunto campo "Stato" e rimosso "required" da Costo -->
      <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Colonna 1 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Nome Prodotto</label>
          <input type="text" name="nome" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Categoria</label>
          <input type="text" name="categoria" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <!-- Colonna 2 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Fornitore</label>
          <input type="text" name="fornitore" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <!-- Etichetta Costo (non più required) -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Costo per Unità (€)</label>
          <input type="number" name="costoUnita" min="0" step="0.01" placeholder="0.00" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
        </div>
        <!-- Colonna 3 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Q.tà Attuale</label>
          <input type="number" name="quantitaAttuale" min="0" step="1" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Q.tà Minima</label>
          <input type="number" name="quantitaMinima" min="0" step="1" class="border rounded-md p-2 w-full shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>
        </div>
        <!-- Colonna 4 -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Unità</label>
          <select name="unita" class="border rounded-md p-2 w-full bg-white shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
            <option value="kg">kg</option>
            <option value="gr">gr</option>
            <option value="pz" selected>pz</option>
            <option value="ct">ct</option>
          </select>
        </div>
        
        <!-- NUOVO CAMPO: Stato -->
        <div class="flex flex-col">
          <label class="mb-1 font-medium text-gray-600 text-sm dark:text-gray-300">Stato</label>
          <select name="status" class="border rounded-md p-2 w-full bg-white shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
            <option value="disponibile" selected>Disponibile</option>
            <option value="non_necessario">Non Necessario</option>
            <option value="aperto">Confezione Aperta</option>
          </select>
        </div>
        
        <!-- MODIFICA: Pulsante spostato su una riga intera -->
        <button type="submit" class="w-full md:col-span-2 lg:col-span-4 bg-blue-600 text-white rounded-md p-2.5 font-semibold shadow-md hover:bg-blue-700 transition-all duration-200 h-full self-end mt-4">
          Aggiungi Prodotto
        </button>
      </form>
    </div>
  </div>

  <!-- Pulsante "+" Fluttuante (invariato) -->
  <button id="show-add-form-btn" class="fixed bottom-6 right-6 ...">
    <!-- ... (icona + invariata) ... -->
  </button>


  <!-- ================== SCRIPT APP (versione FIREBASE) ================== -->
  
  <!-- 1. Importa i moduli di Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, 
      onSnapshot, collection, query, where, getDocs, setLogLevel
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { 
      getAuth, signInAnonymously 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    // --- Passaggio 1: Configurazione Firebase ---
    // QUESTA È LA TUA CONFIGURAZIONE (già inserita)
    const firebaseConfig = {
      apiKey: "AIzaSyDWS8urdhG9RdS62rihj0FBPV38aWUclGQ",
      authDomain: "inventario-a52a4.firebaseapp.com",
      projectId: "inventario-a52a4",
      storageBucket: "inventario-a52a4.firebasestorage.app",
      messagingSenderId: "531426475103",
      appId: "1:531426475103:web:9a3c9b74547fd19a0a6fea",
      measurementId: "G-8HSKSW2Q86"
    };

    // --- Passaggio 2: ID Gruppo Condiviso ---
    const GRUPPO_ID = "inventario-segreto-123";

    // --- STATO LOCALE E COSTANTI ---
    const THEME_KEY = 'inventarioAppTheme';
    const state = {
      // (stato invariato)
      currentView: 'home', 
      groupBy: 'categoria',
      inventoryViewMode: 'compatta',
      products: [],
      db: null,
      auth: null,
      collectionRef: null 
    };
    
    const unitOptions = ['kg', 'gr', 'pz', 'ct'];
    
    // NUOVO: Definizioni per lo stato
    const statusOptions = {
      'disponibile': 'Disponibile',
      'non_necessario': 'Non Necessario',
      'aperto': 'Confezione Aperta'
    };

    // --- SELETTORI DOM (Invariati) ---
    const $ = (selector) => document.querySelector(selector);
    // (tutti i selettori invariati)
    const loadingOverlay = $('#loading-overlay');

    // --- FUNZIONI DI LOGICA (Modificate per Firebase) ---

    /** Raggruppa i prodotti (invariato) */
    function getGroupedProducts() {
      // ... (codice invariato)
      const groupKey = state.groupBy;
      const grouped = state.products.reduce((acc, prodotto) => {
        const key = prodotto[groupKey] || 'Non Assegnato';
        if (!acc.has(key)) {
          acc.set(key, []);
        }
        acc.get(key).push(prodotto);
        return acc;
      }, new Map());
      
      return new Map([...grouped.entries()].sort((a, b) => a[0].localeCompare(b[0])));
    }

    /** Filtra e raggruppa lista spesa (invariato) */
    function getShoppingListGrouped() {
      // ... (codice invariato)
      const prodottiDaAcquistare = state.products.filter(
        p => p.quantitaAttuale <= p.quantitaMinima
      );
      const grouped = prodottiDaAcquistare.reduce((acc, prodotto) => {
        const key = prodotto.fornitore || 'Sconosciuto';
        if (!acc.has(key)) {
          acc.set(key, []);
        }
        acc.get(key).push(prodotto);
        return acc;
      }, new Map());
      
      return new Map([...grouped.entries()].sort((a, b) => a[0].localeCompare(b[0])));
    }

    /** Aggiunge un nuovo prodotto a Firebase */
    async function aggiungiProdotto(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const newProduct = {};
      
      for (let [key, value] of formData.entries()) {
        if (key === 'costoUnita' || key === 'quantitaAttuale' || key === 'quantitaMinima') {
          // MODIFICA: gestisce il costo vuoto
          newProduct[key] = parseFloat(value) || 0; 
        } else {
          newProduct[key] = value;
        }
      }
      
      // Assicura che lo stato sia impostato (anche se il form-data è strano)
      if (!newProduct.status) {
        newProduct.status = 'disponibile';
      }
      
      try {
        await addDoc(state.collectionRef, newProduct);
        e.target.reset();
        formModalOverlay.classList.add('hidden');
      } catch (err) {
        console.error("Errore aggiungendo prodotto: ", err);
        alert("Errore nell'aggiunta del prodotto.");
      }
    }

    /** Rimuove un prodotto da Firebase (invariato) */
    async function rimuoviProdotto(id) {
      // ... (codice invariato)
      try {
        const docRef = doc(state.db, `inventario/${GRUPPO_ID}/prodotti`, id);
        await deleteDoc(docRef);
      } catch (err) {
        console.error("Errore rimuovendo prodotto: ", err);
        alert("Errore nella rimozione del prodotto.");
      }
    }

    /** Aggiorna un campo del prodotto su Firebase (invariato) */
    async function updateProductField(id, field, value) {
      // ... (codice invariato)
      const product = state.products.find(p => p.id === id);
      if (!product) return;
      
      let parsedValue = value;
      if (field === 'costoUnita' || field === 'quantitaAttuale' || field === 'quantitaMinima') {
        parsedValue = parseFloat(value) || 0;
      }
      
      if (product[field] === parsedValue) {
        return;
      }

      try {
        const docRef = doc(state.db, `inventario/${GRUPPO_ID}/prodotti`, id);
        await updateDoc(docRef, {
          [field]: parsedValue
        });
      } catch (err) {
        console.error("Errore aggiornando prodotto: ", err);
        alert("Errore nell'aggiornamento del prodotto.");
      }
    }
    
    /** Aggiorna la quantità con +1 o -1 su Firebase (invariato) */
    async function updateProductQuantity(id, change) {
      // ... (codice invariato)
      const product = state.products.find(p => p.id === id);
      if (!product) return;
      
      let currentQuantity = parseFloat(product.quantitaAttuale) || 0;
      let newQuantity = currentQuantity + change;
      
      if (newQuantity < 0) {
        newQuantity = 0;
      }

      if (product.quantitaAttuale === newQuantity) {
        return;
      }

      try {
        const docRef = doc(state.db, `inventario/${GRUPPO_ID}/prodotti`, id);
        await updateDoc(docRef, {
          quantitaAttuale: newQuantity
        });
      } catch (err) {
        console.error("Errore aggiornando quantità: ", err);
        alert("Errore nell'aggiornamento della quantità.");
      }
    }
    
    /** Copia la lista spesa negli appunti (invariato) */
    function copiaListaSpesa() {
        // ... (codice invariato)
    }

    // --- FUNZIONI DI RENDER (Aggiornate) ---

    function render() {
      // ... (codice invariato)
    }

    /** Aggiorna la navigazione (invariato) */
    function renderNav() {
      // ... (codice invariato)
    }

    /** Mostra solo la vista corrente (invariato) */
    function renderViews() {
      // ... (codice invariato)
    }
    
    /** Helper per le opzioni Unità (invariato) */
    function getUnitOptionsHTML(selectedValue) {
      return unitOptions.map(unita => 
        `<option value="${unita}" ${unita === selectedValue ? 'selected' : ''}>${unita}</option>`
      ).join('');
    }
    
    /** NUOVO: Helper per le opzioni Stato */
    function getStatusOptionsHTML(selectedValue) {
      // Assicura un default se il valore è nullo/undefined
      const value = selectedValue || 'disponibile';
      return Object.entries(statusOptions).map(([key, label]) =>
        `<option value="${key}" ${key === value ? 'selected' : ''}>${label}</option>`
      ).join('');
    }
    
    /** NUOVO: Helper per il badge Stato */
    function getStatusBadge(status) {
      switch (status) {
        case 'aperto':
          return `<span class="flex-shrink-0 text-xs font-medium bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full dark:bg-yellow-900 dark:text-yellow-300">Aperto</span>`;
        case 'non_necessario':
          return `<span class="flex-shrink-0 text-xs font-medium bg-gray-100 text-gray-800 px-2 py-0.5 rounded-full dark:bg-gray-700 dark:text-gray-300">Non Necessario</span>`;
        case 'disponibile':
        default:
          return ''; // Nessun badge per lo stato di default
      }
    }

    /** Render inventario */
    function renderInventoryList() {
      const grouped = getGroupedProducts();
      if (state.products.length === 0) {
        // ... (codice "Nessun prodotto" invariato)
        return;
      }
      
      let html = '';
      for (let [groupKey, prodotti] of grouped) {
        html += `<section>
          <h2 class="text-xl md:text-2xl font-bold text-gray-700 mt-6 mb-3 border-b-2 border-gray-300 pb-2 capitalize dark:text-gray-200 dark:border-gray-600">
            ${groupKey}
          </h2>
          <div class="grid grid-cols-1 ${state.inventoryViewMode === 'completa' ? 'xl:grid-cols-2' : ''} gap-4">
            ${prodotti.map(prodotto => {
              const borderClass = prodotto.quantitaAttuale <= prodotto.quantitaMinima ? 'border-l-4 border-red-500' : 'border-transparent dark:border-transparent';
              const qtyClass = prodotto.quantitaAttuale <= prodotto.quantitaMinima ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400';
              
              // MODIFICA: Aggiunto wrapper e badge per lo stato
              const cardTop = `
                <div class="flex justify-between items-start mb-3">
                  <div class="flex items-center gap-2 w-2/3">
                    <input type="text" value="${prodotto.nome}" data-id="${prodotto.id}" data-field="nome"
                      class="editable-input text-lg md:text-xl font-bold text-blue-800 border-b-2 border-transparent focus:border-blue-300 outline-none w-full dark:text-blue-400 dark:bg-transparent dark:focus:border-blue-500">
                    ${getStatusBadge(prodotto.status)}
                  </div>
                  <button class="remove-btn text-red-500 hover:text-red-700 font-semibold transition-colors text-sm flex-shrink-0 ml-2 dark:hover:text-red-400" data-id="${prodotto.id}">
                    Rimuovi
                  </button>
                </div>`;
                
              let cardBottom = '';
              
              if (state.inventoryViewMode === 'compatta') {
                // (Vista compatta invariata, con pulsanti +/- e Q.tà)
                cardBottom = `
                  <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mt-2 text-sm text-gray-600 dark:text-gray-400">
                    <div class="flex items-center space-x-2">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Q.tà:</label>
                      <button data-id="${prodotto.id}" class="qty-decrease bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 rounded-full w-6 h-6 flex items-center justify-center text-lg font-bold text-gray-700 dark:text-gray-200 hover:bg-gray-300 transition-colors">-</button>
                      <input type="number" value="${prodotto.quantitaAttuale}" data-id="${prodotto.id}" data-field="quantitaAttuale"
                        class="editable-input w-20 border rounded-md p-1 text-center font-medium ${qtyClass} dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                      <button data-id="${prodotto.id}" class="qty-increase bg-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 rounded-full w-6 h-6 flex items-center justify-center text-lg font-bold text-gray-700 dark:text-gray-200 hover:bg-gray-300 transition-colors">+</button>
                    </div>
                    <div class="flex items-center space-x-1">
                       <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Unità:</label>
                       <span class="font-medium dark:text-gray-300">${prodotto.unita}</span>
                    </div>
                    <div class="flex items-center space-x-1">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Min:</label>
                      <span class="font-medium dark:text-gray-300">${prodotto.quantitaMinima}</span>
                    </div>
                  </div>`;
              } else {
                // MODIFICA: Aggiunto campo "Stato" alla griglia
                cardBottom = `
                  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-3 text-sm text-gray-600 dark:text-gray-400">
                    <!-- Categoria -->
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Categoria</label>
                      <input type="text" value="${prodotto.categoria}" data-id="${prodotto.id}" data-field="categoria"
                        class="editable-input border-b border-transparent focus:border-gray-300 outline-none w-full dark:bg-transparent dark:focus:border-gray-500 dark:text-gray-100">
                    </div>
                    <!-- Fornitore -->
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Fornitore</label>
                      <input type="text" value="${prodotto.fornitore}" data-id="${prodotto.id}" data-field="fornitore"
                        class="editable-input border-b border-transparent focus:border-gray-300 outline-none w-full dark:bg-transparent dark:focus:border-gray-500 dark:text-gray-100">
                    </div>
                    <!-- Costo/Unità -->
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Costo/Unità</label>
                      <div class="flex items-center">
                        <span class="mr-1 dark:text-gray-400">€</span>
                        <input type="number" value="${prodotto.costoUnita || 0}" data-id="${prodotto.id}" data-field="costoUnita"
                          class="editable-input w-20 border-b border-transparent focus:border-gray-300 outline-none dark:bg-transparent dark:focus:border-gray-500 dark:text-gray-100">
                      </div>
                    </div>
                    <!-- Q.tà Attuale -->
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Q.tà Attuale</label>
                      <input type="number" value="${prodotto.quantitaAttuale}" data-id="${prodotto.id}" data-field="quantitaAttuale"
                        class="editable-input w-16 border-b border-transparent focus:border-gray-300 outline-none font-medium ${qtyClass} dark:bg-transparent dark:focus:border-gray-500">
                    </div>
                    <!-- Q.tà Minima -->
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Q.tà Minima</label>
                      <input type="number" value="${prodotto.quantitaMinima}" data-id="${prodotto.id}" data-field="quantitaMinima"
                        class="editable-input w-16 border-b border-transparent focus:border-gray-300 outline-none dark:bg-transparent dark:focus:border-gray-500 dark:text-gray-100">
                    </div>
                    <!-- Unità -->
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Unità</label>
                      <select data-id="${prodotto.id}" data-field="unita"
                        class="editable-input w-20 border-b bg-white border-transparent focus:border-gray-300 outline-none dark:bg-gray-800 dark:text-gray-100 dark:focus:border-gray-500">
                        ${getUnitOptionsHTML(prodotto.unita)}
                      </select>
                    </div>
                    <!-- NUOVO: Stato -->
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold text-gray-500 dark:text-gray-400">Stato</label>
                      <select data-id="${prodotto.id}" data-field="status"
                        class="editable-input w-full border-b bg-white border-transparent focus:border-gray-300 outline-none dark:bg-gray-800 dark:text-gray-100 dark:focus:border-gray-500">
                        ${getStatusOptionsHTML(prodotto.status)}
                      </select>
                    </div>
                  </div>`;
              }
              
              return `<div class="bg-white shadow-lg rounded-lg p-4 transition-all duration-300 ${borderClass} dark:bg-gray-800 dark:shadow-none">
                ${cardTop}
                ${cardBottom}
              </div>`;
              
            }).join('')}
          </div>
        </section>`;
      }
      inventoryListContainer.innerHTML = html;
    }

    /** Render lista spesa (invariato) */
    function renderShoppingList() {
      // ... (codice invariato)
    }
    
    /** Render per la pagina Costi (invariato) */
    function renderCosti() {
      // ... (codice invariato)
    }
    
    /** Formatta valuta (invariato) */
    function formatCurrency(value) {
      // ... (codice invariato)
    }
    
    /** Render badge notifiche (invariato) */
    function renderBadge() {
      // ... (codice invariato)
    }
    
    // --- FUNZIONI DARK MODE (Invariate) ---
    function applyTheme(theme) {
      // ... (codice invariato)
    }
    function initTheme() {
      // ... (codice invariato)
    }

    // --- EVENT LISTENERS (Invariati) ---
    // (Tutti gli event listener sono invariati)
    // ...

    // --- INIZIALIZZAZIONE FIREBASE ---
    
    async function initApp() {
      initTheme(); // Inizializza il tema subito

      try {
        const app = initializeApp(firebaseConfig);
        state.db = getFirestore(app);
        state.auth = getAuth(app);
        
        state.collectionRef = collection(state.db, `inventario/${GRUPPO_ID}/prodotti`);

        await signInAnonymously(state.auth);
        
        onSnapshot(state.collectionRef, (snapshot) => {
          state.products = [];
          snapshot.forEach((doc) => {
            state.products.push({ id: doc.id, ...doc.data() });
          });
          
          if (!loadingOverlay.classList.contains('hidden')) {
             loadingOverlay.classList.add('hidden');
          }
          
          render(); // Ridisegna tutto con i nuovi dati
        }, (error) => {
          console.error("Errore onSnapshot: ", error);
          loadingOverlay.innerHTML = `<span class="text-red-400 text-lg font-medium p-4 text-center">Errore di caricamento dati.<br>Controlla le Regole di Sicurezza di Firebase.</span>`;
        });

      } catch (err) {
        console.error("Errore inizializzazione Firebase: ", err);
        
        if (err.code === 'auth/configuration-not-found') {
           loadingOverlay.innerHTML = `<span class="text-red-400 text-lg font-medium p-4 text-center">
            <strong>ERRORE: Autenticazione Anonima NON ABILITATA.</strong><br><br>
            Azione richiesta:<br>
            1. Vai alla tua Console Firebase<br>
            2. Clicca su "Authentication"<br>
            3. Vai alla scheda "Sign-in method"<br>
            4. Clicca su "Anonimo" e Abilitalo.
           </span>`;
        } else {
           loadingOverlay.innerHTML = `<span class="text-red-400 text-lg font-medium p-4 text-center">Errore di connessione.<br>Controlla la configurazione di Firebase e le Regole di Sicurezza.</span>`;
        }
      }
    }
    
    // Avvia l'app
    initApp();

  </script>
</body>
</html>

